
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanremo - Eisproduktionsmanagement</title>
    <style>
        /* ===== VARIABLES & RESET ===== */
        :root {
            /* Colors */
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #16a34a;
            --success-dark: #15803d;
            --danger: #dc2626;
            --danger-dark: #b91c1c;
            --warning: #f59e0b;
            --warning-dark: #d97706;
            --muted: #6b7280;
            --light: #f9fafb;
            --dark: #1f2937;
            --border: #e5e7eb;
            --border-dark: #d1d5db;
            --card-bg: #ffffff;
            --body-bg: #f3f4f6;
            
            /* Spacing */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 18px;
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 40px rgba(0,0,0,0.1);
            
            /* Typography */
            --font-size-xs: 12px;
            --font-size-sm: 14px;
            --font-size-md: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 20px;
            --font-size-2xl: 24px;
            --font-size-3xl: 30px;
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 350ms ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            line-height: 1.5;
            overflow-x: hidden;
        }
        
        /* ===== LAYOUT ===== */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            background: var(--light);
            box-shadow: var(--shadow-xl);
        }
        
        /* ===== HEADER ===== */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: var(--space-md) var(--space-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .logo-icon {
            font-size: 28px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .logo-text {
            font-size: var(--font-size-xl);
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        
        .logo-subtitle {
            font-size: var(--font-size-sm);
            opacity: 0.9;
            font-weight: 500;
        }
        
        /* ===== MAIN NAVIGATION ===== */
        .main-nav {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.1);
            padding: var(--space-sm);
            border-radius: var(--radius-lg);
            backdrop-filter: blur(10px);
        }
        
        .nav-btn {
            padding: var(--space-sm) var(--space-md);
            background: transparent;
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 700;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            white-space: nowrap;
        }
        
        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow-md);
        }
        
        .nav-btn i {
            font-size: 18px;
        }
        
        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            padding: var(--space-lg);
            overflow-y: auto;
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
        }
        
        .view-container {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .view-container.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ===== DASHBOARD VIEW ===== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            transition: all var(--transition-normal);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: var(--space-md);
        }
        
        .stat-icon.order { background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%); color: white; }
        .stat-icon.production { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; }
        .stat-icon.recipe { background: linear-gradient(135deg, #34d399 0%, #10b981 100%); color: white; }
        .stat-icon.label { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); color: white; }
        
        .stat-value {
            font-size: var(--font-size-2xl);
            font-weight: 800;
            color: var(--dark);
            margin: var(--space-xs) 0;
        }
        
        .stat-label {
            color: var(--muted);
            font-size: var(--font-size-sm);
            font-weight: 600;
        }
        
        .stat-change {
            font-size: var(--font-size-xs);
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 20px;
            margin-top: var(--space-sm);
            display: inline-block;
        }
        
        .stat-change.positive { background: #dcfce7; color: #166534; }
        .stat-change.negative { background: #fee2e2; color: #991b1b; }
        
        /* ===== COMMON COMPONENTS ===== */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            margin-bottom: var(--space-lg);
        }
        
        .card-title {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--dark);
            margin-bottom: var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .card-title i {
            color: var(--primary);
        }
        
        .form-group {
            margin-bottom: var(--space-md);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--space-xs);
            font-weight: 600;
            color: var(--dark);
            font-size: var(--font-size-sm);
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: var(--font-size-md);
            transition: all var(--transition-fast);
            background: white;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            text-decoration: none;
        }
        
        .btn i {
            font-size: 16px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, var(--warning-dark) 100%);
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--border-dark);
            color: var(--dark);
        }
        
        .btn-outline:hover {
            background: var(--light);
            border-color: var(--primary);
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: var(--font-size-xs);
        }
        
        .btn-icon {
            padding: 8px;
            border-radius: var(--radius-sm);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .btn-icon:hover {
            background: var(--light);
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: var(--font-size-xs);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-primary {
            background: #dbeafe;
            color: var(--primary-dark);
        }
        
        .badge-success {
            background: #dcfce7;
            color: var(--success-dark);
        }
        
        .badge-warning {
            background: #fef3c7;
            color: var(--warning-dark);
        }
        
        .badge-danger {
            background: #fee2e2;
            color: var(--danger-dark);
        }
        
        .alert {
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
            display: flex;
            align-items: flex-start;
            gap: var(--space-sm);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .alert-success {
            background: #dcfce7;
            border: 1px solid #86efac;
            color: #166534;
        }
        
        .alert-warning {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            color: #92400e;
        }
        
        .alert-danger {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #991b1b;
        }
        
        .alert-info {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            color: #1e40af;
        }
        
        .alert-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .alert-content {
            flex: 1;
        }
        
        /* ===== INGREDIENTS SPECIFIC STYLES ===== */
        .allergen-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }
        
        .allergen-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: white;
            transition: all var(--transition-fast);
        }
        
        .allergen-item:hover {
            background: var(--light);
            transform: translateY(-2px);
        }
        
        .allergen-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .allergen-icon {
            font-size: 20px;
        }
        
        .allergen-name {
            font-weight: 600;
            font-size: var(--font-size-sm);
        }
        
        .allergen-code {
            font-size: var(--font-size-xs);
            color: var(--muted);
            font-family: monospace;
        }
        
        /* Style for highlighted allergens in ingredient lists */
        .allergen-highlight {
            background-color: #fee2e2 !important;
            color: #991b1b !important;
            font-weight: bold !important;
            padding: 2px 6px !important;
            border-radius: 4px !important;
        }
        
        /* E-Number specific styles */
        .e-number {
            background: #f3e8ff;
            color: #7c3aed;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: var(--font-size-xs);
            font-family: monospace;
            font-weight: 600;
        }
        
        .additive-class {
            background: #dcfce7;
            color: #166534;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: var(--font-size-xs);
            font-weight: 600;
        }
        
        /* AZO warning style */
        .azo-warning {
            background: linear-gradient(135deg, #fde68a 0%, #fbbf24 100%);
            border-left: 4px solid #d97706;
            color: #92400e;
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin: var(--space-md) 0;
        }
        
        /* Trace warning style */
        .trace-warning {
            background: #fef3c7;
            color: #92400e;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: var(--font-size-sm);
            border: 1px solid #fcd34d;
        }
        
        /* ===== NUTRITION CALCULATION STYLES ===== */
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }
        
        .nutrition-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            text-align: center;
        }
        
        .nutrition-value {
            font-size: var(--font-size-xl);
            font-weight: 800;
            color: var(--primary);
        }
        
        .nutrition-unit {
            font-size: var(--font-size-sm);
            color: var(--muted);
            font-weight: 600;
        }
        
        .nutrition-label {
            font-size: var(--font-size-xs);
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }
        
        /* ===== RECIPE INGREDIENT LIST ===== */
        .ingredient-list {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: var(--space-lg);
        }
        
        .ingredient-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: var(--space-md);
            padding: var(--space-md);
            border-bottom: 1px solid var(--border);
            align-items: center;
        }
        
        .ingredient-row:last-child {
            border-bottom: none;
        }
        
        .ingredient-row.header {
            background: var(--light);
            font-weight: 700;
            font-size: var(--font-size-sm);
        }
        
        /* ===== LABEL PREVIEW ===== */
        .label-preview-container {
            border: 2px dashed var(--border-dark);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            background: white;
            margin: var(--space-lg) 0;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .label-preview {
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            background: white;
            font-family: Arial, sans-serif;
            font-size: 11px;
            line-height: 1.4;
        }
        
        .label-title {
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
        }
        
        .allergen-bold {
            font-weight: bold !important;
            background-color: #ffebee !important;
            padding: 0 2px !important;
        }
        
        /* ===== TABLE STYLES ===== */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            margin-bottom: var(--space-lg);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        .table th {
            background: var(--light);
            padding: 12px 16px;
            text-align: left;
            font-weight: 700;
            font-size: var(--font-size-sm);
            color: var(--dark);
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
        }
        
        .table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-size: var(--font-size-sm);
        }
        
        .table tr:last-child td {
            border-bottom: none;
        }
        
        .table tr:hover {
            background: #f8fafc;
        }
        
        .table-actions {
            display: flex;
            gap: var(--space-xs);
        }
        
        /* ===== ORDER MANAGEMENT ===== */
        .order-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }
        
        .order-items-container {
            background: white;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .order-item {
            display: grid;
            grid-template-columns: 1fr 1fr 100px 60px;
            gap: var(--space-md);
            padding: var(--space-md);
            border-bottom: 1px solid var(--border);
            align-items: center;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-summary {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--light);
            border-radius: var(--radius-md);
            margin-top: var(--space-lg);
        }
        
        .summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--space-md);
            background: white;
            border-radius: var(--radius-md);
            min-width: 120px;
            box-shadow: var(--shadow-sm);
        }
        
        .summary-value {
            font-size: var(--font-size-2xl);
            font-weight: 800;
            color: var(--primary);
        }
        
        .summary-label {
            font-size: var(--font-size-xs);
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
        }
        
        /* ===== PRODUCTION VIEW ===== */
        .production-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }
        
        .production-tile {
            background: white;
            border-radius: var(--radius-md);
            padding: var(--space-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            transition: all var(--transition-fast);
        }
        
        .production-tile:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .production-value {
            font-size: var(--font-size-2xl);
            font-weight: 800;
            color: var(--dark);
            margin: var(--space-sm) 0;
        }
        
        .production-label {
            font-size: var(--font-size-sm);
            color: var(--muted);
            font-weight: 600;
        }
        
        /* ===== PRINT STYLES ===== */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .card {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
                page-break-inside: avoid;
            }
            
            /* Label specific print styles */
            .label-print {
                width: 90mm !important;
                height: 140mm !important;
                margin: 0 !important;
                padding: 10mm !important;
                border: 1px solid #000 !important;
                border-radius: 8px !important;
                font-family: Arial, sans-serif !important;
            }
        }
        
        /* ===== UTILITIES ===== */
        .d-flex { display: flex; }
        .d-none { display: none; }
        .flex-column { flex-direction: column; }
        .align-items-center { align-items: center; }
        .justify-content-between { justify-content: space-between; }
        .gap-1 { gap: var(--space-xs); }
        .gap-2 { gap: var(--space-sm); }
        .gap-3 { gap: var(--space-md); }
        .gap-4 { gap: var(--space-lg); }
        .mt-1 { margin-top: var(--space-xs); }
        .mt-2 { margin-top: var(--space-sm); }
        .mt-3 { margin-top: var(--space-md); }
        .mt-4 { margin-top: var(--space-lg); }
        .mb-1 { margin-bottom: var(--space-xs); }
        .mb-2 { margin-bottom: var(--space-sm); }
        .mb-3 { margin-bottom: var(--space-md); }
        .mb-4 { margin-bottom: var(--space-lg); }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: var(--muted); }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .text-primary { color: var(--primary); }
        .fw-bold { font-weight: 700; }
        .fw-bolder { font-weight: 800; }
        .fs-sm { font-size: var(--font-size-sm); }
        .fs-md { font-size: var(--font-size-md); }
        .fs-lg { font-size: var(--font-size-lg); }
        .w-100 { width: 100%; }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .app-container {
                border-radius: 0;
            }
            
            .app-header {
                flex-direction: column;
                gap: var(--space-md);
                padding: var(--space-md);
            }
            
            .main-nav {
                width: 100%;
                overflow-x: auto;
                padding: var(--space-sm);
            }
            
            .nav-btn {
                font-size: var(--font-size-xs);
                padding: 8px 12px;
            }
            
            .main-content {
                padding: var(--space-md);
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .production-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .order-form-grid {
                grid-template-columns: 1fr;
            }
            
            .order-item {
                grid-template-columns: 1fr;
                gap: var(--space-sm);
            }
            
            .ingredient-row {
                grid-template-columns: 1fr;
                gap: var(--space-sm);
            }
            
            .allergen-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .production-stats {
                grid-template-columns: 1fr;
            }
            
            .allergen-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-item {
                min-width: 100px;
            }
        }
    </style>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <header class="app-header no-print">
            <div class="logo">
                <div class="logo-icon">üç®</div>
                <div>
                    <div class="logo-text">Sanremo Eisproduktion</div>
                    <div class="logo-subtitle">Komplettes Produktionsmanagement</div>
                </div>
            </div>
            
            <nav class="main-nav">
                <button class="nav-btn active" data-view="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="nav-btn" data-view="ingredients">
                    <i class="fas fa-database"></i> Zutaten-DB
                </button>
                <button class="nav-btn" data-view="recipes">
                    <i class="fas fa-book"></i> Rezepte
                </button>
                <button class="nav-btn" data-view="orders">
                    <i class="fas fa-shopping-cart"></i> Bestellungen
                </button>
                <button class="nav-btn" data-view="production">
                    <i class="fas fa-industry"></i> Produktion
                </button>
                <button class="nav-btn" data-view="flavors">
                    <i class="fas fa-ice-cream"></i> Sorten
                </button>
                <button class="nav-btn" data-view="labels">
                    <i class="fas fa-tag"></i> Etiketten
                </button>
                <button class="nav-btn" data-view="customers">
                    <i class="fas fa-users"></i> Kunden
                </button>
                <button class="nav-btn" data-view="statistics">
                    <i class="fas fa-chart-bar"></i> Statistik
                </button>
                <button class="nav-btn" data-view="settings">
                    <i class="fas fa-cog"></i> Einstellungen
                </button>
            </nav>
        </header>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- DASHBOARD VIEW -->
            <section id="dashboard-view" class="view-container active">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-icon order">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-value" id="stat-today-orders">0</div>
                            <div class="stat-label">Heutige Bestellungen</div>
                            <div class="stat-change positive">+12%</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon production">
                                <i class="fas fa-industry"></i>
                            </div>
                            <div class="stat-value" id="stat-production-today">0 kg</div>
                            <div class="stat-label">Heutige Produktion</div>
                            <div class="stat-change positive">+8%</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon recipe">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="stat-value" id="stat-recipes">0</div>
                            <div class="stat-label">Aktive Rezepte</div>
                            <div class="stat-change negative">-2%</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon label">
                                <i class="fas fa-tag"></i>
                            </div>
                            <div class="stat-value" id="stat-labels-today">0</div>
                            <div class="stat-label">Etiketten heute</div>
                            <div class="stat-change positive">+15%</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <div class="alert-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="alert-content">
                            <strong>Willkommen!</strong> Heute haben Sie 3 offene Bestellungen und 45kg Produktion geplant. Das System speichert alle Daten lokal im Browser.
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-calendar-alt"></i> Heutige Aktivit√§ten
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Zeit</th>
                                    <th>Aktivit√§t</th>
                                    <th>Status</th>
                                    <th>Aktion</th>
                                </tr>
                            </thead>
                            <tbody id="today-activities">
                                <tr>
                                    <td>08:00</td>
                                    <td>Tagesproduktion starten</td>
                                    <td><span class="badge badge-warning">In Bearbeitung</span></td>
                                    <td><button class="btn btn-sm btn-outline">Fortsetzen</button></td>
                                </tr>
                                <tr>
                                    <td>09:30</td>
                                    <td>Lieferung an REWE</td>
                                    <td><span class="badge badge-success">Erledigt</span></td>
                                    <td><button class="btn btn-sm btn-outline">Details</button></td>
                                </tr>
                                <tr>
                                    <td>11:00</td>
                                    <td>Neue Bestellung: EDEKA</td>
                                    <td><span class="badge badge-primary">Ausstehend</span></td>
                                    <td><button class="btn btn-sm btn-outline">Bearbeiten</button></td>
                                </tr>
                                <tr>
                                    <td>14:00</td>
                                    <td>Qualit√§tskontrolle</td>
                                    <td><span class="badge badge-primary">Geplant</span></td>
                                    <td><button class="btn btn-sm btn-outline">Planen</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- INGREDIENTS DATABASE VIEW -->
            <section id="ingredients-view" class="view-container">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-database"></i> Zutaten-Datenbank
                    </div>
                    
                    <div class="alert alert-info">
                        <div class="alert-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="alert-content">
                            <strong>Information:</strong> Hier k√∂nnen Sie alle Zutaten mit Allergenen, Zusatzstoffen und N√§hrwerten verwalten.
                        </div>
                    </div>
                    
                    <div class="d-flex gap-3 mb-4">
                        <button class="btn btn-primary" id="new-ingredient-btn">
                            <i class="fas fa-plus"></i> Neue Zutat
                        </button>
                        <button class="btn btn-outline" id="import-ingredients-btn">
                            <i class="fas fa-file-import"></i> Importieren
                        </button>
                        <button class="btn btn-outline" id="export-ingredients-btn">
                            <i class="fas fa-file-export"></i> Exportieren
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Zutat</th>
                                    <th>Allergene</th>
                                    <th>Zusatzstoffe</th>
                                    <th>N√§hrwerte/100g</th>
                                    <th>Spuren</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="ingredients-table">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- INGREDIENT FORM (Hidden by default) -->
                <div class="card" id="ingredient-form-container" style="display: none;">
                    <div class="card-title">
                        <i class="fas fa-edit"></i> Zutat bearbeiten
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Name der Zutat *</label>
                        <input type="text" class="form-input" id="ingredient-name" 
                               placeholder="z.B. Vollmilch, Zucker, Eigelb..." required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Kategorie</label>
                        <select class="form-select" id="ingredient-category">
                            <option value="milchprodukt">Milchprodukt</option>
                            <option value="zucker">Zucker/S√º√üungsmittel</option>
                            <option value="eiprodukt">Eiprodukt</option>
                            <option value="frucht">Frucht/Fruchtzubereitung</option>
                            <option value="nuss">Nuss/Samen</option>
                            <option value="farbstoff">Farbstoff</option>
                            <option value="emulgator">Emulgator</option>
                            <option value="stabilisator">Stabilisator</option>
                            <option value="aroma">Aroma</option>
                            <option value="sonstiges">Sonstiges</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Beschreibung</label>
                        <textarea class="form-textarea" id="ingredient-description" 
                                  placeholder="Kurze Beschreibung der Zutat..."></textarea>
                    </div>
                    
                    <!-- ALLERGENE SECTION -->
                    <div class="card-title mt-4">
                        <i class="fas fa-exclamation-triangle"></i> Allergene (14 gem√§√ü EU-Verordnung)
                    </div>
                    
                    <div class="allergen-grid" id="allergens-checkbox-grid">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <div class="form-group mt-3">
                        <label class="form-label">Kann Spuren enthalten</label>
                        <textarea class="form-textarea" id="ingredient-traces" 
                                  placeholder="M√∂gliche Spuren von... (z.B. 'Kann Spuren von N√ºssen enthalten')"></textarea>
                    </div>
                    
                    <!-- ZUSATZSTOFFE SECTION -->
                    <div class="card-title mt-4">
                        <i class="fas fa-flask"></i> Zusatzstoffe / E-Nummern
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">E-Nummern</label>
                        <input type="text" class="form-input" id="ingredient-enumbers" 
                               placeholder="z.B. E100, E322, E412 (kommagetrennt)">
                        <small class="text-muted">Kommagetrennte Liste von E-Nummern</small>
                    </div>
                    
                    <div id="azo-warning-container" class="azo-warning" style="display: none;">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>AZO-Farbstoff Warnhinweis erforderlich!</strong>
                        </div>
                        <div id="azo-warning-text" class="mt-2"></div>
                    </div>
                    
                    <!-- N√ÑHRWERTE SECTION -->
                    <div class="card-title mt-4">
                        <i class="fas fa-chart-pie"></i> N√§hrwerte pro 100g
                    </div>
                    
                    <div class="order-form-grid">
                        <div class="form-group">
                            <label class="form-label">Energie (kJ)</label>
                            <input type="number" class="form-input" id="nutrition-energy-kj" 
                                   step="0.1" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Energie (kcal)</label>
                            <input type="number" class="form-input" id="nutrition-energy-kcal" 
                                   step="0.1" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fett (g)</label>
                            <input type="number" class="form-input" id="nutrition-fat" 
                                   step="0.01" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">- davon ges√§ttigte Fetts√§uren (g)</label>
                            <input type="number" class="form-input" id="nutrition-saturated-fat" 
                                   step="0.01" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Kohlenhydrate (g)</label>
                            <input type="number" class="form-input" id="nutrition-carbs" 
                                   step="0.01" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">- davon Zucker (g)</label>
                            <input type="number" class="form-input" id="nutrition-sugar" 
                                   step="0.01" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Eiwei√ü (g)</label>
                            <input type="number" class="form-input" id="nutrition-protein" 
                                   step="0.01" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Salz (g)</label>
                            <input type="number" class="form-input" id="nutrition-salt" 
                                   step="0.01" min="0" value="0">
                        </div>
                    </div>
                    
                    <div class="d-flex gap-3 mt-4">
                        <button class="btn btn-success" id="save-ingredient-btn">
                            <i class="fas fa-save"></i> Zutat speichern
                        </button>
                        <button class="btn btn-outline" id="cancel-ingredient-btn">
                            <i class="fas fa-times"></i> Abbrechen
                        </button>
                        <button class="btn btn-outline" id="calculate-nutrition-btn">
                            <i class="fas fa-calculator"></i> N√§hrwerte berechnen
                        </button>
                    </div>
                </div>
            </section>

            <!-- RECIPES VIEW -->
            <section id="recipes-view" class="view-container">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-book"></i> Rezeptverwaltung
                    </div>
                    
                    <div class="alert alert-info">
                        <div class="alert-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="alert-content">
                            <strong>Automatische Berechnung:</strong> Die N√§hrwerte werden automatisch aus den Zutaten berechnet. Allergene werden automatisch erkannt.
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Sorte ausw√§hlen oder neue erstellen</label>
                        <div class="d-flex gap-3">
                            <select class="form-select" id="recipe-flavor">
                                <option value="">Sorte ausw√§hlen...</option>
                                <option value="vanille">Vanille</option>
                                <option value="schokolade">Schokolade</option>
                                <option value="erdbeer">Erdbeer</option>
                                <option value="stracciatella">Stracciatella</option>
                            </select>
                            <button class="btn btn-primary" id="new-recipe-btn">
                                <i class="fas fa-plus"></i> Neues Rezept
                            </button>
                        </div>
                    </div>
                    
                    <!-- RECIPE FORM (Hidden by default) -->
                    <div id="recipe-form-container" style="display: none;">
                        <div class="card mt-4">
                            <div class="card-title">
                                <i class="fas fa-edit"></i> Rezept bearbeiten: <span id="recipe-flavor-name"></span>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Rezeptname *</label>
                                <input type="text" class="form-input" id="recipe-name" 
                                       placeholder="z.B. 'Klassische Vanille'" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Ausbeute (Gesamtmenge in Gramm)</label>
                                <input type="number" class="form-input" id="recipe-yield" 
                                       value="1000" min="100" step="10">
                                <small class="text-muted">Die Gesamtmenge der Mischung in Gramm</small>
                            </div>
                            
                            <!-- INGREDIENTS LIST -->
                            <div class="card-title mt-4">
                                <i class="fas fa-list"></i> Zutatenliste
                            </div>
                            
                            <div class="ingredient-list">
                                <div class="ingredient-row header">
                                    <div>Zutat</div>
                                    <div>Menge (g)</div>
                                    <div>Anteil (%)</div>
                                    <div>Aktion</div>
                                </div>
                                <div id="recipe-ingredients-list">
                                    <!-- Dynamic content -->
                                </div>
                            </div>
                            
                            <div class="d-flex gap-3 mt-3">
                                <button class="btn btn-outline" id="add-ingredient-to-recipe">
                                    <i class="fas fa-plus"></i> Zutat hinzuf√ºgen
                                </button>
                                <button class="btn btn-outline" id="auto-calculate-recipe">
                                    <i class="fas fa-calculator"></i> Mengen berechnen
                                </button>
                            </div>
                            
                            <!-- ALLERGENE AUTOMATIC DETECTION -->
                            <div class="card-title mt-4">
                                <i class="fas fa-exclamation-triangle"></i> Erkannte Allergene
                            </div>
                            <div id="recipe-allergens-list" class="allergen-grid mb-3">
                                <!-- Dynamic content -->
                            </div>
                            
                            <!-- TRACES WARNING -->
                            <div id="recipe-traces-warning" class="trace-warning" style="display: none;">
                                <i class="fas fa-info-circle"></i> 
                                <span id="recipe-traces-text"></span>
                            </div>
                            
                            <!-- AZO WARNING -->
                            <div id="recipe-azo-warning" class="azo-warning" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Warnung:</strong> Dieses Produkt enth√§lt einen oder mehrere Azofarbstoffe.
                                <div id="recipe-azo-details" class="mt-2"></div>
                            </div>
                            
                            <!-- CALCULATED NUTRITION -->
                            <div class="card-title mt-4">
                                <i class="fas fa-chart-pie"></i> Berechnete N√§hrwerte pro 100g
                            </div>
                            <div class="nutrition-grid" id="calculated-nutrition">
                                <!-- Dynamic content -->
                            </div>
                            
                            <div class="d-flex gap-3 mt-4">
                                <button class="btn btn-success" id="save-recipe-btn">
                                    <i class="fas fa-save"></i> Rezept speichern
                                </button>
                                <button class="btn btn-outline" id="cancel-recipe-btn">
                                    <i class="fas fa-times"></i> Abbrechen
                                </button>
                                <button class="btn btn-primary" id="preview-label-btn">
                                    <i class="fas fa-eye"></i> Etiketten-Vorschau
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RECIPES LIST -->
                    <div class="card mt-4" id="recipes-list-container">
                        <div class="card-title">
                            <i class="fas fa-list-ul"></i> Alle Rezepte
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Rezept</th>
                                        <th>Sorte</th>
                                        <th>Allergene</th>
                                        <th>N√§hrwerte/100g</th>
                                        <th>Erstellt</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody id="recipes-table">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ORDERS VIEW -->
            <section id="orders-view" class="view-container">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-shopping-cart"></i> Bestellverwaltung
                    </div>
                    
                    <div class="order-form-grid">
                        <div class="form-group">
                            <label class="form-label">Kunde</label>
                            <select class="form-select" id="order-customer">
                                <option value="">Kunde ausw√§hlen...</option>
                                <option value="rewe">REWE</option>
                                <option value="edeka">EDEKA</option>
                                <option value="lidl">LIDL</option>
                                <option value="aldi">ALDI</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Lieferdatum</label>
                            <input type="date" class="form-input" id="order-date" 
                                   value="<?php echo date('Y-m-d'); ?>">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Priorit√§t</label>
                            <select class="form-select" id="order-priority">
                                <option value="normal">Normal</option>
                                <option value="high">Hoch</option>
                                <option value="urgent">Dringend</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notizen</label>
                        <textarea class="form-textarea" id="order-notes" 
                                  placeholder="Besondere Anweisungen..."></textarea>
                    </div>
                    
                    <div class="d-flex gap-3 mb-4">
                        <button class="btn btn-primary" id="add-order-item-btn">
                            <i class="fas fa-plus"></i> Position hinzuf√ºgen
                        </button>
                        <button class="btn btn-outline" id="clear-order-btn">
                            <i class="fas fa-trash"></i> Leeren
                        </button>
                    </div>
                    
                    <div class="order-items-container mb-3">
                        <div class="order-item fw-bold" style="background: var(--light);">
                            <div>Sorte</div>
                            <div>Gr√∂√üe</div>
                            <div>Menge</div>
                            <div>Aktion</div>
                        </div>
                        <div id="order-items-list">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                    
                    <div class="order-summary">
                        <div class="summary-item">
                            <div class="summary-value" id="total-items">0</div>
                            <div class="summary-label">Positionen</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="total-750g">0</div>
                            <div class="summary-label">750g</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="total-170g">0</div>
                            <div class="summary-label">170g</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="total-kg">0.0</div>
                            <div class="summary-label">KG</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="total-buckets">0</div>
                            <div class="summary-label">Eimer (6kg)</div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-3 mt-4">
                        <button class="btn btn-success" id="save-order-btn">
                            <i class="fas fa-save"></i> Bestellung speichern
                        </button>
                        <button class="btn btn-primary" id="print-order-btn">
                            <i class="fas fa-print"></i> Drucken
                        </button>
                        <button class="btn btn-warning" id="export-order-btn">
                            <i class="fas fa-file-export"></i> Exportieren
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-history"></i> Letzte Bestellungen
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Kunde</th>
                                    <th>Menge</th>
                                    <th>Status</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="recent-orders">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- PRODUCTION VIEW -->
            <section id="production-view" class="view-container">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-industry"></i> Produktionsplanung
                    </div>
                    
                    <div class="production-stats">
                        <div class="production-tile">
                            <div class="production-label">Heutige Produktion</div>
                            <div class="production-value" id="prod-today-kg">0 kg</div>
                            <div class="badge badge-success">Geplant</div>
                        </div>
                        
                        <div class="production-tile">
                            <div class="production-label">Eimer ben√∂tigt</div>
                            <div class="production-value" id="prod-buckets-needed">0</div>
                            <div class="badge badge-primary">6kg/Eimer</div>
                        </div>
                        
                        <div class="production-tile">
                            <div class="production-label">Fertiggestellt</div>
                            <div class="production-value" id="prod-completed">0%</div>
                            <div class="badge badge-success">Fortschritt</div>
                        </div>
                        
                        <div class="production-tile">
                            <div class="production-label">Offene Bestellungen</div>
                            <div class="production-value" id="prod-open-orders">0</div>
                            <div class="badge badge-warning">Zu bearbeiten</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Datum f√ºr Produktionsplan</label>
                        <input type="date" class="form-input" id="production-date" 
                               value="<?php echo date('Y-m-d'); ?>">
                    </div>
                    
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Sorte</th>
                                    <th>750g</th>
                                    <th>170g</th>
                                    <th>KG</th>
                                    <th>Eimer</th>
                                    <th>Status</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="production-plan">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="d-flex gap-3">
                        <button class="btn btn-primary" id="generate-production-plan-btn">
                            <i class="fas fa-calculator"></i> Plan generieren
                        </button>
                        <button class="btn btn-success" id="start-production-btn">
                            <i class="fas fa-play"></i> Produktion starten
                        </button>
                        <button class="btn btn-primary" id="print-production-plan-btn">
                            <i class="fas fa-print"></i> Plan drucken
                        </button>
                    </div>
                    
                    <!-- PRODUCTION XL MODE -->
                    <div class="card mt-4">
                        <div class="card-title">
                            <i class="fas fa-expand-alt"></i> Modo Produ√ß√£o XL
                        </div>
                        <div class="alert alert-warning">
                            <div class="alert-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="alert-content">
                                <strong>Luvas necess√°rias:</strong> Sim<br>
                                <strong>Baldes de 6kg:</strong> Dispon√≠vel por sabor<br>
                                <strong>Produ√ß√£o em massa:</strong> Ativado
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- FLAVORS VIEW -->
            <section id="flavors-view" class="view-container">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-ice-cream"></i> Sortenverwaltung
                    </div>
                    
                    <div class="order-form-grid">
                        <div class="form-group">
                            <label class="form-label">Neue Sorte</label>
                            <input type="text" class="form-input" id="new-flavor-name" 
                                   placeholder="z.B. Haselnuss, Zitrone, Toffifee...">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Kategorie</label>
                            <select class="form-select" id="new-flavor-category">
                                <option value="milcheis">Milcheis</option>
                                <option value="sorbet">Sorbet</option>
                                <option value="fruchteis">Fruchteis</option>
                                <option value="speiseeis">Speiseeis</option>
                                <option value="spezial">Spezial</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Beschreibung (optional)</label>
                        <textarea class="form-textarea" id="new-flavor-description" 
                                  placeholder="Kurze Beschreibung der Sorte..."></textarea>
                    </div>
                    
                    <div class="d-flex gap-3 mb-4">
                        <button class="btn btn-success" id="add-flavor-btn">
                            <i class="fas fa-plus"></i> Sorte hinzuf√ºgen
                        </button>
                        <button class="btn btn-outline" id="reset-flavors-btn">
                            <i class="fas fa-undo"></i> Standard-Sorten
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Sorte</th>
                                    <th>Kategorie</th>
                                    <th>Beschreibung</th>
                                    <th>Status</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="flavors-list">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- LABELS VIEW -->
            <section id="labels-view" class="view-container">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-tag"></i> Etiketten-Generator (LMIV-konform)
                    </div>
                    
                    <div class="alert alert-info">
                        <div class="alert-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="alert-content">
                            <strong>LMIV-konforme Etiketten:</strong> Das System generiert automatisch korrekte Etiketten gem√§√ü Lebensmittel-Informationsverordnung.
                        </div>
                    </div>
                    
                    <div class="order-form-grid">
                        <div class="form-group">
                            <label class="form-label">Sorte</label>
                            <select class="form-select" id="label-flavor">
                                <option value="">Sorte ausw√§hlen...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Packungsgr√∂√üe</label>
                            <select class="form-select" id="label-size">
                                <option value="170">170 g</option>
                                <option value="500">500 g</option>
                                <option value="750" selected>750 g</option>
                                <option value="1000">1000 g</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Chargen-Nummer</label>
                            <input type="text" class="form-input" id="label-batch" 
                                   placeholder="z.B. 2024-03-15-001" 
                                   value="<?php echo date('Y-m-d'); ?>-001">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">MHD (Mindesthaltbarkeitsdatum)</label>
                            <input type="date" class="form-input" id="label-expiry" 
                                   value="<?php echo date('Y-m-d', strtotime('+6 months')); ?>">
                        </div>
                    </div>
                    
                    <div id="label-warnings-container">
                        <!-- Dynamic warnings -->
                    </div>
                    
                    <div class="label-preview-container">
                        <div class="label-preview" id="label-preview-content">
                            <div class="label-title">MILCHEIS - VANILLE</div>
                            <div style="text-align: center; margin-bottom: 15px; color: #666;">
                                Nettof√ºllmenge: <strong>750 g</strong>
                            </div>
                            
                            <div style="margin-bottom: 12px;">
                                <strong>Zutaten:</strong> Vollmilch, Sahne, Zucker, Eigelb, nat√ºrliches Vanillearoma.
                            </div>
                            
                            <div style="margin-bottom: 12px;">
                                <strong>Allergene:</strong> <span class="allergen-bold">Milch</span>, <span class="allergen-bold">Ei</span>
                            </div>
                            
                            <div style="margin-bottom: 12px;">
                                <strong>N√§hrwerte je 100 g:</strong><br>
                                Energie: 850 kJ / 203 kcal<br>
                                Fett: 8,5 g (davon ges√§ttigte Fetts√§uren: 5,2 g)<br>
                                Kohlenhydrate: 25 g (davon Zucker: 22 g)<br>
                                Eiwei√ü: 3,8 g<br>
                                Salz: 0,12 g
                            </div>
                            
                            <div style="margin-bottom: 12px;">
                                <strong>MHD:</strong> <?php echo date('d.m.Y', strtotime('+6 months')); ?><br>
                                <strong>Charge:</strong> <?php echo date('Y-m-d'); ?>-001
                            </div>
                            
                            <div style="border-top: 1px solid #ccc; padding-top: 10px; margin-top: 15px; font-size: 10px; color: #666;">
                                <strong>Aufbewahrung:</strong> Bei -18¬∞C lagern. Nach dem Auftauen nicht wieder einfrieren.<br>
                                <div style="text-align: center; margin-top: 5px;">
                                    Eiscaf√© Sanremo ‚Ä¢ Bad Berleburg ‚Ä¢ Tel: 0176 72809926
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-3 mt-4">
                        <button class="btn btn-primary" id="generate-label-btn">
                            <i class="fas fa-sync"></i> Vorschau aktualisieren
                        </button>
                        <button class="btn btn-primary" id="print-label-btn">
                            <i class="fas fa-print"></i> Etikett drucken
                        </button>
                        <button class="btn btn-warning" id="print-batch-btn">
                            <i class="fas fa-print"></i> Charge drucken (10x)
                        </button>
                        <button class="btn btn-outline" id="export-label-btn">
                            <i class="fas fa-download"></i> Als PDF exportieren
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-history"></i> Zuletzt gedruckte Etiketten
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Sorte</th>
                                    <th>Gr√∂√üe</th>
                                    <th>Charge</th>
                                    <th>Menge</th>
                                    <th>Aktion</th>
                                </tr>
                            </thead>
                            <tbody id="recent-labels">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- OTHER VIEWS (Customers, Statistics, Settings) -->
            <!-- ... (Keep your existing code for these views) ... -->

        </main>

        <!-- FOOTER -->
        <footer class="app-footer no-print" style="padding: var(--space-md); background: var(--light); border-top: 1px solid var(--border); text-align: center; color: var(--muted); font-size: var(--font-size-sm);">
            <div class="d-flex justify-content-between align-items-center">
                <div>¬© 2024 Eiscaf√© Sanremo - Alle Rechte vorbehalten</div>
                <div>
                    <span id="current-time">--:--</span> | 
                    <span id="data-status" class="badge badge-success">Daten gespeichert</span>
                </div>
            </div>
        </footer>
    </div>

    <!-- MODAL FOR INGREDIENT SELECTION -->
    <div id="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
        <div id="modal-content" style="background: white; border-radius: var(--radius-lg); padding: var(--space-xl); max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <!-- Modal content will be injected here -->
        </div>
    </div>

    <script>
        // ===== DATABASE MANAGEMENT =====
        const DB = {
            VERSION: '2.0.0',
            KEYS: {
                ORDERS: 'sanremo_orders',
                CUSTOMERS: 'sanremo_customers',
                RECIPES: 'sanremo_recipes',
                FLAVORS: 'sanremo_flavors',
                INGREDIENTS: 'sanremo_ingredients',
                PRODUCTION: 'sanremo_production',
                SETTINGS: 'sanremo_settings',
                STATISTICS: 'sanremo_statistics',
                LABELS: 'sanremo_labels'
            },
            
            // Allergens according to EU legislation (14 main allergens)
            ALLERGENS: [
                { id: 'A1', code: 'A', name: 'Gluten', icon: 'üåæ', description: 'Getreide, Weizen, Roggen, Gerste, Hafer' },
                { id: 'A2', code: 'B', name: 'Krebstiere', icon: 'ü¶ê', description: 'Krebstiere und daraus gewonnene Erzeugnisse' },
                { id: 'A3', code: 'C', name: 'Eier', icon: 'ü•ö', description: 'Eier und daraus gewonnene Erzeugnisse' },
                { id: 'A4', code: 'D', name: 'Fisch', icon: 'üêü', description: 'Fisch und daraus gewonnene Erzeugnisse' },
                { id: 'A5', code: 'E', name: 'Erdn√ºsse', icon: 'ü•ú', description: 'Erdn√ºsse und daraus gewonnene Erzeugnisse' },
                { id: 'A6', code: 'F', name: 'Soja', icon: 'üå±', description: 'Soja und daraus gewonnene Erzeugnisse' },
                { id: 'A7', code: 'G', name: 'Milch', icon: 'ü•õ', description: 'Milch und daraus gewonnene Erzeugnisse' },
                { id: 'A8', code: 'H', name: 'Schalenfr√ºchte', icon: 'üå∞', description: 'Mandeln, Haseln√ºsse, Waln√ºsse, etc.' },
                { id: 'A9', code: 'I', name: 'Sellerie', icon: 'ü•¨', description: 'Sellerie und daraus gewonnene Erzeugnisse' },
                { id: 'A10', code: 'J', name: 'Senf', icon: 'üü°', description: 'Senf und daraus gewonnene Erzeugnisse' },
                { id: 'A11', code: 'K', name: 'Sesamsamen', icon: '‚ö´', description: 'Sesamsamen und daraus gewonnene Erzeugnisse' },
                { id: 'A12', code: 'L', name: 'Schwefeldioxid', icon: 'üß™', description: 'Schwefeldioxid und Sulfite' },
                { id: 'A13', code: 'M', name: 'Lupinen', icon: 'üåø', description: 'Lupinen und daraus gewonnene Erzeugnisse' },
                { id: 'A14', code: 'N', name: 'Weichtiere', icon: 'üêå', description: 'Weichtiere und daraus gewonnene Erzeugnisse' }
            ],
            
            // AZO dye warning codes
            AZO_DYES: [
                { code: 'E102', name: 'Tartrazin', warning: 'Kann Aktivit√§t und Aufmerksamkeit bei Kindern beeintr√§chtigen' },
                { code: 'E104', name: 'Chinolingelb', warning: 'Kann Aktivit√§t und Aufmerksamkeit bei Kindern beeintr√§chtigen' },
                { code: 'E110', name: 'Gelborange S', warning: 'Kann Aktivit√§t und Aufmerksamkeit bei Kindern beeintr√§chtigen' },
                { code: 'E122', name: 'Azorubin', warning: 'Kann Aktivit√§t und Aufmerksamkeit bei Kindern beeintr√§chtigen' },
                { code: 'E124', name: 'Cochenillerot A', warning: 'Kann Aktivit√§t und Aufmerksamkeit bei Kindern beeintr√§chtigen' },
                { code: 'E129', name: 'Allurarot AC', warning: 'Kann Aktivit√§t und Aufmerksamkeit bei Kindern beeintr√§chtigen' }
            ],
            
            // Common food additives classes
            ADDITIVE_CLASSES: [
                'Farbstoff', 'Konservierungsstoff', 'Antioxidationsmittel', 'Emulgator',
                'Stabilisator', 'Verdickungsmittel', 'Geliermittel', 'S√º√üungsmittel',
                'S√§uerungsmittel', 'S√§ureregulator', 'Trennmittel', 'Modifizierte St√§rke',
                'Geschmacksverst√§rker', 'Backtriebmittel', 'Feuchthaltemittel', '√úberzugsmittel'
            ],
            
            // Initialize all data
            init() {
                // Initialize empty databases if they don't exist
                if (!localStorage.getItem(this.KEYS.INGREDIENTS)) {
                    this.initDefaultIngredients();
                }
                
                if (!localStorage.getItem(this.KEYS.ORDERS)) {
                    localStorage.setItem(this.KEYS.ORDERS, JSON.stringify([]));
                }
                
                if (!localStorage.getItem(this.KEYS.CUSTOMERS)) {
                    localStorage.setItem(this.KEYS.CUSTOMERS, JSON.stringify([
                        {
                            id: '1',
                            name: 'REWE',
                            location: 'Bad Berleburg',
                            contact: 'Herr Schmidt',
                            phone: '02751 12345',
                            email: 'rewe@example.com',
                            type: 'supermarkt',
                            notes: 'Lieferung bis 09:00 Uhr',
                            created: new Date().toISOString()
                        },
                        {
                            id: '2',
                            name: 'EDEKA',
                            location: 'Bad Berleburg',
                            contact: 'Frau Meyer',
                            phone: '02751 67890',
                            email: 'edeka@example.com',
                            type: 'supermarkt',
                            notes: 'Hintereingang nutzen',
                            created: new Date().toISOString()
                        }
                    ]));
                }
                
                if (!localStorage.getItem(this.KEYS.RECIPES)) {
                    localStorage.setItem(this.KEYS.RECIPES, JSON.stringify([]));
                }
                
                if (!localStorage.getItem(this.KEYS.FLAVORS)) {
                    localStorage.setItem(this.KEYS.FLAVORS, JSON.stringify([
                        { id: '1', name: 'Vanille', category: 'milcheis', description: 'Klassische Vanille', active: true },
                        { id: '2', name: 'Schokolade', category: 'milcheis', description: 'Milcheis mit Schokolade', active: true },
                        { id: '3', name: 'Erdbeer', category: 'fruchteis', description: 'Frisches Erdbeereis', active: true },
                        { id: '4', name: 'Stracciatella', category: 'milcheis', description: 'Milcheis mit Schokost√ºckchen', active: true },
                        { id: '5', name: 'Zitrone', category: 'sorbet', description: 'Erfrischendes Zitronensorbet', active: true }
                    ]));
                }
                
                if (!localStorage.getItem(this.KEYS.PRODUCTION)) {
                    localStorage.setItem(this.KEYS.PRODUCTION, JSON.stringify([]));
                }
                
                if (!localStorage.getItem(this.KEYS.SETTINGS)) {
                    localStorage.setItem(this.KEYS.SETTINGS, JSON.stringify({
                        company_name: 'Eiscaf√© Sanremo',
                        company_address: 'Bad Berleburg',
                        company_phone: '0176 72809926',
                        sizes: [170, 500, 750, 1000],
                        bucket_size: 6,
                        default_expiry_days: 180,
                        theme: 'light',
                        language: 'de',
                        allergen_highlight: true,
                        auto_calculate: true,
                        azo_warning: true
                    }));
                }
                
                if (!localStorage.getItem(this.KEYS.STATISTICS)) {
                    localStorage.setItem(this.KEYS.STATISTICS, JSON.stringify([]));
                }
                
                if (!localStorage.getItem(this.KEYS.LABELS)) {
                    localStorage.setItem(this.KEYS.LABELS, JSON.stringify([]));
                }
            },
            
            // Initialize default ingredients database
            initDefaultIngredients() {
                const defaultIngredients = [
                    {
                        id: '1',
                        name: 'Vollmilch 3,5%',
                        category: 'milchprodukt',
                        description: 'Frische Vollmilch',
                        allergens: ['G'], // Milch
                        traces: 'Kann Spuren von Soja enthalten',
                        e_numbers: [],
                        nutrition: {
                            energy_kj: 264,
                            energy_kcal: 64,
                            fat: 3.5,
                            saturated_fat: 2.4,
                            carbs: 4.8,
                            sugar: 4.8,
                            protein: 3.3,
                            salt: 0.1
                        },
                        created: new Date().toISOString(),
                        updated: new Date().toISOString()
                    },
                    {
                        id: '2',
                        name: 'Sahne 30%',
                        category: 'milchprodukt',
                        description: 'Frische Sahne',
                        allergens: ['G'], // Milch
                        traces: '',
                        e_numbers: [],
                        nutrition: {
                            energy_kj: 1185,
                            energy_kcal: 287,
                            fat: 30,
                            saturated_fat: 20,
                            carbs: 3.2,
                            sugar: 3.2,
                            protein: 2.5,
                            salt: 0.1
                        },
                        created: new Date().toISOString(),
                        updated: new Date().toISOString()
                    },
                    {
                        id: '3',
                        name: 'Zucker',
                        category: 'zucker',
                        description: 'Raffinierter Zucker',
                        allergens: [],
                        traces: '',
                        e_numbers: [],
                        nutrition: {
                            energy_kj: 1700,
                            energy_kcal: 405,
                            fat: 0,
                            saturated_fat: 0,
                            carbs: 99.8,
                            sugar: 99.8,
                            protein: 0,
                            salt: 0.1
                        },
                        created: new Date().toISOString(),
                        updated: new Date().toISOString()
                    },
                    {
                        id: '4',
                        name: 'Eigelb',
                        category: 'eiprodukt',
                        description: 'Frisches Eigelb',
                        allergens: ['C'], // Eier
                        traces: '',
                        e_numbers: [],
                        nutrition: {
                            energy_kj: 1370,
                            energy_kcal: 330,
                            fat: 31.9,
                            saturated_fat: 9.6,
                            carbs: 0.3,
                            sugar: 0.3,
                            protein: 16.1,
                            salt: 0.1
                        },
                        created: new Date().toISOString(),
                        updated: new Date().toISOString()
                    },
                    {
                        id: '5',
                        name: 'Vanilleextrakt',
                        category: 'aroma',
                        description: 'Nat√ºrliches Vanillearoma',
                        allergens: [],
                        traces: '',
                        e_numbers: [],
                        nutrition: {
                            energy_kj: 280,
                            energy_kcal: 67,
                            fat: 0.1,
                            saturated_fat: 0,
                            carbs: 12.7,
                            sugar: 12.7,
                            protein: 0.1,
                            salt: 0.1
                        },
                        created: new Date().toISOString(),
                        updated: new Date().toISOString()
                    },
                    {
                        id: '6',
                        name: 'Kakaopulver',
                        category: 'sonstiges',
                        description: 'Ent√∂ltes Kakaopulver',
                        allergens: [],
                        traces: 'Kann Spuren von Milch, Soja und N√ºssen enthalten',
                        e_numbers: [],
                        nutrition: {
                            energy_kj: 1290,
                            energy_kcal: 308,
                            fat: 11,
                            saturated_fat: 6.8,
                            carbs: 34.7,
                            sugar: 1.5,
                            protein: 26.9,
                            salt: 0.1
                        },
                        created: new Date().toISOString(),
                        updated: new Date().toISOString()
                    },
                    {
                        id: '7',
                        name: 'Zitronensaft',
                        category: 'frucht',
                        description: 'Frisch gepresster Zitronensaft',
                        allergens: [],
                        traces: '',
                        e_numbers: [],
                        nutrition: {
                            energy_kj: 125,
                            energy_kcal: 30,
                            fat: 0.3,
                            saturated_fat: 0.1,
                            carbs: 6.9,
                            sugar: 2.5,
                            protein: 0.4,
                            salt: 0.1
                        },
                        created: new Date().toISOString(),
                        updated: new Date().toISOString()
                    },
                    {
                        id: '8',
                        name: 'Guarkernmehl',
                        category: 'stabilisator',
                        description: 'Pflanzliches Verdickungsmittel',
                        allergens: [],
                        traces: '',
                        e_numbers: ['E412'],
                        nutrition: {
                            energy_kj: 0,
                            energy_kcal: 0,
                            fat: 0,
                            saturated_fat: 0,
                            carbs: 0,
                            sugar: 0,
                            protein: 0,
                            salt: 0
                        },
                        created: new Date().toISOString(),
                        updated: new Date().toISOString()
                    },
                    {
                        id: '9',
                        name: 'Tartrazin',
                        category: 'farbstoff',
                        description: 'Gelber Azofarbstoff',
                        allergens: [],
                        traces: '',
                        e_numbers: ['E102'],
                        nutrition: {
                            energy_kj: 0,
                            energy_kcal: 0,
                            fat: 0,
                            saturated_fat: 0,
                            carbs: 0,
                            sugar: 0,
                            protein: 0,
                            salt: 0
                        },
                        created: new Date().toISOString(),
                        updated: new Date().toISOString()
                    }
                ];
                
                localStorage.setItem(this.KEYS.INGREDIENTS, JSON.stringify(defaultIngredients));
            },
            
            // Generic get method
            get(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : (key === this.KEYS.SETTINGS ? {} : []);
                } catch (e) {
                    console.error('Error reading from localStorage:', e);
                    return key === this.KEYS.SETTINGS ? {} : [];
                }
            },
            
            // Generic set method
            set(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (e) {
                    console.error('Error writing to localStorage:', e);
                    return false;
                }
            },
            
            // Get all ingredients
            getIngredients() {
                return this.get(this.KEYS.INGREDIENTS);
            },
            
            // Save an ingredient
            saveIngredient(ingredient) {
                const ingredients = this.getIngredients();
                
                if (ingredient.id) {
                    // Update existing ingredient
                    const index = ingredients.findIndex(i => i.id === ingredient.id);
                    if (index !== -1) {
                        ingredient.updated = new Date().toISOString();
                        ingredients[index] = ingredient;
                    }
                } else {
                    // Add new ingredient
                    ingredient.id = 'ingredient_' + Date.now();
                    ingredient.created = new Date().toISOString();
                    ingredient.updated = new Date().toISOString();
                    ingredients.push(ingredient);
                }
                
                return this.set(this.KEYS.INGREDIENTS, ingredients);
            },
            
            // Delete an ingredient
            deleteIngredient(id) {
                const ingredients = this.getIngredients();
                const filtered = ingredients.filter(i => i.id !== id);
                return this.set(this.KEYS.INGREDIENTS, filtered);
            },
            
            // Get all recipes
            getRecipes() {
                return this.get(this.KEYS.RECIPES);
            },
            
            // Save a recipe
            saveRecipe(recipe) {
                const recipes = this.getRecipes();
                
                if (recipe.id) {
                    // Update existing recipe
                    const index = recipes.findIndex(r => r.id === recipe.id);
                    if (index !== -1) {
                        recipe.updated = new Date().toISOString();
                        recipes[index] = recipe;
                    }
                } else {
                    // Add new recipe
                    recipe.id = 'recipe_' + Date.now();
                    recipe.created = new Date().toISOString();
                    recipe.updated = new Date().toISOString();
                    recipes.push(recipe);
                }
                
                return this.set(this.KEYS.RECIPES, recipes);
            },
            
            // Get all flavors
            getFlavors() {
                return this.get(this.KEYS.FLAVORS);
            },
            
            // Get settings
            getSettings() {
                return this.get(this.KEYS.SETTINGS);
            },
            
            // Save settings
            saveSettings(settings) {
                return this.set(this.KEYS.SETTINGS, settings);
            },
            
            // Get allergen name by code
            getAllergenName(code) {
                const allergen = this.ALLERGENS.find(a => a.code === code);
                return allergen ? allergen.name : 'Unbekannt';
            },
            
            // Get allergen icon by code
            getAllergenIcon(code) {
                const allergen = this.ALLERGENS.find(a => a.code === code);
                return allergen ? allergen.icon : '‚ùì';
            },
            
            // Check if E-number is an AZO dye
            isAzoDye(eNumber) {
                return this.AZO_DYES.some(dye => dye.code === eNumber);
            },
            
            // Get AZO dye warning
            getAzoWarning(eNumber) {
                const dye = this.AZO_DYES.find(d => d.code === eNumber);
                return dye ? dye.warning : null;
            },
            
            // Generate unique ID
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
        };

        // ===== UTILITY FUNCTIONS =====
        const Utils = {
            // Format date to German format
            formatDate(date, includeTime = false) {
                if (!date) return '-';
                
                const d = new Date(date);
                if (isNaN(d.getTime())) return '-';
                
                const day = d.getDate().toString().padStart(2, '0');
                const month = (d.getMonth() + 1).toString().padStart(2, '0');
                const year = d.getFullYear();
                
                if (includeTime) {
                    const hours = d.getHours().toString().padStart(2, '0');
                    const minutes = d.getMinutes().toString().padStart(2, '0');
                    return `${day}.${month}.${year} ${hours}:${minutes}`;
                }
                
                return `${day}.${month}.${year}`;
            },
            
            // Calculate weight in kg
            calculateWeight(size, quantity) {
                const sizeMap = {
                    '170': 0.170,
                    '500': 0.500,
                    '750': 0.750,
                    '1000': 1.000
                };
                return (sizeMap[size] || 0) * quantity;
            },
            
            // Calculate number of buckets needed
            calculateBuckets(totalKg, bucketSize = 6) {
                return Math.ceil(totalKg / bucketSize);
            },
            
            // Show notification
            showNotification(message, type = 'info') {
                // Remove existing notifications
                const existing = document.querySelector('.notification');
                if (existing) existing.remove();
                
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification alert alert-${type}`;
                notification.innerHTML = `
                    <div class="alert-icon">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'times-circle' : 'info-circle'}"></i>
                    </div>
                    <div class="alert-content">${message}</div>
                `;
                
                // Add to body
                document.body.appendChild(notification);
                
                // Position it
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.zIndex = '3000';
                notification.style.maxWidth = '400px';
                notification.style.boxShadow = 'var(--shadow-lg)';
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100px)';
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            },
            
            // Show modal
            showModal(title, content, buttons = []) {
                const overlay = document.getElementById('modal-overlay');
                const modalContent = document.getElementById('modal-content');
                
                // Build modal HTML
                let html = `
                    <div class="card-title" style="margin-bottom: var(--space-lg);">
                        <i class="fas fa-info-circle"></i> ${title}
                    </div>
                    <div style="margin-bottom: var(--space-lg);">
                        ${content}
                    </div>
                `;
                
                // Add buttons if provided
                if (buttons.length > 0) {
                    html += '<div class="d-flex gap-3 justify-content-end">';
                    buttons.forEach(btn => {
                        html += `<button class="btn btn-${btn.type}" id="modal-btn-${btn.id}">${btn.label}</button>`;
                    });
                    html += '</div>';
                } else {
                    html += '<div class="text-center"><button class="btn btn-primary" id="modal-close">OK</button></div>';
                }
                
                modalContent.innerHTML = html;
                overlay.style.display = 'flex';
                
                // Add event listeners
                if (buttons.length > 0) {
                    buttons.forEach(btn => {
                        document.getElementById(`modal-btn-${btn.id}`).onclick = () => {
                            btn.onClick();
                            overlay.style.display = 'none';
                        };
                    });
                } else {
                    document.getElementById('modal-close').onclick = () => {
                        overlay.style.display = 'none';
                    };
                }
                
                // Close on overlay click
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        overlay.style.display = 'none';
                    }
                };
            },
            
            // Highlight allergens in text
            highlightAllergens(text, allergens) {
                if (!text || !allergens || allergens.length === 0) return text;
                
                let highlighted = text;
                allergens.forEach(allergenCode => {
                    const allergenName = DB.getAllergenName(allergenCode);
                    if (allergenName && allergenName !== 'Unbekannt') {
                        const regex = new RegExp(`\\b${allergenName}\\b`, 'gi');
                        highlighted = highlighted.replace(regex, 
                            `<span class="allergen-bold">${allergenName}</span>`);
                    }
                });
                
                return highlighted;
            },
            
            // Calculate nutrition for recipe
            calculateRecipeNutrition(ingredients, totalWeight) {
                const nutrition = {
                    energy_kj: 0,
                    energy_kcal: 0,
                    fat: 0,
                    saturated_fat: 0,
                    carbs: 0,
                    sugar: 0,
                    protein: 0,
                    salt: 0
                };
                
                ingredients.forEach(item => {
                    const ingredient = item.ingredient;
                    const weight = item.weight;
                    const proportion = weight / totalWeight;
                    
                    if (ingredient.nutrition) {
                        nutrition.energy_kj += ingredient.nutrition.energy_kj * proportion;
                        nutrition.energy_kcal += ingredient.nutrition.energy_kcal * proportion;
                        nutrition.fat += ingredient.nutrition.fat * proportion;
                        nutrition.saturated_fat += ingredient.nutrition.saturated_fat * proportion;
                        nutrition.carbs += ingredient.nutrition.carbs * proportion;
                        nutrition.sugar += ingredient.nutrition.sugar * proportion;
                        nutrition.protein += ingredient.nutrition.protein * proportion;
                        nutrition.salt += ingredient.nutrition.salt * proportion;
                    }
                });
                
                // Round to 1 decimal place
                Object.keys(nutrition).forEach(key => {
                    nutrition[key] = Math.round(nutrition[key] * 10) / 10;
                });
                
                return nutrition;
            },
            
            // Detect AZO dyes in recipe
            detectAzoDyes(ingredients) {
                const azoDyes = [];
                
                ingredients.forEach(item => {
                    const ingredient = item.ingredient;
                    if (ingredient.e_numbers && ingredient.e_numbers.length > 0) {
                        ingredient.e_numbers.forEach(eNumber => {
                            if (DB.isAzoDye(eNumber)) {
                                const warning = DB.getAzoWarning(eNumber);
                                if (warning && !azoDyes.find(d => d.code === eNumber)) {
                                    azoDyes.push({
                                        code: eNumber,
                                        warning: warning
                                    });
                                }
                            }
                        });
                    }
                });
                
                return azoDyes;
            }
        };

        // ===== VIEW MANAGER =====
        const ViewManager = {
            init() {
                // Set up navigation buttons
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const view = btn.getAttribute('data-view');
                        this.switchView(view);
                    });
                });
                
                // Initialize all views
                this.switchView('dashboard');
            },
            
            switchView(viewName) {
                // Update active button
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.getAttribute('data-view') === viewName);
                });
                
                // Hide all views
                document.querySelectorAll('.view-container').forEach(view => {
                    view.classList.remove('active');
                });
                
                // Show selected view
                const targetView = document.getElementById(`${viewName}-view`);
                if (targetView) {
                    targetView.classList.add('active');
                    
                    // Initialize view-specific content
                    this.initView(viewName);
                }
            },
            
            initView(viewName) {
                switch(viewName) {
                    case 'dashboard':
                        Dashboard.init();
                        break;
                    case 'ingredients':
                        IngredientsManager.init();
                        break;
                    case 'recipes':
                        RecipesManager.init();
                        break;
                    case 'orders':
                        OrdersManager.init();
                        break;
                    case 'production':
                        ProductionManager.init();
                        break;
                    case 'flavors':
                        FlavorsManager.init();
                        break;
                    case 'labels':
                        LabelsManager.init();
                        break;
                    case 'customers':
                        CustomersManager.init();
                        break;
                    case 'statistics':
                        StatisticsManager.init();
                        break;
                    case 'settings':
                        SettingsManager.init();
                        break;
                }
            }
        };

        // ===== INGREDIENTS MANAGER =====
        const IngredientsManager = {
            currentIngredient: null,
            
            init() {
                this.loadIngredients();
                this.setupEventListeners();
                this.renderAllergenCheckboxes();
            },
            
            setupEventListeners() {
                // New ingredient button
                document.getElementById('new-ingredient-btn').addEventListener('click', () => {
                    this.showIngredientForm();
                });
                
                // Save ingredient button
                document.getElementById('save-ingredient-btn').addEventListener('click', () => {
                    this.saveIngredient();
                });
                
                // Cancel ingredient button
                document.getElementById('cancel-ingredient-btn').addEventListener('click', () => {
                    this.hideIngredientForm();
                });
                
                // Calculate nutrition button
                document.getElementById('calculate-nutrition-btn').addEventListener('click', () => {
                    this.showNutritionCalculator();
                });
                
                // Import/Export buttons
                document.getElementById('import-ingredients-btn').addEventListener('click', () => {
                    this.importIngredients();
                });
                
                document.getElementById('export-ingredients-btn').addEventListener('click', () => {
                    this.exportIngredients();
                });
                
                // E-numbers input change
                document.getElementById('ingredient-enumbers').addEventListener('input', (e) => {
                    this.checkAzoDyes(e.target.value);
                });
            },
            
            loadIngredients() {
                const ingredients = DB.getIngredients();
                const tbody = document.getElementById('ingredients-table');
                
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                ingredients.forEach(ingredient => {
                    // Get allergen names
                    const allergenNames = ingredient.allergens
                        ? ingredient.allergens.map(code => DB.getAllergenName(code))
                        : [];
                    
                    // Check for AZO dyes
                    const hasAzoDyes = ingredient.e_numbers
                        ? ingredient.e_numbers.some(eNumber => DB.isAzoDye(eNumber))
                        : false;
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <div class="fw-bold">${ingredient.name}</div>
                            <div class="text-muted fs-sm">${ingredient.description || ''}</div>
                        </td>
                        <td>
                            ${allergenNames.length > 0 
                                ? allergenNames.map(name => 
                                    `<span class="badge badge-danger mb-1">${name}</span>`
                                  ).join(' ')
                                : '<span class="text-muted">Keine</span>'}
                        </td>
                        <td>
                            ${ingredient.e_numbers && ingredient.e_numbers.length > 0
                                ? ingredient.e_numbers.map(eNumber => {
                                    const isAzo = DB.isAzoDye(eNumber);
                                    return `<span class="e-number ${isAzo ? 'bg-yellow-100 text-yellow-800' : ''}">${eNumber}</span>`;
                                  }).join(' ')
                                : '<span class="text-muted">Keine</span>'}
                            ${hasAzoDyes ? '<div class="text-warning fs-sm mt-1"><i class="fas fa-exclamation-triangle"></i> AZO</div>' : ''}
                        </td>
                        <td>
                            ${ingredient.nutrition
                                ? `${ingredient.nutrition.energy_kcal} kcal<br>
                                   <small>F: ${ingredient.nutrition.fat}g | KH: ${ingredient.nutrition.carbs}g | E: ${ingredient.nutrition.protein}g</small>`
                                : '<span class="text-muted">Nicht definiert</span>'}
                        </td>
                        <td>
                            ${ingredient.traces
                                ? `<div class="trace-warning">${ingredient.traces}</div>`
                                : '<span class="text-muted">Keine</span>'}
                        </td>
                        <td>
                            <div class="table-actions">
                                <button class="btn-icon edit-ingredient" data-id="${ingredient.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon delete-ingredient" data-id="${ingredient.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(tr);
                });
                
                // Add event listeners to edit/delete buttons
                this.addIngredientActionListeners();
            },
            
            addIngredientActionListeners() {
                // Edit ingredient
                document.querySelectorAll('.edit-ingredient').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const ingredientId = e.target.closest('button').getAttribute('data-id');
                        this.editIngredient(ingredientId);
                    });
                });
                
                // Delete ingredient
                document.querySelectorAll('.delete-ingredient').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const ingredientId = e.target.closest('button').getAttribute('data-id');
                        this.deleteIngredient(ingredientId);
                    });
                });
            },
            
            showIngredientForm(ingredient = null) {
                this.currentIngredient = ingredient;
                const formContainer = document.getElementById('ingredient-form-container');
                const tableContainer = document.querySelector('#ingredients-view .table-container');
                
                formContainer.style.display = 'block';
                if (tableContainer) tableContainer.style.display = 'none';
                
                if (ingredient) {
                    // Edit mode
                    document.getElementById('ingredient-name').value = ingredient.name;
                    document.getElementById('ingredient-category').value = ingredient.category;
                    document.getElementById('ingredient-description').value = ingredient.description || '';
                    document.getElementById('ingredient-traces').value = ingredient.traces || '';
                    document.getElementById('ingredient-enumbers').value = ingredient.e_numbers ? ingredient.e_numbers.join(', ') : '';
                    
                    // Set allergen checkboxes
                    if (ingredient.allergens) {
                        ingredient.allergens.forEach(code => {
                            const checkbox = document.querySelector(`input[value="${code}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    
                    // Set nutrition values
                    if (ingredient.nutrition) {
                        document.getElementById('nutrition-energy-kj').value = ingredient.nutrition.energy_kj || 0;
                        document.getElementById('nutrition-energy-kcal').value = ingredient.nutrition.energy_kcal || 0;
                        document.getElementById('nutrition-fat').value = ingredient.nutrition.fat || 0;
                        document.getElementById('nutrition-saturated-fat').value = ingredient.nutrition.saturated_fat || 0;
                        document.getElementById('nutrition-carbs').value = ingredient.nutrition.carbs || 0;
                        document.getElementById('nutrition-sugar').value = ingredient.nutrition.sugar || 0;
                        document.getElementById('nutrition-protein').value = ingredient.nutrition.protein || 0;
                        document.getElementById('nutrition-salt').value = ingredient.nutrition.salt || 0;
                    }
                    
                    // Check for AZO dyes
                    this.checkAzoDyes(ingredient.e_numbers ? ingredient.e_numbers.join(', ') : '');
                } else {
                    // New ingredient mode
                    document.getElementById('ingredient-form-container').querySelector('form').reset();
                    document.querySelectorAll('#allergens-checkbox-grid input[type="checkbox"]').forEach(cb => {
                        cb.checked = false;
                    });
                    document.getElementById('azo-warning-container').style.display = 'none';
                }
            },
            
            hideIngredientForm() {
                const formContainer = document.getElementById('ingredient-form-container');
                const tableContainer = document.querySelector('#ingredients-view .table-container');
                
                formContainer.style.display = 'none';
                if (tableContainer) tableContainer.style.display = 'block';
                
                this.currentIngredient = null;
            },
            
            renderAllergenCheckboxes() {
                const container = document.getElementById('allergens-checkbox-grid');
                container.innerHTML = '';
                
                DB.ALLERGENS.forEach(allergen => {
                    const div = document.createElement('div');
                    div.className = 'allergen-item';
                    div.innerHTML = `
                        <input type="checkbox" id="allergen-${allergen.code}" value="${allergen.code}">
                        <span class="allergen-icon">${allergen.icon}</span>
                        <div>
                            <div class="allergen-name">${allergen.name}</div>
                            <div class="allergen-code">${allergen.code}</div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            },
            
            checkAzoDyes(eNumbersText) {
                const azoContainer = document.getElementById('azo-warning-container');
                const azoText = document.getElementById('azo-warning-text');
                
                if (!eNumbersText.trim()) {
                    azoContainer.style.display = 'none';
                    return;
                }
                
                const eNumbers = eNumbersText.split(',').map(e => e.trim().toUpperCase());
                const azoDyes = [];
                
                eNumbers.forEach(eNumber => {
                    if (DB.isAzoDye(eNumber)) {
                        const warning = DB.getAzoWarning(eNumber);
                        if (warning) {
                            azoDyes.push({
                                code: eNumber,
                                warning: warning
                            });
                        }
                    }
                });
                
                if (azoDyes.length > 0) {
                    azoContainer.style.display = 'block';
                    azoText.innerHTML = `
                        <strong>Enth√§lt Azofarbstoffe:</strong><br>
                        ${azoDyes.map(dye => 
                            `<span class="e-number">${dye.code}</span>: ${dye.warning}`
                        ).join('<br>')}
                    `;
                } else {
                    azoContainer.style.display = 'none';
                }
            },
            
            saveIngredient() {
                // Get form values
                const name = document.getElementById('ingredient-name').value.trim();
                const category = document.getElementById('ingredient-category').value;
                const description = document.getElementById('ingredient-description').value.trim();
                const traces = document.getElementById('ingredient-traces').value.trim();
                
                // Get allergens
                const allergens = [];
                document.querySelectorAll('#allergens-checkbox-grid input[type="checkbox"]:checked').forEach(cb => {
                    allergens.push(cb.value);
                });
                
                // Get E-numbers
                const eNumbersText = document.getElementById('ingredient-enumbers').value.trim();
                const e_numbers = eNumbersText 
                    ? eNumbersText.split(',').map(e => e.trim().toUpperCase())
                    : [];
                
                // Get nutrition values
                const nutrition = {
                    energy_kj: parseFloat(document.getElementById('nutrition-energy-kj').value) || 0,
                    energy_kcal: parseFloat(document.getElementById('nutrition-energy-kcal').value) || 0,
                    fat: parseFloat(document.getElementById('nutrition-fat').value) || 0,
                    saturated_fat: parseFloat(document.getElementById('nutrition-saturated-fat').value) || 0,
                    carbs: parseFloat(document.getElementById('nutrition-carbs').value) || 0,
                    sugar: parseFloat(document.getElementById('nutrition-sugar').value) || 0,
                    protein: parseFloat(document.getElementById('nutrition-protein').value) || 0,
                    salt: parseFloat(document.getElementById('nutrition-salt').value) || 0
                };
                
                // Validate
                if (!name) {
                    Utils.showNotification('Bitte geben Sie einen Namen f√ºr die Zutat ein', 'warning');
                    return;
                }
                
                // Create ingredient object
                const ingredient = {
                    name,
                    category,
                    description,
                    allergens,
                    traces,
                    e_numbers,
                    nutrition
                };
                
                // If editing existing ingredient, keep the ID
                if (this.currentIngredient) {
                    ingredient.id = this.currentIngredient.id;
                    ingredient.created = this.currentIngredient.created;
                }
                
                // Save to database
                if (DB.saveIngredient(ingredient)) {
                    Utils.showNotification(
                        `Zutat "${name}" ${this.currentIngredient ? 'aktualisiert' : 'gespeichert'}`,
                        'success'
                    );
                    
                    this.hideIngredientForm();
                    this.loadIngredients();
                } else {
                    Utils.showNotification('Fehler beim Speichern der Zutat', 'danger');
                }
            },
            
            editIngredient(id) {
                const ingredients = DB.getIngredients();
                const ingredient = ingredients.find(i => i.id === id);
                
                if (ingredient) {
                    this.showIngredientForm(ingredient);
                }
            },
            
            deleteIngredient(id) {
                const ingredients = DB.getIngredients();
                const ingredient = ingredients.find(i => i.id === id);
                
                if (!ingredient) return;
                
                Utils.showModal('Zutat l√∂schen',
                    `Sind Sie sicher, dass Sie die Zutat "${ingredient.name}" l√∂schen m√∂chten?`,
                    [
                        {
                            id: 'cancel',
                            label: 'Abbrechen',
                            type: 'outline',
                            onClick: () => {}
                        },
                        {
                            id: 'delete',
                            label: 'L√∂schen',
                            type: 'danger',
                            onClick: () => {
                                if (DB.deleteIngredient(id)) {
                                    Utils.showNotification('Zutat gel√∂scht', 'success');
                                    this.loadIngredients();
                                }
                            }
                        }
                    ]);
            },
            
            showNutritionCalculator() {
                Utils.showModal('N√§hrwertrechner',
                    'Diese Funktion berechnet N√§hrwerte basierend auf den Zutaten. Sie wird in der Rezeptverwaltung automatisch verwendet.',
                    [
                        {
                            id: 'close',
                            label: 'Schlie√üen',
                            type: 'primary',
                            onClick: () => {}
                        }
                    ]);
            },
            
            importIngredients() {
                Utils.showNotification('Importfunktion in Entwicklung', 'info');
            },
            
            exportIngredients() {
                const ingredients = DB.getIngredients();
                const dataStr = JSON.stringify(ingredients, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `zutaten-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                Utils.showNotification('Zutaten exportiert', 'success');
            }
        };

        // ===== RECIPES MANAGER =====
        const RecipesManager = {
            currentRecipe: null,
            recipeIngredients: [],
            
            init() {
                this.setupEventListeners();
                this.loadRecipes();
                this.loadFlavors();
            },
            
            setupEventListeners() {
                // New recipe button
                document.getElementById('new-recipe-btn').addEventListener('click', () => {
                    this.showRecipeForm();
                });
                
                // Flavor selection
                document.getElementById('recipe-flavor').addEventListener('change', (e) => {
                    if (e.target.value) {
                        document.getElementById('recipe-flavor-name').textContent = e.target.value;
                    }
                });
                
                // Add ingredient to recipe
                document.getElementById('add-ingredient-to-recipe').addEventListener('click', () => {
                    this.showIngredientSelectionModal();
                });
                
                // Auto calculate recipe
                document.getElementById('auto-calculate-recipe').addEventListener('click', () => {
                    this.autoCalculateRecipe();
                });
                
                // Save recipe
                document.getElementById('save-recipe-btn').addEventListener('click', () => {
                    this.saveRecipe();
                });
                
                // Cancel recipe
                document.getElementById('cancel-recipe-btn').addEventListener('click', () => {
                    this.hideRecipeForm();
                });
                
                // Preview label
                document.getElementById('preview-label-btn').addEventListener('click', () => {
                    this.previewLabel();
                });
            },
            
            loadRecipes() {
                const recipes = DB.getRecipes();
                const tbody = document.getElementById('recipes-table');
                
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                recipes.forEach(recipe => {
                    // Get allergen codes from recipe
                    const allergenCodes = recipe.allergens || [];
                    const allergenNames = allergenCodes.map(code => DB.getAllergenName(code));
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <div class="fw-bold">${recipe.name}</div>
                            <div class="text-muted fs-sm">${recipe.description || ''}</div>
                        </td>
                        <td>${recipe.flavor || '‚Äî'}</td>
                        <td>
                            ${allergenNames.length > 0
                                ? allergenNames.map(name => 
                                    `<span class="badge badge-danger mb-1">${name}</span>`
                                  ).join(' ')
                                : '<span class="text-muted">Keine</span>'}
                        </td>
                        <td>
                            ${recipe.nutrition
                                ? `${recipe.nutrition.energy_kcal} kcal<br>
                                   <small>F: ${recipe.nutrition.fat}g | KH: ${recipe.nutrition.carbs}g</small>`
                                : '<span class="text-muted">Nicht berechnet</span>'}
                        </td>
                        <td>${Utils.formatDate(recipe.created)}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn-icon edit-recipe" data-id="${recipe.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon delete-recipe" data-id="${recipe.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn-icon generate-label" data-id="${recipe.id}">
                                    <i class="fas fa-tag"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(tr);
                });
                
                // Add event listeners
                this.addRecipeActionListeners();
            },
            
            addRecipeActionListeners() {
                // Edit recipe
                document.querySelectorAll('.edit-recipe').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const recipeId = e.target.closest('button').getAttribute('data-id');
                        this.editRecipe(recipeId);
                    });
                });
                
                // Delete recipe
                document.querySelectorAll('.delete-recipe').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const recipeId = e.target.closest('button').getAttribute('data-id');
                        this.deleteRecipe(recipeId);
                    });
                });
                
                // Generate label
                document.querySelectorAll('.generate-label').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const recipeId = e.target.closest('button').getAttribute('data-id');
                        this.generateLabelFromRecipe(recipeId);
                    });
                });
            },
            
            loadFlavors() {
                const flavors = DB.getFlavors();
                const select = document.getElementById('recipe-flavor');
                select.innerHTML = '<option value="">Sorte ausw√§hlen...</option>';
                
                flavors.forEach(flavor => {
                    if (flavor.active !== false) {
                        const option = document.createElement('option');
                        option.value = flavor.name;
                        option.textContent = flavor.name;
                        select.appendChild(option);
                    }
                });
            },
            
            showRecipeForm(recipe = null) {
                this.currentRecipe = recipe;
                this.recipeIngredients = recipe ? [...recipe.ingredients] : [];
                
                const formContainer = document.getElementById('recipe-form-container');
                const listContainer = document.getElementById('recipes-list-container');
                
                formContainer.style.display = 'block';
                listContainer.style.display = 'none';
                
                if (recipe) {
                    // Edit mode
                    document.getElementById('recipe-name').value = recipe.name;
                    document.getElementById('recipe-flavor').value = recipe.flavor || '';
                    document.getElementById('recipe-flavor-name').textContent = recipe.flavor || '';
                    document.getElementById('recipe-yield').value = recipe.yield || 1000;
                    
                    // Load ingredients
                    this.renderRecipeIngredients();
                    
                    // Update calculated values
                    this.updateRecipeCalculations();
                } else {
                    // New recipe mode
                    document.getElementById('recipe-name').value = '';
                    document.getElementById('recipe-flavor').value = '';
                    document.getElementById('recipe-flavor-name').textContent = '';
                    document.getElementById('recipe-yield').value = 1000;
                    this.recipeIngredients = [];
                    this.renderRecipeIngredients();
                    this.updateRecipeCalculations();
                }
            },
            
            hideRecipeForm() {
                const formContainer = document.getElementById('recipe-form-container');
                const listContainer = document.getElementById('recipes-list-container');
                
                formContainer.style.display = 'none';
                listContainer.style.display = 'block';
                
                this.currentRecipe = null;
                this.recipeIngredients = [];
            },
            
            showIngredientSelectionModal() {
                const ingredients = DB.getIngredients();
                
                let content = `
                    <div class="form-group">
                        <label class="form-label">Zutat ausw√§hlen</label>
                        <select class="form-select" id="modal-ingredient-select">
                            <option value="">Zutat w√§hlen...</option>
                            ${ingredients.map(ing => 
                                `<option value="${ing.id}">${ing.name}${ing.allergens && ing.allergens.length > 0 ? ' (' + ing.allergens.map(a => DB.getAllergenName(a)).join(', ') + ')' : ''}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Menge (g)</label>
                        <input type="number" class="form-input" id="modal-ingredient-amount" 
                               value="100" min="1" step="1">
                    </div>
                `;
                
                Utils.showModal('Zutat hinzuf√ºgen', content, [
                    {
                        id: 'cancel',
                        label: 'Abbrechen',
                        type: 'outline',
                        onClick: () => {}
                    },
                    {
                        id: 'add',
                        label: 'Hinzuf√ºgen',
                        type: 'primary',
                        onClick: () => {
                            const ingredientId = document.getElementById('modal-ingredient-select').value;
                            const amount = parseInt(document.getElementById('modal-ingredient-amount').value);
                            
                            if (!ingredientId || !amount || amount <= 0) {
                                Utils.showNotification('Bitte Zutat und Menge ausw√§hlen', 'warning');
                                return;
                            }
                            
                            const ingredient = ingredients.find(i => i.id === ingredientId);
                            if (ingredient) {
                                this.addIngredientToRecipe(ingredient, amount);
                            }
                        }
                    }
                ]);
            },
            
            addIngredientToRecipe(ingredient, amount) {
                // Check if ingredient already exists in recipe
                const existingIndex = this.recipeIngredients.findIndex(item => 
                    item.ingredient.id === ingredient.id
                );
                
                if (existingIndex !== -1) {
                    // Update existing ingredient amount
                    this.recipeIngredients[existingIndex].weight += amount;
                } else {
                    // Add new ingredient
                    this.recipeIngredients.push({
                        ingredient: ingredient,
                        weight: amount
                    });
                }
                
                this.renderRecipeIngredients();
                this.updateRecipeCalculations();
            },
            
            removeIngredientFromRecipe(index) {
                this.recipeIngredients.splice(index, 1);
                this.renderRecipeIngredients();
                this.updateRecipeCalculations();
            },
            
            renderRecipeIngredients() {
                const container = document.getElementById('recipe-ingredients-list');
                const totalWeight = this.getTotalRecipeWeight();
                
                container.innerHTML = '';
                
                this.recipeIngredients.forEach((item, index) => {
                    const ingredient = item.ingredient;
                    const weight = item.weight;
                    const percentage = totalWeight > 0 ? (weight / totalWeight * 100).toFixed(1) : 0;
                    
                    const div = document.createElement('div');
                    div.className = 'ingredient-row';
                    div.innerHTML = `
                        <div>
                            <div class="fw-bold">${ingredient.name}</div>
                            ${ingredient.allergens && ingredient.allergens.length > 0
                                ? `<div class="fs-sm">${ingredient.allergens.map(a => 
                                    `<span class="badge badge-danger">${DB.getAllergenName(a)}</span>`
                                  ).join(' ')}</div>`
                                : ''}
                        </div>
                        <div>
                            <input type="number" class="form-input ingredient-amount" 
                                   data-index="${index}" value="${weight}" min="1" step="1">
                        </div>
                        <div class="text-center">${percentage}%</div>
                        <div>
                            <button class="btn btn-danger btn-sm remove-recipe-ingredient" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(div);
                });
                
                // Add event listeners
                this.addRecipeIngredientEventListeners();
            },
            
            addRecipeIngredientEventListeners() {
                // Amount change
                document.querySelectorAll('.ingredient-amount').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const index = parseInt(e.target.getAttribute('data-index'));
                        const newAmount = parseInt(e.target.value);
                        
                        if (newAmount && newAmount > 0) {
                            this.recipeIngredients[index].weight = newAmount;
                            this.updateRecipeCalculations();
                        }
                    });
                });
                
                // Remove ingredient
                document.querySelectorAll('.remove-recipe-ingredient').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.closest('button').getAttribute('data-index'));
                        this.removeIngredientFromRecipe(index);
                    });
                });
            },
            
            getTotalRecipeWeight() {
                return this.recipeIngredients.reduce((total, item) => total + item.weight, 0);
            },
            
            updateRecipeCalculations() {
                const totalWeight = this.getTotalRecipeWeight();
                const yieldInput = document.getElementById('recipe-yield');
                
                // Update yield if needed
                if (!this.currentRecipe && totalWeight > 0) {
                    yieldInput.value = totalWeight;
                }
                
                // Calculate nutrition
                const nutrition = Utils.calculateRecipeNutrition(this.recipeIngredients, totalWeight);
                
                // Render nutrition
                this.renderNutrition(nutrition);
                
                // Detect allergens
                const allergens = this.detectAllergens();
                this.renderAllergens(allergens);
                
                // Detect traces
                const traces = this.detectTraces();
                this.renderTraces(traces);
                
                // Detect AZO dyes
                const azoDyes = Utils.detectAzoDyes(this.recipeIngredients);
                this.renderAzoWarnings(azoDyes);
            },
            
            renderNutrition(nutrition) {
                const container = document.getElementById('calculated-nutrition');
                
                container.innerHTML = `
                    <div class="nutrition-card">
                        <div class="nutrition-value">${nutrition.energy_kj}</div>
                        <div class="nutrition-unit">kJ</div>
                        <div class="nutrition-label">Energie</div>
                    </div>
                    <div class="nutrition-card">
                        <div class="nutrition-value">${nutrition.energy_kcal}</div>
                        <div class="nutrition-unit">kcal</div>
                        <div class="nutrition-label">Energie</div>
                    </div>
                    <div class="nutrition-card">
                        <div class="nutrition-value">${nutrition.fat}</div>
                        <div class="nutrition-unit">g</div>
                        <div class="nutrition-label">Fett</div>
                    </div>
                    <div class="nutrition-card">
                        <div class="nutrition-value">${nutrition.saturated_fat}</div>
                        <div class="nutrition-unit">g</div>
                        <div class="nutrition-label">- ges√§ttigt</div>
                    </div>
                    <div class="nutrition-card">
                        <div class="nutrition-value">${nutrition.carbs}</div>
                        <div class="nutrition-unit">g</div>
                        <div class="nutrition-label">Kohlenhydrate</div>
                    </div>
                    <div class="nutrition-card">
                        <div class="nutrition-value">${nutrition.sugar}</div>
                        <div class="nutrition-unit">g</div>
                        <div class="nutrition-label">- Zucker</div>
                    </div>
                    <div class="nutrition-card">
                        <div class="nutrition-value">${nutrition.protein}</div>
                        <div class="nutrition-unit">g</div>
                        <div class="nutrition-label">Eiwei√ü</div>
                    </div>
                    <div class="nutrition-card">
                        <div class="nutrition-value">${nutrition.salt}</div>
                        <div class="nutrition-unit">g</div>
                        <div class="nutrition-label">Salz</div>
                    </div>
                `;
            },
            
            detectAllergens() {
                const allergens = new Set();
                
                this.recipeIngredients.forEach(item => {
                    if (item.ingredient.allergens) {
                        item.ingredient.allergens.forEach(allergen => {
                            allergens.add(allergen);
                        });
                    }
                });
                
                return Array.from(allergens);
            },
            
            renderAllergens(allergenCodes) {
                const container = document.getElementById('recipe-allergens-list');
                container.innerHTML = '';
                
                allergenCodes.forEach(code => {
                    const allergen = DB.ALLERGENS.find(a => a.code === code);
                    if (allergen) {
                        const div = document.createElement('div');
                        div.className = 'allergen-item';
                        div.innerHTML = `
                            <span class="allergen-icon">${allergen.icon}</span>
                            <div>
                                <div class="allergen-name">${allergen.name}</div>
                                <div class="allergen-code">${allergen.code}</div>
                            </div>
                        `;
                        container.appendChild(div);
                    }
                });
            },
            
            detectTraces() {
                const traces = new Set();
                
                this.recipeIngredients.forEach(item => {
                    if (item.ingredient.traces) {
                        traces.add(item.ingredient.traces);
                    }
                });
                
                return Array.from(traces);
            },
            
            renderTraces(traces) {
                const container = document.getElementById('recipe-traces-warning');
                const text = document.getElementById('recipe-traces-text');
                
                if (traces.length > 0) {
                    container.style.display = 'flex';
                    text.textContent = traces.join(' ');
                } else {
                    container.style.display = 'none';
                }
            },
            
            renderAzoWarnings(azoDyes) {
                const container = document.getElementById('recipe-azo-warning');
                const details = document.getElementById('recipe-azo-details');
                
                if (azoDyes.length > 0) {
                    container.style.display = 'block';
                    details.innerHTML = azoDyes.map(dye => 
                        `<span class="e-number">${dye.code}</span>: ${dye.warning}`
                    ).join('<br>');
                } else {
                    container.style.display = 'none';
                }
            },
            
            autoCalculateRecipe() {
                const yieldValue = parseInt(document.getElementById('recipe-yield').value) || 1000;
                const totalWeight = this.getTotalRecipeWeight();
                
                if (totalWeight === 0) return;
                
                // Adjust all ingredient amounts proportionally
                const factor = yieldValue / totalWeight;
                
                this.recipeIngredients.forEach(item => {
                    item.weight = Math.round(item.weight * factor);
                });
                
                this.renderRecipeIngredients();
                this.updateRecipeCalculations();
                
                Utils.showNotification('Mengen angepasst', 'success');
            },
            
            saveRecipe() {
                const name = document.getElementById('recipe-name').value.trim();
                const flavor = document.getElementById('recipe-flavor').value;
                const yieldValue = parseInt(document.getElementById('recipe-yield').value) || 1000;
                
                // Validate
                if (!name) {
                    Utils.showNotification('Bitte geben Sie einen Rezeptnamen ein', 'warning');
                    return;
                }
                
                if (this.recipeIngredients.length === 0) {
                    Utils.showNotification('Bitte f√ºgen Sie mindestens eine Zutat hinzu', 'warning');
                    return;
                }
                
                // Calculate final values
                const totalWeight = this.getTotalRecipeWeight();
                const nutrition = Utils.calculateRecipeNutrition(this.recipeIngredients, totalWeight);
                const allergens = this.detectAllergens();
                const traces = this.detectTraces();
                const azoDyes = Utils.detectAzoDyes(this.recipeIngredients);
                
                // Create recipe object
                const recipe = {
                    name,
                    flavor,
                    yield: yieldValue,
                    ingredients: this.recipeIngredients.map(item => ({
                        ingredientId: item.ingredient.id,
                        ingredientName: item.ingredient.name,
                        weight: item.weight
                    })),
                    nutrition,
                    allergens,
                    traces: traces.length > 0 ? traces.join(' ') : '',
                    azo_dyes: azoDyes.map(dye => dye.code),
                    created: new Date().toISOString()
                };
                
                // If editing existing recipe, keep the ID
                if (this.currentRecipe) {
                    recipe.id = this.currentRecipe.id;
                    recipe.created = this.currentRecipe.created;
                }
                
                // Save to database
                if (DB.saveRecipe(recipe)) {
                    Utils.showNotification(
                        `Rezept "${name}" ${this.currentRecipe ? 'aktualisiert' : 'gespeichert'}`,
                        'success'
                    );
                    
                    this.hideRecipeForm();
                    this.loadRecipes();
                } else {
                    Utils.showNotification('Fehler beim Speichern des Rezepts', 'danger');
                }
            },
            
            editRecipe(id) {
                const recipes = DB.getRecipes();
                const recipe = recipes.find(r => r.id === id);
                
                if (recipe) {
                    // Load full ingredient objects
                    const ingredients = DB.getIngredients();
                    const recipeIngredients = recipe.ingredients.map(item => {
                        const ingredient = ingredients.find(i => i.id === item.ingredientId);
                        if (ingredient) {
                            return {
                                ingredient: ingredient,
                                weight: item.weight
                            };
                        }
                        return null;
                    }).filter(item => item !== null);
                    
                    recipe.ingredients = recipeIngredients;
                    this.showRecipeForm(recipe);
                }
            },
            
            deleteRecipe(id) {
                const recipes = DB.getRecipes();
                const recipe = recipes.find(r => r.id === id);
                
                if (!recipe) return;
                
                Utils.showModal('Rezept l√∂schen',
                    `Sind Sie sicher, dass Sie das Rezept "${recipe.name}" l√∂schen m√∂chten?`,
                    [
                        {
                            id: 'cancel',
                            label: 'Abbrechen',
                            type: 'outline',
                            onClick: () => {}
                        },
                        {
                            id: 'delete',
                            label: 'L√∂schen',
                            type: 'danger',
                            onClick: () => {
                                const recipes = DB.getRecipes();
                                const filtered = recipes.filter(r => r.id !== id);
                                DB.set(DB.KEYS.RECIPES, filtered);
                                this.loadRecipes();
                                Utils.showNotification('Rezept gel√∂scht', 'success');
                            }
                        }
                    ]);
            },
            
            generateLabelFromRecipe(recipeId) {
                const recipes = DB.getRecipes();
                const recipe = recipes.find(r => r.id === recipeId);
                
                if (recipe) {
                    // Switch to labels view and populate
                    ViewManager.switchView('labels');
                    
                    // Populate label form
                    setTimeout(() => {
                        const flavorSelect = document.getElementById('label-flavor');
                        if (flavorSelect) {
                            flavorSelect.value = recipe.flavor || '';
                        }
                        
                        // Trigger label generation
                        const generateBtn = document.getElementById('generate-label-btn');
                        if (generateBtn) {
                            generateBtn.click();
                        }
                    }, 100);
                }
            },
            
            previewLabel() {
                // This would show a preview of the label
                Utils.showNotification('Etiketten-Vorschau wird vorbereitet...', 'info');
            }
        };

        // ===== ORDERS MANAGER =====
        const OrdersManager = {
            currentOrder: {
                items: []
            },
            
            init() {
                this.setDefaultDate();
                this.setupEventListeners();
                this.loadRecentOrders();
                this.updateOrderSummary();
            },
            
            setDefaultDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('order-date').value = today;
            },
            
            setupEventListeners() {
                // Add order item
                document.getElementById('add-order-item-btn').addEventListener('click', () => {
                    this.addOrderItem();
                });
                
                // Clear order
                document.getElementById('clear-order-btn').addEventListener('click', () => {
                    this.clearOrder();
                });
                
                // Save order
                document.getElementById('save-order-btn').addEventListener('click', () => {
                    this.saveOrder();
                });
                
                // Print order
                document.getElementById('print-order-btn').addEventListener('click', () => {
                    this.printOrder();
                });
                
                // Export order
                document.getElementById('export-order-btn').addEventListener('click', () => {
                    this.exportOrder();
                });
            },
            
            addOrderItem() {
                const item = {
                    id: DB.generateId(),
                    flavor: '',
                    size: '750',
                    quantity: 1
                };
                
                this.currentOrder.items.push(item);
                this.renderOrderItems();
            },
            
            renderOrderItems() {
                const container = document.getElementById('order-items-list');
                const flavors = DB.getFlavors().filter(f => f.active !== false);
                
                container.innerHTML = '';
                
                this.currentOrder.items.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'order-item';
                    div.innerHTML = `
                        <select class="form-select order-item-flavor" data-index="${index}">
                            <option value="">Sorte w√§hlen...</option>
                            ${flavors.map(flavor => 
                                `<option value="${flavor.name}" ${item.flavor === flavor.name ? 'selected' : ''}>
                                    ${flavor.name}
                                </option>`
                            ).join('')}
                        </select>
                        <select class="form-select order-item-size" data-index="${index}">
                            <option value="170" ${item.size === '170' ? 'selected' : ''}>170 g</option>
                            <option value="750" ${item.size === '750' || !item.size ? 'selected' : ''}>750 g</option>
                            <option value="1000" ${item.size === '1000' ? 'selected' : ''}>1000 g</option>
                        </select>
                        <input type="number" class="form-input order-item-quantity" 
                               data-index="${index}" value="${item.quantity}" min="1" max="100">
                        <button class="btn btn-danger btn-sm remove-order-item" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    
                    container.appendChild(div);
                });
                
                // Add event listeners
                this.addOrderItemEventListeners();
                this.updateOrderSummary();
            },
            
            addOrderItemEventListeners() {
                // Flavor change
                document.querySelectorAll('.order-item-flavor').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const index = parseInt(e.target.getAttribute('data-index'));
                        this.currentOrder.items[index].flavor = e.target.value;
                    });
                });
                
                // Size change
                document.querySelectorAll('.order-item-size').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const index = parseInt(e.target.getAttribute('data-index'));
                        this.currentOrder.items[index].size = e.target.value;
                        this.updateOrderSummary();
                    });
                });
                
                // Quantity change
                document.querySelectorAll('.order-item-quantity').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const index = parseInt(e.target.getAttribute('data-index'));
                        const value = parseInt(e.target.value);
                        this.currentOrder.items[index].quantity = isNaN(value) ? 1 : value;
                        this.updateOrderSummary();
                    });
                });
                
                // Remove item
                document.querySelectorAll('.remove-order-item').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = parseInt(e.target.closest('button').getAttribute('data-index'));
                        this.currentOrder.items.splice(index, 1);
                        this.renderOrderItems();
                    });
                });
            },
            
            updateOrderSummary() {
                let totalItems = 0;
                let total750g = 0;
                let total170g = 0;
                let totalKg = 0;
                
                this.currentOrder.items.forEach(item => {
                    totalItems += item.quantity;
                    
                    if (item.size === '750') {
                        total750g += item.quantity;
                    } else if (item.size === '170') {
                        total170g += item.quantity;
                    }
                    
                    totalKg += Utils.calculateWeight(item.size, item.quantity);
                });
                
                const settings = DB.getSettings();
                const bucketSize = settings.bucket_size || 6;
                const totalBuckets = Utils.calculateBuckets(totalKg, bucketSize);
                
                document.getElementById('total-items').textContent = totalItems;
                document.getElementById('total-750g').textContent = total750g;
                document.getElementById('total-170g').textContent = total170g;
                document.getElementById('total-kg').textContent = totalKg.toFixed(1);
                document.getElementById('total-buckets').textContent = totalBuckets;
            },
            
            clearOrder() {
                this.currentOrder = {
                    items: []
                };
                this.renderOrderItems();
                
                // Reset form
                document.getElementById('order-customer').value = '';
                document.getElementById('order-priority').value = 'normal';
                document.getElementById('order-notes').value = '';
                
                Utils.showNotification('Bestellung geleert', 'info');
            },
            
            saveOrder() {
                const customer = document.getElementById('order-customer').value;
                const date = document.getElementById('order-date').value;
                const priority = document.getElementById('order-priority').value;
                const notes = document.getElementById('order-notes').value;
                
                // Validate
                if (!customer) {
                    Utils.showNotification('Bitte einen Kunden ausw√§hlen', 'warning');
                    return;
                }
                
                if (this.currentOrder.items.length === 0) {
                    Utils.showNotification('Bitte f√ºgen Sie mindestens eine Position hinzu', 'warning');
                    return;
                }
                
                // Calculate total weight for bucket calculation
                let totalKg = 0;
                this.currentOrder.items.forEach(item => {
                    totalKg += Utils.calculateWeight(item.size, item.quantity);
                });
                
                const settings = DB.getSettings();
                const bucketSize = settings.bucket_size || 6;
                const totalBuckets = Utils.calculateBuckets(totalKg, bucketSize);
                
                // Create order object
                const order = {
                    id: DB.generateId(),
                    customer,
                    date,
                    priority,
                    notes,
                    items: [...this.currentOrder.items],
                    total_kg: totalKg,
                    total_buckets: totalBuckets,
                    status: 'pending',
                    created: new Date().toISOString()
                };
                
                // Save to localStorage
                const orders = DB.get(DB.KEYS.ORDERS);
                orders.push(order);
                DB.set(DB.KEYS.ORDERS, orders);
                
                Utils.showNotification('Bestellung gespeichert', 'success');
                
                // Clear form
                this.clearOrder();
                
                // Update recent orders
                this.loadRecentOrders();
            },
            
            loadRecentOrders() {
                const orders = DB.get(DB.KEYS.ORDERS);
                const tbody = document.getElementById('recent-orders');
                
                if (!tbody) return;
                
                // Sort by date (newest first)
                orders.sort((a, b) => new Date(b.created) - new Date(a.created));
                
                tbody.innerHTML = '';
                
                // Show last 5 orders
                orders.slice(0, 5).forEach(order => {
                    const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${Utils.formatDate(order.date)}</td>
                        <td>${order.customer}</td>
                        <td>${totalItems} Stk. (${order.total_kg.toFixed(1)} kg)</td>
                        <td>
                            <span class="badge ${order.status === 'completed' ? 'badge-success' : 'badge-warning'}">
                                ${order.status === 'completed' ? 'Erledigt' : 'Ausstehend'}
                            </span>
                        </td>
                        <td>
                            <div class="table-actions">
                                <button class="btn-icon view-order" data-id="${order.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-icon delete-order" data-id="${order.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(tr);
                });
                
                // Add event listeners
                this.addRecentOrderEventListeners();
            },
            
            addRecentOrderEventListeners() {
                // View order
                document.querySelectorAll('.view-order').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const orderId = e.target.closest('button').getAttribute('data-id');
                        this.viewOrder(orderId);
                    });
                });
                
                // Delete order
                document.querySelectorAll('.delete-order').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const orderId = e.target.closest('button').getAttribute('data-id');
                        this.deleteOrder(orderId);
                    });
                });
            },
            
            viewOrder(orderId) {
                const orders = DB.get(DB.KEYS.ORDERS);
                const order = orders.find(o => o.id === orderId);
                
                if (order) {
                    let content = `
                        <h3>Bestelldetails</h3>
                        <p><strong>Kunde:</strong> ${order.customer}</p>
                        <p><strong>Datum:</strong> ${Utils.formatDate(order.date)}</p>
                        <p><strong>Status:</strong> ${order.status}</p>
                        <p><strong>Priorit√§t:</strong> ${order.priority}</p>
                        <p><strong>Gesamtmenge:</strong> ${order.total_kg.toFixed(1)} kg (${order.total_buckets} Eimer)</p>
                        ${order.notes ? `<p><strong>Notizen:</strong> ${order.notes}</p>` : ''}
                        
                        <h4>Positionen:</h4>
                        <table class="table" style="font-size: 12px;">
                            <thead>
                                <tr>
                                    <th>Sorte</th>
                                    <th>Gr√∂√üe</th>
                                    <th>Menge</th>
                                    <th>Gewicht</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    order.items.forEach(item => {
                        const weight = Utils.calculateWeight(item.size, item.quantity);
                        content += `
                            <tr>
                                <td>${item.flavor}</td>
                                <td>${item.size} g</td>
                                <td>${item.quantity} Stk.</td>
                                <td>${weight.toFixed(2)} kg</td>
                            </tr>
                        `;
                    });
                    
                    content += `
                            </tbody>
                        </table>
                    `;
                    
                    Utils.showModal('Bestelldetails', content, [
                        {
                            id: 'close',
                            label: 'Schlie√üen',
                            type: 'primary',
                            onClick: () => {}
                        }
                    ]);
                }
            },
            
            deleteOrder(orderId) {
                Utils.showModal('Bestellung l√∂schen',
                    'Sind Sie sicher, dass Sie diese Bestellung l√∂schen m√∂chten?',
                    [
                        {
                            id: 'cancel',
                            label: 'Abbrechen',
                            type: 'outline',
                            onClick: () => {}
                        },
                        {
                            id: 'delete',
                            label: 'L√∂schen',
                            type: 'danger',
                            onClick: () => {
                                const orders = DB.get(DB.KEYS.ORDERS);
                                const filtered = orders.filter(o => o.id !== orderId);
                                DB.set(DB.KEYS.ORDERS, filtered);
                                this.loadRecentOrders();
                                Utils.showNotification('Bestellung gel√∂scht', 'success');
                            }
                        }
                    ]);
            },
            
            printOrder() {
                if (this.currentOrder.items.length === 0) {
                    Utils.showNotification('Keine Bestellung zum Drucken', 'warning');
                    return;
                }
                
                Utils.showNotification('Druckfunktion in Entwicklung', 'info');
            },
            
            exportOrder() {
                if (this.currentOrder.items.length === 0) {
                    Utils.showNotification('Keine Bestellung zum Exportieren', 'warning');
                    return;
                }
                
                const orderData = {
                    customer: document.getElementById('order-customer').value,
                    date: document.getElementById('order-date').value,
                    priority: document.getElementById('order-priority').value,
                    notes: document.getElementById('order-notes').value,
                    items: this.currentOrder.items,
                    summary: {
                        totalItems: document.getElementById('total-items').textContent,
                        total750g: document.getElementById('total-750g').textContent,
                        total170g: document.getElementById('total-170g').textContent,
                        totalKg: document.getElementById('total-kg').textContent,
                        totalBuckets: document.getElementById('total-buckets').textContent
                    }
                };
                
                const dataStr = JSON.stringify(orderData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `bestellung-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                Utils.showNotification('Bestellung exportiert', 'success');
            }
        };

        // ===== PRODUCTION MANAGER =====
        const ProductionManager = {
            init() {
                this.setDefaultDate();
                this.setupEventListeners();
                this.updateProductionStats();
            },
            
            setDefaultDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('production-date').value = today;
            },
            
            setupEventListeners() {
                // Generate production plan
                document.getElementById('generate-production-plan-btn').addEventListener('click', () => {
                    this.generateProductionPlan();
                });
                
                // Start production
                document.getElementById('start-production-btn').addEventListener('click', () => {
                    this.startProduction();
                });
                
                // Print production plan
                document.getElementById('print-production-plan-btn').addEventListener('click', () => {
                    this.printProductionPlan();
                });
                
                // Date change
                document.getElementById('production-date').addEventListener('change', () => {
                    this.updateProductionStats();
                });
            },
            
            updateProductionStats() {
                const date = document.getElementById('production-date').value;
                const orders = DB.get(DB.KEYS.ORDERS);
                
                // Filter orders for selected date
                const dateOrders = orders.filter(o => o.date === date);
                
                // Calculate totals
                let totalKg = 0;
                let total750g = 0;
                let total170g = 0;
                let openOrders = dateOrders.filter(o => o.status !== 'completed').length;
                
                dateOrders.forEach(order => {
                    totalKg += order.total_kg || 0;
                    
                    order.items.forEach(item => {
                        if (item.size === '750') total750g += item.quantity;
                        if (item.size === '170') total170g += item.quantity;
                    });
                });
                
                const settings = DB.getSettings();
                const bucketSize = settings.bucket_size || 6;
                const bucketsNeeded = Utils.calculateBuckets(totalKg, bucketSize);
                
                const completedPercent = dateOrders.length > 0 ? 
                    Math.round(((dateOrders.length - openOrders) / dateOrders.length) * 100) : 0;
                
                // Update display
                document.getElementById('prod-today-kg').textContent = totalKg.toFixed(1) + ' kg';
                document.getElementById('prod-buckets-needed').textContent = bucketsNeeded;
                document.getElementById('prod-completed').textContent = completedPercent + '%';
                document.getElementById('prod-open-orders').textContent = openOrders;
            },
            
            generateProductionPlan() {
                const date = document.getElementById('production-date').value;
                const orders = DB.get(DB.KEYS.ORDERS);
                
                // Filter and aggregate by flavor
                const flavorMap = {};
                
                orders
                    .filter(o => o.date === date)
                    .forEach(order => {
                        order.items.forEach(item => {
                            if (!flavorMap[item.flavor]) {
                                flavorMap[item.flavor] = {
                                    flavor: item.flavor,
                                    size750: 0,
                                    size170: 0,
                                    kg: 0
                                };
                            }
                            
                            flavorMap[item.flavor].kg += Utils.calculateWeight(item.size, item.quantity);
                            if (item.size === '750') flavorMap[item.flavor].size750 += item.quantity;
                            if (item.size === '170') flavorMap[item.flavor].size170 += item.quantity;
                        });
                    });
                
                // Convert to array and sort by kg
                const flavors = Object.values(flavorMap)
                    .sort((a, b) => b.kg - a.kg);
                
                // Render table
                const tbody = document.getElementById('production-plan');
                tbody.innerHTML = '';
                
                flavors.forEach(flavor => {
                    const settings = DB.getSettings();
                    const bucketSize = settings.bucket_size || 6;
                    const buckets = Utils.calculateBuckets(flavor.kg, bucketSize);
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${flavor.flavor || 'Unbekannt'}</strong></td>
                        <td>${flavor.size750}</td>
                        <td>${flavor.size170}</td>
                        <td>${flavor.kg.toFixed(2)} kg</td>
                        <td>${buckets} Eimer</td>
                        <td>
                            <span class="badge badge-warning">Geplant</span>
                        </td>
                        <td>
                            <div class="table-actions">
                                <button class="btn-icon start-flavor" data-flavor="${flavor.flavor}">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn-icon complete-flavor" data-flavor="${flavor.flavor}">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(tr);
                });
                
                // Add event listeners
                this.addFlavorActionListeners();
                
                Utils.showNotification('Produktionsplan generiert', 'success');
            },
            
            addFlavorActionListeners() {
                // Start flavor production
                document.querySelectorAll('.start-flavor').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const flavor = e.target.closest('button').getAttribute('data-flavor');
                        this.startFlavorProduction(flavor);
                    });
                });
                
                // Complete flavor production
                document.querySelectorAll('.complete-flavor').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const flavor = e.target.closest('button').getAttribute('data-flavor');
                        this.completeFlavorProduction(flavor);
                    });
                });
            },
            
            startFlavorProduction(flavor) {
                Utils.showNotification(`Produktion von ${flavor} gestartet`, 'success');
            },
            
            completeFlavorProduction(flavor) {
                Utils.showNotification(`Produktion von ${flavor} abgeschlossen`, 'success');
            },
            
            startProduction() {
                Utils.showModal('Produktion starten',
                    'M√∂chten Sie die Produktion f√ºr den heutigen Tag starten?',
                    [
                        {
                            id: 'cancel',
                            label: 'Abbrechen',
                            type: 'outline',
                            onClick: () => {}
                        },
                        {
                            id: 'start',
                            label: 'Produktion starten',
                            type: 'success',
                            onClick: () => {
                                // Activate XL production mode
                                const settings = DB.getSettings();
                                settings.production_mode = 'xl';
                                DB.saveSettings(settings);
                                
                                Utils.showNotification('Produktion gestartet (XL-Modus aktiviert)', 'success');
                            }
                        }
                    ]);
            },
            
            printProductionPlan() {
                Utils.showNotification('Druckfunktion in Entwicklung', 'info');
            }
        };

        // ===== FLAVORS MANAGER =====
        const FlavorsManager = {
            init() {
                this.setupEventListeners();
                this.loadFlavors();
            },
            
            setupEventListeners() {
                // Add flavor
                document.getElementById('add-flavor-btn').addEventListener('click', () => {
                    this.addFlavor();
                });
                
                // Reset flavors
                document.getElementById('reset-flavors-btn').addEventListener('click', () => {
                    this.resetFlavors();
                });
            },
            
            loadFlavors() {
                const flavors = DB.getFlavors();
                const tbody = document.getElementById('flavors-list');
                
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                flavors.forEach(flavor => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <div class="fw-bold">${flavor.name}</div>
                            ${!flavor.active ? '<span class="badge badge-danger">Inaktiv</span>' : ''}
                        </td>
                        <td>
                            <span class="badge badge-primary">${flavor.category}</span>
                        </td>
                        <td>${flavor.description || '‚Äî'}</td>
                        <td>
                            <span class="badge ${flavor.active ? 'badge-success' : 'badge-danger'}">
                                ${flavor.active ? 'Aktiv' : 'Inaktiv'}
                            </span>
                        </td>
                        <td>
                            <div class="table-actions">
                                <button class="btn-icon edit-flavor" data-id="${flavor.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon toggle-flavor" data-id="${flavor.id}">
                                    <i class="fas fa-power-off"></i>
                                </button>
                                <button class="btn-icon delete-flavor" data-id="${flavor.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(tr);
                });
                
                // Add event listeners
                this.addFlavorActionListeners();
            },
            
            addFlavorActionListeners() {
                // Edit flavor
                document.querySelectorAll('.edit-flavor').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const flavorId = e.target.closest('button').getAttribute('data-id');
                        this.editFlavor(flavorId);
                    });
                });
                
                // Toggle flavor active status
                document.querySelectorAll('.toggle-flavor').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const flavorId = e.target.closest('button').getAttribute('data-id');
                        this.toggleFlavor(flavorId);
                    });
                });
                
                // Delete flavor
                document.querySelectorAll('.delete-flavor').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const flavorId = e.target.closest('button').getAttribute('data-id');
                        this.deleteFlavor(flavorId);
                    });
                });
            },
            
            addFlavor() {
                const name = document.getElementById('new-flavor-name').value.trim();
                const category = document.getElementById('new-flavor-category').value;
                const description = document.getElementById('new-flavor-description').value.trim();
                
                if (!name) {
                    Utils.showNotification('Bitte geben Sie einen Namen f√ºr die Sorte ein', 'warning');
                    return;
                }
                
                const flavor = {
                    id: DB.generateId(),
                    name,
                    category,
                    description,
                    active: true,
                    created: new Date().toISOString()
                };
                
                const flavors = DB.getFlavors();
                flavors.push(flavor);
                DB.set(DB.KEYS.FLAVORS, flavors);
                
                // Clear form
                document.getElementById('new-flavor-name').value = '';
                document.getElementById('new-flavor-description').value = '';
                
                Utils.showNotification(`Sorte "${name}" hinzugef√ºgt`, 'success');
                this.loadFlavors();
                
                // Update flavor select in recipes
                RecipesManager.loadFlavors();
            },
            
            editFlavor(flavorId) {
                const flavors = DB.getFlavors();
                const flavor = flavors.find(f => f.id === flavorId);
                
                if (flavor) {
                    let content = `
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-input" id="edit-flavor-name" value="${flavor.name}">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Kategorie</label>
                            <select class="form-select" id="edit-flavor-category">
                                <option value="milcheis" ${flavor.category === 'milcheis' ? 'selected' : ''}>Milcheis</option>
                                <option value="sorbet" ${flavor.category === 'sorbet' ? 'selected' : ''}>Sorbet</option>
                                <option value="fruchteis" ${flavor.category === 'fruchteis' ? 'selected' : ''}>Fruchteis</option>
                                <option value="speiseeis" ${flavor.category === 'speiseeis' ? 'selected' : ''}>Speiseeis</option>
                                <option value="spezial" ${flavor.category === 'spezial' ? 'selected' : ''}>Spezial</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Beschreibung</label>
                            <textarea class="form-textarea" id="edit-flavor-description">${flavor.description || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="edit-flavor-active">
                                <option value="true" ${flavor.active ? 'selected' : ''}>Aktiv</option>
                                <option value="false" ${!flavor.active ? 'selected' : ''}>Inaktiv</option>
                            </select>
                        </div>
                    `;
                    
                    Utils.showModal('Sorte bearbeiten', content, [
                        {
                            id: 'cancel',
                            label: 'Abbrechen',
                            type: 'outline',
                            onClick: () => {}
                        },
                        {
                            id: 'save',
                            label: 'Speichern',
                            type: 'primary',
                            onClick: () => {
                                flavor.name = document.getElementById('edit-flavor-name').value.trim();
                                flavor.category = document.getElementById('edit-flavor-category').value;
                                flavor.description = document.getElementById('edit-flavor-description').value.trim();
                                flavor.active = document.getElementById('edit-flavor-active').value === 'true';
                                
                                DB.set(DB.KEYS.FLAVORS, flavors);
                                Utils.showNotification('Sorte aktualisiert', 'success');
                                this.loadFlavors();
                                RecipesManager.loadFlavors();
                            }
                        }
                    ]);
                }
            },
            
            toggleFlavor(flavorId) {
                const flavors = DB.getFlavors();
                const flavor = flavors.find(f => f.id === flavorId);
                
                if (flavor) {
                    flavor.active = !flavor.active;
                    DB.set(DB.KEYS.FLAVORS, flavors);
                    
                    Utils.showNotification(
                        `Sorte ${flavor.active ? 'aktiviert' : 'deaktiviert'}`,
                        'success'
                    );
                    
                    this.loadFlavors();
                    RecipesManager.loadFlavors();
                }
            },
            
            deleteFlavor(flavorId) {
                Utils.showModal('Sorte l√∂schen',
                    'Sind Sie sicher, dass Sie diese Sorte l√∂schen m√∂chten?',
                    [
                        {
                            id: 'cancel',
                            label: 'Abbrechen',
                            type: 'outline',
                            onClick: () => {}
                        },
                        {
                            id: 'delete',
                            label: 'L√∂schen',
                            type: 'danger',
                            onClick: () => {
                                const flavors = DB.getFlavors();
                                const filtered = flavors.filter(f => f.id !== flavorId);
                                DB.set(DB.KEYS.FLAVORS, filtered);
                                Utils.showNotification('Sorte gel√∂scht', 'success');
                                this.loadFlavors();
                                RecipesManager.loadFlavors();
                            }
                        }
                    ]);
            },
            
            resetFlavors() {
                Utils.showModal('Standard-Sorten wiederherstellen',
                    'M√∂chten Sie die Standard-Sorten wiederherstellen?',
                    [
                        {
                            id: 'cancel',
                            label: 'Abbrechen',
                            type: 'outline',
                            onClick: () => {}
                        },
                        {
                            id: 'reset',
                            label: 'Wiederherstellen',
                            type: 'danger',
                            onClick: () => {
                                const defaultFlavors = [
                                    { id: '1', name: 'Vanille', category: 'milcheis', description: 'Klassische Vanille', active: true },
                                    { id: '2', name: 'Schokolade', category: 'milcheis', description: 'Milcheis mit Schokolade', active: true },
                                    { id: '3', name: 'Erdbeer', category: 'fruchteis', description: 'Frisches Erdbeereis', active: true },
                                    { id: '4', name: 'Stracciatella', category: 'milcheis', description: 'Milcheis mit Schokost√ºckchen', active: true },
                                    { id: '5', name: 'Zitrone', category: 'sorbet', description: 'Erfrischendes Zitronensorbet', active: true }
                                ];
                                
                                DB.set(DB.KEYS.FLAVORS, defaultFlavors);
                                Utils.showNotification('Standard-Sorten wiederhergestellt', 'success');
                                this.loadFlavors();
                                RecipesManager.loadFlavors();
                            }
                        }
                    ]);
            }
        };

        // ===== LABELS MANAGER =====
        const LabelsManager = {
            init() {
                this.setDefaultDates();
                this.setupEventListeners();
                this.loadFlavors();
                this.loadRecentLabels();
                this.generateLabelPreview();
            },
            
            setDefaultDates() {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                // Set expiry date to 6 months from now
                const expiry = new Date();
                expiry.setMonth(expiry.getMonth() + 6);
                const expiryStr = expiry.toISOString().split('T')[0];
                
                document.getElementById('label-expiry').value = expiryStr;
                
                // Set batch number
                const batchNumber = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}-001`;
                document.getElementById('label-batch').value = batchNumber;
            },
            
            setupEventListeners() {
                // Generate label
                document.getElementById('generate-label-btn').addEventListener('click', () => {
                    this.generateLabelPreview();
                });
                
                // Print label
                document.getElementById('print-label-btn').addEventListener('click', () => {
                    this.printLabel();
                });
                
                // Print batch
                document.getElementById('print-batch-btn').addEventListener('click', () => {
                    this.printBatch();
                });
                
                // Export label
                document.getElementById('export-label-btn').addEventListener('click', () => {
                    this.exportLabel();
                });
            },
            
            loadFlavors() {
                const flavors = DB.getFlavors();
                const select = document.getElementById('label-flavor');
                select.innerHTML = '<option value="">Sorte ausw√§hlen...</option>';
                
                flavors.forEach(flavor => {
                    if (flavor.active !== false) {
                        const option = document.createElement('option');
                        option.value = flavor.name;
                        option.textContent = flavor.name;
                        select.appendChild(option);
                    }
                });
            },
            
            generateLabelPreview() {
                const flavor = document.getElementById('label-flavor').value;
                const size = document.getElementById('label-size').value;
                const batch = document.getElementById('label-batch').value;
                const expiry = document.getElementById('label-expiry').value;
                
                if (!flavor) {
                    Utils.showNotification('Bitte eine Sorte ausw√§hlen', 'warning');
                    return;
                }
                
                // Get recipe for this flavor
                const recipes = DB.getRecipes();
                const recipe = recipes.find(r => r.flavor === flavor);
                
                // Format expiry date
                const expiryDate = new Date(expiry);
                const expiryFormatted = expiryDate.toLocaleDateString('de-DE');
                
                // Generate label HTML
                const labelPreview = document.getElementById('label-preview-content');
                
                // Default values
                let ingredients = 'Vollmilch, Sahne, Zucker, Eigelb, nat√ºrliches Aroma';
                let allergens = 'Milch, Ei';
                let nutrition = 'Energie: 850 kJ / 203 kcal<br>Fett: 8,5 g (davon ges√§ttigte Fetts√§uren: 5,2 g)<br>Kohlenhydrate: 25 g (davon Zucker: 22 g)<br>Eiwei√ü: 3,8 g<br>Salz: 0,12 g';
                let traces = '';
                let azoWarning = '';
                
                // Use recipe data if available
                if (recipe) {
                    if (recipe.ingredients && recipe.ingredients.length > 0) {
                        ingredients = recipe.ingredients.map(item => item.ingredientName).join(', ');
                    }
                    
                    if (recipe.allergens && recipe.allergens.length > 0) {
                        allergens = recipe.allergens.map(code => DB.getAllergenName(code)).join(', ');
                    }
                    
                    if (recipe.nutrition) {
                        const n = recipe.nutrition;
                        nutrition = `
                            Energie: ${n.energy_kj} kJ / ${n.energy_kcal} kcal<br>
                            Fett: ${n.fat} g (davon ges√§ttigte Fetts√§uren: ${n.saturated_fat} g)<br>
                            Kohlenhydrate: ${n.carbs} g (davon Zucker: ${n.sugar} g)<br>
                            Eiwei√ü: ${n.protein} g<br>
                            Salz: ${n.salt} g
                        `;
                    }
                    
                    if (recipe.traces) {
                        traces = `<div style="margin-bottom: 10px;"><strong>Hinweis:</strong> ${recipe.traces}</div>`;
                    }
                    
                    if (recipe.azo_dyes && recipe.azo_dyes.length > 0) {
                        azoWarning = `
                            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin: 10px 0; border-radius: 4px; font-size: 10px;">
                                <strong>‚ö†Ô∏è Enth√§lt Azofarbstoffe:</strong> ${recipe.azo_dyes.join(', ')}<br>
                                Kann Aktivit√§t und Aufmerksamkeit bei Kindern beeintr√§chtigen.
                            </div>
                        `;
                    }
                }
                
                // Highlight allergens
                const highlightedAllergens = Utils.highlightAllergens(allergens, 
                    recipe ? recipe.allergens : ['G', 'C']);
                
                labelPreview.innerHTML = `
                    <div class="label-title">MILCHEIS - ${flavor.toUpperCase()}</div>
                    <div style="text-align: center; margin-bottom: 15px; color: #666;">
                        Nettof√ºllmenge: <strong>${size} g</strong>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <strong>Zutaten:</strong> ${ingredients}.
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <strong>Allergene:</strong> ${highlightedAllergens}
                    </div>
                    
                    ${traces}
                    
                    ${azoWarning}
                    
                    <div style="margin-bottom: 12px;">
                        <strong>N√§hrwerte je 100 g:</strong><br>
                        ${nutrition}
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <strong>MHD:</strong> ${expiryFormatted}<br>
                        <strong>Charge:</strong> ${batch}
                    </div>
                    
                    <div style="border-top: 1px solid #ccc; padding-top: 10px; margin-top: 15px; font-size: 10px; color: #666;">
                        <strong>Aufbewahrung:</strong> Bei -18¬∞C lagern. Nach dem Auftauen nicht wieder einfrieren.<br>
                        <div style="text-align: center; margin-top: 5px;">
                            Eiscaf√© Sanremo ‚Ä¢ Bad Berleburg ‚Ä¢ Tel: 0176 72809926
                        </div>
                    </div>
                `;
                
                // Show warnings
                this.showLabelWarnings(recipe);
                
                Utils.showNotification('Etiketten-Vorschau aktualisiert', 'success');
            },
            
            showLabelWarnings(recipe) {
                const warningsContainer = document.getElementById('label-warnings-container');
                let warnings = [];
                
                if (recipe) {
                    if (recipe.azo_dyes && recipe.azo_dyes.length > 0) {
                        warnings.push({
                            type: 'warning',
                            message: `Enth√§lt Azofarbstoffe: ${recipe.azo_dyes.join(', ')}`
                        });
                    }
                    
                    if (recipe.traces) {
                        warnings.push({
                            type: 'info',
                            message: `Spurenhinweis: ${recipe.traces}`
                        });
                    }
                    
                    // Check for missing information
                    if (!recipe.nutrition) {
                        warnings.push({
                            type: 'danger',
                            message: 'N√§hrwertangaben fehlen'
                        });
                    }
                }
                
                if (warnings.length > 0) {
                    let warningsHTML = '';
                    warnings.forEach(warning => {
                        const alertClass = `alert-${warning.type}`;
                        warningsHTML += `
                            <div class="alert ${alertClass}">
                                <div class="alert-icon">
                                    <i class="fas fa-${warning.type === 'warning' ? 'exclamation-triangle' : warning.type === 'danger' ? 'times-circle' : 'info-circle'}"></i>
                                </div>
                                <div class="alert-content">${warning.message}</div>
                            </div>
                        `;
                    });
                    
                    warningsContainer.innerHTML = warningsHTML;
                } else {
                    warningsContainer.innerHTML = '';
                }
            },
            
            printLabel() {
                const labelContent = document.getElementById('label-preview-content').innerHTML;
                const printWindow = window.open('', '_blank');
                
                if (!printWindow) {
                    Utils.showNotification('Pop-up-Blocker aktiviert. Bitte erlauben Sie Pop-ups.', 'warning');
                    return;
                }
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Etikett drucken</title>
                        <style>
                            @media print {
                                @page {
                                    margin: 5mm;
                                    size: 90mm 140mm;
                                }
                                body {
                                    margin: 0;
                                    padding: 10mm;
                                    font-family: Arial, sans-serif;
                                    font-size: 11px;
                                    line-height: 1.4;
                                }
                                .label-title {
                                    text-align: center;
                                    font-weight: bold;
                                    font-size: 16px;
                                    margin-bottom: 10px;
                                    border-bottom: 2px solid #333;
                                    padding-bottom: 5px;
                                }
                                .allergen-bold {
                                    font-weight: bold;
                                    background-color: #ffebee;
                                    padding: 0 2px;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        ${labelContent}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
                
                // Save to history
                this.saveLabelToHistory();
            },
            
            printBatch() {
                Utils.showNotification('Batch-Druckfunktion in Entwicklung', 'info');
            },
            
            exportLabel() {
                const labelContent = document.getElementById('label-preview-content').innerHTML;
                const dataStr = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                font-size: 11px;
                                line-height: 1.4;
                                padding: 20px;
                                max-width: 500px;
                                margin: 0 auto;
                            }
                            .label-title {
                                text-align: center;
                                font-weight: bold;
                                font-size: 16px;
                                margin-bottom: 10px;
                                border-bottom: 2px solid #333;
                                padding-bottom: 5px;
                            }
                            .allergen-bold {
                                font-weight: bold;
                                background-color: #ffebee;
                                padding: 0 2px;
                            }
                        </style>
                    </head>
                    <body>
                        ${labelContent}
                    </body>
                    </html>
                `;
                
                const dataBlob = new Blob([dataStr], { type: 'text/html' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `etikett-${document.getElementById('label-flavor').value}-${new Date().toISOString().split('T')[0]}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                Utils.showNotification('Etikett exportiert', 'success');
            },
            
            saveLabelToHistory() {
                const flavor = document.getElementById('label-flavor').value;
                const size = document.getElementById('label-size').value;
                const batch = document.getElementById('label-batch').value;
                
                const labelRecord = {
                    id: DB.generateId(),
                    flavor,
                    size,
                    batch,
                    quantity: 1,
                    printed_at: new Date().toISOString()
                };
                
                const labels = DB.get(DB.KEYS.LABELS);
                labels.push(labelRecord);
                DB.set(DB.KEYS.LABELS, labels);
                
                this.loadRecentLabels();
            },
            
            loadRecentLabels() {
                const labels = DB.get(DB.KEYS.LABELS);
                const tbody = document.getElementById('recent-labels');
                
                if (!tbody) return;
                
                // Sort by date (newest first)
                labels.sort((a, b) => new Date(b.printed_at) - new Date(a.printed_at));
                
                tbody.innerHTML = '';
                
                // Show last 10 labels
                labels.slice(0, 10).forEach(label => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${Utils.formatDate(label.printed_at, true)}</td>
                        <td>${label.flavor}</td>
                        <td>${label.size} g</td>
                        <td>${label.batch}</td>
                        <td>${label.quantity}x</td>
                        <td>
                            <button class="btn btn-sm btn-outline reprint-label" data-id="${label.id}">
                                <i class="fas fa-print"></i> Erneut drucken
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(tr);
                });
                
                // Add event listeners
                this.addRecentLabelEventListeners();
            },
            
            addRecentLabelEventListeners() {
                // Reprint label
                document.querySelectorAll('.reprint-label').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const labelId = e.target.closest('button').getAttribute('data-id');
                        this.reprintLabel(labelId);
                    });
                });
            },
            
            reprintLabel(labelId) {
                const labels = DB.get(DB.KEYS.LABELS);
                const label = labels.find(l => l.id === labelId);
                
                if (label) {
                    // Set form values
                    document.getElementById('label-flavor').value = label.flavor;
                    document.getElementById('label-size').value = label.size;
                    document.getElementById('label-batch').value = label.batch;
                    
                    // Generate preview
                    this.generateLabelPreview();
                    
                    Utils.showNotification('Etikett zum erneuten Drucken vorbereitet', 'info');
                }
            }
        };

        // ===== DASHBOARD =====
        const Dashboard = {
            init() {
                this.updateStatistics();
                this.updateTime();
                
                // Update time every minute
                setInterval(() => this.updateTime(), 60000);
            },
            
            updateStatistics() {
                const orders = DB.get(DB.KEYS.ORDERS);
                const today = new Date().toISOString().split('T')[0];
                
                // Today's orders
                const todayOrders = orders.filter(o => o.date === today);
                document.getElementById('stat-today-orders').textContent = todayOrders.length;
                
                // Today's production
                let todayProduction = 0;
                todayOrders.forEach(order => {
                    todayProduction += order.total_kg || 0;
                });
                document.getElementById('stat-production-today').textContent = todayProduction.toFixed(1) + ' kg';
                
                // Recipe count
                const recipes = DB.getRecipes();
                document.getElementById('stat-recipes').textContent = recipes.length;
                
                // Labels printed today
                const labels = DB.get(DB.KEYS.LABELS);
                const todayLabels = labels.filter(l => 
                    new Date(l.printed_at).toISOString().split('T')[0] === today
                );
                document.getElementById('stat-labels-today').textContent = todayLabels.length;
            },
            
            updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('de-DE', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const timeElement = document.getElementById('current-time');
                if (timeElement) {
                    timeElement.textContent = timeString;
                }
            }
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize database
            DB.init();
            
            // Initialize view manager
            ViewManager.init();
            
            // Auto-save indicator
            let saveTimeout;
            document.addEventListener('input', () => {
                clearTimeout(saveTimeout);
                const status = document.getElementById('data-status');
                if (status) {
                    status.textContent = '√Ñnderungen...';
                    status.className = 'badge badge-warning';
                    
                    saveTimeout = setTimeout(() => {
                        status.textContent = 'Daten gespeichert';
                        status.className = 'badge badge-success';
                    }, 1000);
                }
            });
            
            // Initialize date inputs with today's date
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });
            
            console.log('Sanremo Eisproduktionssystem gestartet');
        });
    </script>
</body>
    </html>
