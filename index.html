
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bestellung REWE</title>
  <style>
    :root{
      --bg:#f3f4f6; --card:#fff; --text:#0f172a; --muted:#64748b;
      --line:#e5e7eb; --line2:#d1d5db; --accent:#2563eb;
      --ok:#16a34a; --danger:#dc2626; --warn:#f59e0b;
      --shadow:0 14px 40px rgba(15,23,42,.10);
      --r:16px; --r2:14px; --tap:46px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#f8fafc,#f3f4f6);color:var(--text)}
    header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);padding-top:env(safe-area-inset-top)}
    .wrap{max-width:1150px;margin:0 auto;padding:12px 14px}
    .head{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:18px;font-weight:900}
    .btn{min-height:var(--tap);display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px 14px;border-radius:var(--r2);border:1px solid var(--line2);background:#fff;color:var(--text);cursor:pointer;font-weight:900;font-size:13px;user-select:none;-webkit-tap-highlight-color:transparent}
    .btn:active{transform:scale(.985)}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn.warn{background:var(--warn);border-color:var(--warn);color:#111}
    .btn.small{min-height:38px;padding:8px 10px;font-size:12px;border-radius:12px}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{min-height:40px;padding:9px 12px;border:1px solid var(--line2);border-radius:999px;background:#fff;color:var(--text);cursor:pointer;font-weight:850;font-size:13px}
    .tab.active{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 10px 24px rgba(37,99,235,.18)}
    main{padding:16px 0 30px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:920px){.grid.two{grid-template-columns:1.08fr .92fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:14px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 10px;font-size:14px}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px;font-weight:800}
    input,select,textarea{width:100%;min-height:var(--tap);padding:12px 12px;border-radius:var(--r2);border:1px solid var(--line2);background:#fff;color:var(--text);outline:none;font-size:15px}
    textarea{min-height:92px;resize:vertical}
    .row{display:grid;gap:10px}
    .row.cols{grid-template-columns:1fr}
    @media(min-width:720px){.row.cols{grid-template-columns:1fr 1fr}}
    .flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted);font-size:12px}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line2);border-radius:999px;background:#fff;font-size:12px;color:var(--text);font-weight:900}
    .scroll{overflow:auto;-webkit-overflow-scrolling:touch;border-radius:var(--r2)}
    .maxH{max-height:520px}
    @media(max-width:520px){.maxH{max-height:52vh}}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:var(--r2);overflow:hidden;background:#fff}
    thead th{position:sticky;top:0;z-index:2;background:#f8fafc;color:#334155;text-align:left;font-size:12px;text-transform:uppercase;letter-spacing:.06em;border-bottom:1px solid var(--line);padding:10px}
    tbody td{padding:10px;border-bottom:1px solid var(--line);font-size:13px;vertical-align:top}
    tbody tr:last-child td{border-bottom:none}
    .right{text-align:right}
    .hidden{display:none!important}

    /* XL */
    .xlGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;margin-top:14px}
    .xlTile{border:2px solid var(--line2);border-radius:18px;background:#fff;box-shadow:0 10px 24px rgba(15,23,42,.08);padding:14px;min-height:170px;display:flex;flex-direction:column;justify-content:space-between}
    .xlFlavor{font-weight:1000;font-size:18px;line-height:1.15}
    .xlNumbers{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;margin-top:10px}
    .xlLeft{font-size:54px;font-weight:1100;letter-spacing:-1px}
    .xlMeta{text-align:right;color:var(--muted);font-weight:900;font-size:12px}
    .xlActions{display:flex;gap:10px;margin-top:12px}
    .xlBtn{flex:1;min-height:70px;border-radius:16px;border:2px solid var(--line2);background:#fff;font-weight:1000;font-size:18px;cursor:pointer;-webkit-tap-highlight-color:transparent}
    .xlBtn.plus{background:var(--ok);border-color:var(--ok);color:#fff}

    @media print{
      body{background:#fff;color:#000}
      header,.no-print{display:none!important}
      .print-area{display:block!important}
      .print-page{page-break-after:always;padding:14mm 12mm;font-family:Arial,Helvetica,sans-serif}
      .print-page:last-child{page-break-after:auto}
      .p-head{display:flex;justify-content:space-between;align-items:flex-start;gap:10mm}
      .p-title{font-size:18px;font-weight:800;margin:0}
      .p-sub{font-size:12px;margin-top:4px;color:#333}
      .p-box{border:1px solid #000;padding:10px;border-radius:8px}
      .p-table{width:100%;border-collapse:collapse;margin-top:8mm}
      .p-table th,.p-table td{border:1px solid #000;padding:7px;font-size:12px;vertical-align:top}
      .p-table th{background:#f2f2f2}
      .p-pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:6mm}
      .p-pill{border:1px solid #000;padding:6px 8px;border-radius:999px;font-size:12px}
      .small{font-size:11px;color:#333}
      .sign{margin-top:10mm;display:flex;gap:12mm}
      .line{flex:1;border-bottom:1px solid #000;height:18px}
    }
  </style>
</head>
<body>
<header class="no-print">
  <div class="wrap">
    <div class="head">
      <h1>Bestellung REWE</h1>
      <div class="flex">
        <a class="btn small" href="./rezepte_naehrwerte.html">Rezepte & Nährwerte</a>
        <a class="btn small" href="./etiketten.html">Etiketten</a>
      </div>
    </div>
    <nav>
      <button class="tab active" data-view="bestellung">Bestellung</button>
      <button class="tab" data-view="produktion">Produktion</button>
      <button class="tab" data-view="xl">Produktion XL</button>
      <button class="tab" data-view="plan">Baldes-Plan</button>
      <button class="tab" data-view="statistik">Statistik</button>
      <button class="tab" data-view="kunden">Kunden</button>
      <button class="tab" data-view="sorten">Sorten</button>
      <button class="tab" data-view="history">Historie</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- BESTELLUNG -->
  <section id="view-bestellung" class="grid two">
    <div class="card">
      <h2>Neue Bestellung</h2>
      <div class="row cols">
        <div>
          <label>Kunde (Supermarkt)</label>
          <select id="orderCustomer"></select>
        </div>
        <div>
          <label>Lieferdatum</label>
          <input type="date" id="orderDate" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="flex">
        <button class="btn primary" id="addLine">+ Position</button>
        <button class="btn" id="clearOrder">Leeren</button>
        <span id="saveHint" class="muted"></span>
      </div>

      <div class="hr"></div>

      <div class="scroll maxH" style="border:1px solid var(--line);">
        <table>
          <thead>
            <tr>
              <th style="width:120px;">Größe</th>
              <th>Sorte</th>
              <th style="width:150px;" class="right">Menge (0–100)</th>
              <th style="width:90px;" class="right">Aktion</th>
            </tr>
          </thead>
          <tbody id="linesTbody"></tbody>
        </table>
      </div>

      <div class="hr"></div>
      <div class="flex">
        <span class="pill" id="ord_flavors">Sorten: 0</span>
        <span class="pill" id="ord_750">750g: 0</span>
        <span class="pill" id="ord_170">170g: 0</span>
        <span class="pill" id="ord_total">Total: 0</span>
      </div>

      <div class="hr"></div>
      <label>Notizen (optional)</label>
      <textarea id="orderNotes" placeholder="z.B. bitte bis 09:00 liefern, Hintereingang..."></textarea>

      <div class="flex" style="margin-top:12px;">
        <button class="btn ok" id="saveOrder">Speichern</button>
        <button class="btn" id="printProduktion">Drucken: Produktion</button>
        <button class="btn" id="printLieferschein">Drucken: Lieferschein</button>
        <button class="btn" id="printPicklist">Drucken: Pick-List</button>
        <button class="btn" id="printPlan">Drucken: Baldes-Plan</button>
      </div>
    </div>

    <div class="card">
      <h2>Produktion – Überblick (Datum)</h2>
      <div class="flex">
        <span class="pill" id="tot750">750g: 0</span>
        <span class="pill" id="tot170">170g: 0</span>
        <span class="pill" id="totAll">Total: 0</span>
        <span class="pill" id="totKg">KG: 0</span>
        <span class="pill" id="totBuckets">Baldes: 0</span>
      </div>
      <div class="hr"></div>
      <div class="scroll maxH" style="border:1px solid var(--line);">
        <table>
          <thead>
            <tr>
              <th>Sorte</th>
              <th class="right">750g</th>
              <th class="right">170g</th>
              <th class="right">KG</th>
              <th class="right">Baldes</th>
              <th class="right">Baldes (fazer)</th>
            </tr>
          </thead>
          <tbody id="prodTbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- PRODUKTION -->
  <section id="view-produktion" class="grid hidden">
    <div class="card">
      <h2>Produktion – Datum wählen</h2>
      <div class="row cols">
        <div>
          <label>Datum</label>
          <input type="date" id="prodDate" />
        </div>
        <div class="flex" style="align-items:end;">
          <button class="btn primary" id="prodRefresh">Aktualisieren</button>
          <button class="btn" id="prodPrint">Drucken: Produktion</button>
          <button class="btn" id="prodPick">Drucken: Pick-List</button>
          <button class="btn" id="prodPlan">Drucken: Baldes-Plan</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="flex">
        <span class="pill" id="p_tot750">750g: 0</span>
        <span class="pill" id="p_tot170">170g: 0</span>
        <span class="pill" id="p_totAll">Total: 0</span>
        <span class="pill" id="p_totKg">KG: 0</span>
        <span class="pill" id="p_totBuckets">Baldes: 0</span>
      </div>
      <div class="hr"></div>
      <div class="scroll maxH" style="border:1px solid var(--line);">
        <table>
          <thead>
            <tr>
              <th>Sorte</th>
              <th class="right">750g</th>
              <th class="right">170g</th>
              <th class="right">KG</th>
              <th class="right">Baldes</th>
              <th class="right">Baldes (fazer)</th>
            </tr>
          </thead>
          <tbody id="prodTbody2"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- XL -->
  <section id="view-xl" class="grid hidden">
    <div class="card">
      <div class="flex" style="justify-content:space-between;align-items:end;">
        <div>
          <h2 style="margin:0 0 6px;">Produktion XL (Luvas)</h2>
          <div class="muted">1 toque em “+1” = 1 balde (6kg) feito</div>
        </div>
        <div style="min-width:240px;">
          <label>Datum</label>
          <input type="date" id="xlDate" />
        </div>
        <div class="flex">
          <button class="btn primary" id="xlRefresh">Anzeigen</button>
          <button class="btn danger" id="xlReset">Reset (dia)</button>
        </div>
      </div>

      <div class="hr"></div>
      <div class="flex">
        <span class="pill" id="xl_totKg">KG: 0</span>
        <span class="pill" id="xl_totBuckets">Baldes: 0</span>
        <span class="pill" id="xl_done">Feitos: 0</span>
        <span class="pill" id="xl_left">Faltam: 0</span>
      </div>

      <div class="xlGrid" id="xlGrid"></div>
    </div>
  </section>

  <!-- PLAN -->
  <section id="view-plan" class="grid hidden">
    <div class="card">
      <h2>Baldes-Plan (6kg)</h2>
      <div class="row cols">
        <div>
          <label>Datum</label>
          <input type="date" id="planDate" />
        </div>
        <div class="flex" style="align-items:end;">
          <button class="btn primary" id="planRefresh">Anzeigen</button>
          <button class="btn" id="planPrint">Drucken: Baldes-Plan</button>
          <button class="btn danger" id="planReset">Reset (dia)</button>
        </div>
      </div>

      <div class="hr"></div>
      <div class="flex">
        <span class="pill" id="plan_totKg">KG: 0</span>
        <span class="pill" id="plan_totBuckets">Baldes: 0</span>
        <span class="pill" id="plan_done">Feitos: 0</span>
        <span class="pill" id="plan_left">Faltam: 0</span>
      </div>

      <div class="hr"></div>
      <div class="scroll maxH" style="border:1px solid var(--line);">
        <table>
          <thead>
            <tr>
              <th>Sorte</th>
              <th class="right">KG</th>
              <th class="right">Baldes (fazer)</th>
              <th class="right">Feitos</th>
              <th class="right">Faltam</th>
              <th class="right">Aktion</th>
            </tr>
          </thead>
          <tbody id="planBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- STATISTIK -->
  <section id="view-statistik" class="grid two hidden">
    <div class="card">
      <h2>Statistik – Monat (nur gedruckt)</h2>
      <div class="row cols">
        <div><label>Monat</label><input type="month" id="statMonth"></div>
        <div class="flex" style="align-items:end;"><button class="btn primary" id="statMonthRefresh">Anzeigen</button></div>
      </div>
      <div class="hr"></div>
      <div class="flex">
        <span class="pill" id="sm_tot750">750g: 0</span>
        <span class="pill" id="sm_tot170">170g: 0</span>
        <span class="pill" id="sm_totAll">Total: 0</span>
        <span class="pill" id="sm_totKg">KG: 0</span>
        <span class="pill" id="sm_totBuckets">Baldes: 0</span>
      </div>
      <div class="hr"></div>
      <div class="scroll maxH" style="border:1px solid var(--line);">
        <table>
          <thead><tr><th>Sorte</th><th class="right">750g</th><th class="right">170g</th><th class="right">KG</th><th class="right">Baldes</th><th class="right">Baldes (fazer)</th></tr></thead>
          <tbody id="statMonthBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>Statistik – Jahr (nur gedruckt)</h2>
      <div class="row cols">
        <div><label>Jahr</label><input type="number" id="statYear" min="2020" step="1"></div>
        <div class="flex" style="align-items:end;"><button class="btn primary" id="statYearRefresh">Anzeigen</button></div>
      </div>
      <div class="hr"></div>
      <div class="flex">
        <span class="pill" id="sy_tot750">750g: 0</span>
        <span class="pill" id="sy_tot170">170g: 0</span>
        <span class="pill" id="sy_totAll">Total: 0</span>
        <span class="pill" id="sy_totKg">KG: 0</span>
        <span class="pill" id="sy_totBuckets">Baldes: 0</span>
      </div>
      <div class="hr"></div>
      <div class="scroll maxH" style="border:1px solid var(--line);">
        <table>
          <thead><tr><th>Sorte</th><th class="right">750g</th><th class="right">170g</th><th class="right">KG</th><th class="right">Baldes</th><th class="right">Baldes (fazer)</th></tr></thead>
          <tbody id="statYearBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- KUNDEN -->
  <section id="view-kunden" class="grid two hidden">
    <div class="card">
      <h2>Kunden</h2>
      <div class="row cols">
        <div><label>Name</label><input id="newCustomerName" placeholder="z.B. REWE Bad Berleburg"></div>
        <div><label>Zusatz (optional)</label><input id="newCustomerNote" placeholder="z.B. Filiale, Ansprechpartner..."></div>
      </div>
      <div class="flex" style="margin-top:10px;">
        <button class="btn ok" id="addCustomer">Hinzufügen</button>
      </div>
    </div>
    <div class="card">
      <h2>Liste</h2>
      <div class="scroll maxH" style="border:1px solid var(--line); padding:10px;">
        <div id="customersList"></div>
      </div>
    </div>
  </section>

  <!-- SORTEN -->
  <section id="view-sorten" class="grid two hidden">
    <div class="card">
      <h2>Sorten</h2>
      <div class="row cols">
        <div><label>Neue Sorte</label><input id="newFlavor" placeholder="z.B. Haselnuss, Zitrone..."></div>
        <div class="flex" style="align-items:end;">
          <button class="btn ok" id="addFlavor">Hinzufügen</button>
          <button class="btn" id="resetDefaults">Standard</button>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>Liste</h2>
      <div class="scroll maxH" style="border:1px solid var(--line); padding:10px;">
        <div id="flavorsList"></div>
      </div>
    </div>
  </section>

  <!-- HISTORIE -->
  <section id="view-history" class="grid hidden">
    <div class="card">
      <h2>Historie</h2>
      <div class="row cols">
        <div><label>Suche</label><input id="historySearch" placeholder="REWE oder 2025-12-16"></div>
        <div class="flex" style="align-items:end;">
          <button class="btn primary" id="historyRefresh">Aktualisieren</button>
          <button class="btn danger" id="deleteAll">Alle löschen</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="scroll maxH" style="border:1px solid var(--line); padding:10px;">
        <div id="historyList"></div>
      </div>
    </div>
  </section>

  <!-- PRINT -->
  <section class="print-area hidden" id="printArea"></section>
</main>

<script>
(() => {
  // ===== Shared DB (used by ALL 3 files)
  const DB_KEY = "SANREMO_DB_V1";
  const PROG_KEY = "SANREMO_BUCKET_PROGRESS_V1";

  // ===== constants
  const KG_750 = 0.75, KG_170 = 0.17, BUCKET_KG = 6;

  const defaultFlavors = [
    "Stracciatella","Amarena Kirsch","Vanille","Spaghetti","Toffifee","Cookies",
    "Weiß Schokolade Pistazien","Erdbeer","Joghurt Orange","Kinder Buenos",
    "Kinder Riegel","Joghurete Schokolade","Mango","Hanutta"
  ];
  const defaultCustomers = [
    { id: uid(), name: "REWE", note: "" },
    { id: uid(), name: "EDEKA", note: "" }
  ];

  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  function num(x){ const n=Number(x); return isFinite(n)?n:0; }
  function esc(s){ return String(s).replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

  function loadDB(){
    try{
      const raw = localStorage.getItem(DB_KEY);
      if(raw){
        const db = JSON.parse(raw);
        if(db && typeof db==="object") return db;
      }
    }catch(e){}
    return { flavors:[...defaultFlavors], customers:[...defaultCustomers], orders:[], ingredients:[], recipes:{} };
  }
  function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
  function loadProg(){ try{return JSON.parse(localStorage.getItem(PROG_KEY)||"{}");}catch(e){return {}} }
  function saveProg(o){ localStorage.setItem(PROG_KEY, JSON.stringify(o)); }
  function getProg(date){ const all=loadProg(); return all[date]||{}; }
  function setProg(date,p){ const all=loadProg(); all[date]=p; saveProg(all); }
  function resetProg(date){ const all=loadProg(); delete all[date]; saveProg(all); }

  function setTodayIfEmpty(el){
    if(!el || el.value) return;
    const d=new Date(); const tzOff=d.getTimezoneOffset()*60000;
    el.value=new Date(Date.now()-tzOff).toISOString().slice(0,10);
  }
  function setCurrentMonthIfEmpty(el){
    if(!el || el.value) return;
    const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,"0");
    el.value=`${y}-${m}`;
  }

  let db = loadDB();
  db.flavors = Array.isArray(db.flavors)&&db.flavors.length ? db.flavors : [...defaultFlavors];
  db.customers = Array.isArray(db.customers)&&db.customers.length ? db.customers : [...defaultCustomers];
  db.orders = Array.isArray(db.orders) ? db.orders : [];
  db.recipes = db.recipes && typeof db.recipes==="object" ? db.recipes : {};
  saveDB(db);

  function customerName(id){
    const c=db.customers.find(x=>x.id===id);
    return c ? (c.note?`${c.name} – ${c.note}`:c.name) : "Unbekannt";
  }

  // ===== Tabs
  function renderTabs(active){
    $$(".tab").forEach(b=>b.classList.toggle("active", b.dataset.view===active));
    $$("main section[id^='view-']").forEach(sec=>sec.classList.add("hidden"));
    $("#view-"+active).classList.remove("hidden");
  }

  // ===== qty 0..100
  function qtyOptions(selected){
    let out="";
    for(let i=0;i<=100;i++) out += `<option value="${i}" ${i===selected?"selected":""}>${i}</option>`;
    return out;
  }

  // ===== Customers
  function renderCustomers(){
    const sel=$("#orderCustomer"); sel.innerHTML="";
    db.customers.forEach(c=>{
      const o=document.createElement("option");
      o.value=c.id; o.textContent=c.note?`${c.name} – ${c.note}`:c.name;
      sel.appendChild(o);
    });
    const rewe=db.customers.find(c=>c.name.toLowerCase().includes("rewe"));
    if(rewe) sel.value=rewe.id;

    const box=$("#customersList"); box.innerHTML="";
    db.customers.forEach(c=>{
      const div=document.createElement("div");
      div.className="card"; div.style.marginBottom="10px"; div.style.boxShadow="none";
      div.innerHTML=`
        <div class="flex" style="justify-content:space-between;">
          <div>
            <div style="font-weight:950;">${esc(c.name)}</div>
            <div class="muted">${esc(c.note||"")}</div>
          </div>
          <button class="btn small danger" data-del-customer="${c.id}">Löschen</button>
        </div>`;
      box.appendChild(div);
    });
    $$("[data-del-customer]").forEach(btn=>{
      btn.onclick=()=>{
        const id=btn.getAttribute("data-del-customer");
        const used=db.orders.some(o=>o.customerId===id);
        if(used && !confirm("Dieser Kunde hat Bestellungen. Trotzdem löschen?")) return;
        db.customers=db.customers.filter(c=>c.id!==id);
        saveDB(db); renderAll();
      };
    });
  }

  $("#addCustomer").onclick=()=>{
    const name=$("#newCustomerName").value.trim();
    const note=$("#newCustomerNote").value.trim();
    if(!name) return;
    db.customers.push({id:uid(), name, note});
    $("#newCustomerName").value=""; $("#newCustomerNote").value="";
    saveDB(db); renderAll();
  };

  // ===== Flavors
  function renderFlavors(){
    const box=$("#flavorsList"); box.innerHTML="";
    db.flavors.forEach((f,idx)=>{
      const row=document.createElement("div");
      row.className="flex"; row.style.justifyContent="space-between";
      row.innerHTML=`<span class="pill" style="font-weight:950;">${esc(f)}</span>
                     <button class="btn small danger" data-del-flavor="${idx}">Entfernen</button>`;
      box.appendChild(row);
    });
    $$("[data-del-flavor]").forEach(btn=>{
      btn.onclick=()=>{
        const i=Number(btn.getAttribute("data-del-flavor"));
        const fname=db.flavors[i];
        if(db.recipes && db.recipes[fname] && !confirm("Diese Sorte hat ein Rezept gespeichert. Sorte & Rezept löschen?")) return;
        if(db.recipes && db.recipes[fname]) delete db.recipes[fname];
        db.flavors.splice(i,1);
        saveDB(db); renderAll();
      };
    });
  }

  $("#addFlavor").onclick=()=>{
    const v=$("#newFlavor").value.trim();
    if(!v) return;
    if(db.flavors.map(x=>x.toLowerCase()).includes(v.toLowerCase())){ $("#newFlavor").value=""; return; }
    db.flavors.push(v); $("#newFlavor").value="";
    saveDB(db); renderAll();
  };
  $("#resetDefaults").onclick=()=>{
    db.flavors=[...defaultFlavors];
    saveDB(db); renderAll();
  };

  // ===== Orders UI
  let currentLines=[];
  function addLine(size="750g", flavor=null, qty=0){
    currentLines.push({ size, flavor: flavor || (db.flavors[0]||""), qty });
    renderLines();
  }
  function renderLines(){
    const tb=$("#linesTbody"); tb.innerHTML="";
    currentLines.forEach((ln,idx)=>{
      const tr=document.createElement("tr");

      const sizeSel=document.createElement("select");
      sizeSel.innerHTML=`<option value="750g">750g</option><option value="170g">170g</option>`;
      sizeSel.value=ln.size;
      sizeSel.onchange=()=>{ ln.size=sizeSel.value; refreshDraftSummary(); };

      const flSel=document.createElement("select");
      flSel.innerHTML=db.flavors.map(f=>`<option value="${esc(f)}">${esc(f)}</option>`).join("");
      flSel.value=ln.flavor;
      flSel.onchange=()=>{ ln.flavor=flSel.value; refreshDraftSummary(); };

      const qSel=document.createElement("select");
      qSel.innerHTML=qtyOptions(Number(ln.qty||0));
      qSel.value=String(Number(ln.qty||0));
      qSel.onchange=()=>{ ln.qty=Number(qSel.value||0); refreshDraftSummary(); };

      const del=document.createElement("button");
      del.className="btn small danger"; del.textContent="X";
      del.onclick=()=>{ currentLines.splice(idx,1); renderLines(); };

      tr.innerHTML=`<td></td><td></td><td class="right"></td><td class="right"></td>`;
      tr.children[0].appendChild(sizeSel);
      tr.children[1].appendChild(flSel);
      tr.children[2].appendChild(qSel);
      tr.children[3].appendChild(del);
      tb.appendChild(tr);
    });
    refreshDraftSummary();
  }

  $("#addLine").onclick=()=>addLine("750g", db.flavors[0]||"", 0);
  $("#clearOrder").onclick=()=>{ currentLines=[]; $("#orderNotes").value=""; renderLines(); };

  $("#saveOrder").onclick=()=>{
    const customerId=$("#orderCustomer").value;
    const date=$("#orderDate").value;
    const notes=$("#orderNotes").value.trim();
    const lines=currentLines.filter(l=>l.flavor && Number(l.qty)>0).map(l=>({size:l.size, flavor:l.flavor, qty:Number(l.qty)}));
    if(!customerId || !date || lines.length===0){ $("#saveHint").textContent="Bitte Kunde, Datum und mindestens 1 Position eingeben."; return; }
    db.orders.push({ id:uid(), date, customerId, notes, lines, countedAt:null });
    saveDB(db);
    $("#saveHint").textContent="Gespeichert ✅"; setTimeout(()=>$("#saveHint").textContent="",1200);
    currentLines=[]; $("#orderNotes").value=""; renderLines();
    renderHistory(); refreshOverviewAll(); refreshStatsTables(); renderPlan(); renderXL();
  };

  function ordersByDate(date){ return db.orders.filter(o=>o.date===date); }

  // ===== Calc production
  function calcProduction(orders){
    const map=new Map(); let t750=0,t170=0;
    orders.forEach(o=>{
      o.lines.forEach(l=>{
        const key=l.flavor;
        if(!map.has(key)) map.set(key,{f:key,g750:0,g170:0});
        const r=map.get(key);
        if(l.size==="750g"){ r.g750+=l.qty; t750+=l.qty; }
        if(l.size==="170g"){ r.g170+=l.qty; t170+=l.qty; }
      });
    });
    const rows=[...map.values()].map(r=>{
      const kg=(r.g750*KG_750)+(r.g170*KG_170);
      const bucketsExact=kg/BUCKET_KG;
      return {
        ...r,
        total:r.g750+r.g170,
        kg:Math.round(kg*100)/100,
        bucketsExact:Math.round(bucketsExact*100)/100,
        bucketsToMake:Math.ceil(bucketsExact)
      };
    }).sort((a,b)=>(b.kg-a.kg)||(b.total-a.total)||a.f.localeCompare(b.f));
    const totalKg=rows.reduce((s,r)=>s+r.kg,0);
    const totalBucketsExact=totalKg/BUCKET_KG;
    return {
      rows, t750, t170, total:t750+t170,
      totalKg:Math.round(totalKg*100)/100,
      totalBucketsExact:Math.round(totalBucketsExact*100)/100,
      totalBucketsToMake:Math.ceil(totalBucketsExact)
    };
  }

  function refreshOverviewAll(){
    const date=$("#orderDate").value || $("#prodDate").value;
    if(!date) return;
    const prod=calcProduction(ordersByDate(date));

    $("#tot750").textContent=`750g: ${prod.t750}`;
    $("#tot170").textContent=`170g: ${prod.t170}`;
    $("#totAll").textContent=`Total: ${prod.total}`;
    $("#totKg").textContent=`KG: ${prod.totalKg.toFixed(2)}`;
    $("#totBuckets").textContent=`Baldes: ${prod.totalBucketsExact.toFixed(2)} (~${prod.totalBucketsToMake})`;

    $("#p_tot750").textContent=`750g: ${prod.t750}`;
    $("#p_tot170").textContent=`170g: ${prod.t170}`;
    $("#p_totAll").textContent=`Total: ${prod.total}`;
    $("#p_totKg").textContent=`KG: ${prod.totalKg.toFixed(2)}`;
    $("#p_totBuckets").textContent=`Baldes: ${prod.totalBucketsExact.toFixed(2)} (~${prod.totalBucketsToMake})`;

    const rowsHtml = prod.rows.map(r=>`
      <tr>
        <td>${esc(r.f)}</td>
        <td class="right">${r.g750}</td>
        <td class="right">${r.g170}</td>
        <td class="right">${r.kg.toFixed(2)}</td>
        <td class="right">${r.bucketsExact.toFixed(2)}</td>
        <td class="right"><b>${r.bucketsToMake}</b></td>
      </tr>
    `).join("") || `<tr><td colspan="6" class="muted">Keine Bestellungen für dieses Datum.</td></tr>`;

    $("#prodTbody").innerHTML=rowsHtml;
    $("#prodTbody2").innerHTML=rowsHtml;

    renderPlan();
    renderXL();
  }

  function refreshDraftSummary(){
    let t750=0,t170=0; const flavors=new Set();
    currentLines.forEach(l=>{
      const q=Number(l.qty)||0;
      if(q>0 && l.flavor) flavors.add(l.flavor);
      if(l.size==="750g") t750+=q;
      if(l.size==="170g") t170+=q;
    });
    $("#ord_flavors").textContent=`Sorten: ${flavors.size}`;
    $("#ord_750").textContent=`750g: ${t750}`;
    $("#ord_170").textContent=`170g: ${t170}`;
    $("#ord_total").textContent=`Total: ${t750+t170}`;
    refreshOverviewAll();
  }

  $("#prodRefresh").onclick=()=>refreshOverviewAll();
  $("#orderDate").onchange=()=>refreshOverviewAll();
  $("#prodDate").onchange=()=>refreshOverviewAll();

  // ===== Counting only when printing
  function markCounted(date){
    const now=new Date().toISOString();
    ordersByDate(date).forEach(o=>{ if(!o.countedAt) o.countedAt=now; });
    saveDB(db);
    renderHistory();
    refreshStatsTables();
  }

  function companyBlock(){
    return `<div class="p-box"><div style="font-weight:800;">Eiscafé Sanremo</div>
      <div class="small">Bad Berleburg</div><div class="small">Tel.: 0176 72809926</div></div>`;
  }
  function printPills(prod){
    return `<div class="p-pills">
      <div class="p-pill">750g: <b>${prod.t750}</b></div>
      <div class="p-pill">170g: <b>${prod.t170}</b></div>
      <div class="p-pill">Total: <b>${prod.total}</b></div>
      <div class="p-pill">KG: <b>${prod.totalKg.toFixed(2)}</b></div>
      <div class="p-pill">Baldes: <b>${prod.totalBucketsExact.toFixed(2)}</b> (~<b>${prod.totalBucketsToMake}</b>)</div>
    </div>`;
  }

  function doPrint(html){
    $("#printArea").innerHTML=html;
    $("#printArea").classList.remove("hidden");
    window.print();
    $("#printArea").classList.add("hidden");
  }

  function printProduktion(date){
    if(!date) return alert("Bitte Datum wählen.");
    const list=ordersByDate(date);
    if(!list.length) return alert("Keine Bestellungen für dieses Datum.");
    markCounted(date);
    const prod=calcProduction(list);
    doPrint(`
      <div class="print-page">
        <div class="p-head">
          <div><h2 class="p-title">Produktion – ${esc(date)}</h2><div class="p-sub">Nach Sorte + KG + Baldes (6kg)</div></div>
          ${companyBlock()}
        </div>
        ${printPills(prod)}
        <table class="p-table">
          <thead><tr><th>Sorte</th><th>750g</th><th>170g</th><th>KG</th><th>Baldes</th><th>Baldes (fazer)</th></tr></thead>
          <tbody>${prod.rows.map(r=>`
            <tr><td>${esc(r.f)}</td><td>${r.g750}</td><td>${r.g170}</td><td>${r.kg.toFixed(2)}</td><td>${r.bucketsExact.toFixed(2)}</td><td><b>${r.bucketsToMake}</b></td></tr>
          `).join("")}</tbody>
        </table>
      </div>
    `);
  }

  function printLieferschein(date){
    if(!date) return alert("Bitte Datum wählen.");
    const list=ordersByDate(date);
    if(!list.length) return alert("Keine Bestellungen für dieses Datum.");
    markCounted(date);

    const pages=list.map(o=>{
      const prod=calcProduction([o]);
      return `
        <div class="print-page">
          <div class="p-head">
            <div><h2 class="p-title">Lieferschein (ohne Preise)</h2><div class="p-sub">Datum: <b>${esc(o.date)}</b></div></div>
            ${companyBlock()}
          </div>
          <div style="margin-top:8mm;display:grid;grid-template-columns:1fr 1fr;gap:10mm;">
            <div class="p-box"><b>Kunde</b><div style="margin-top:6px;">${esc(customerName(o.customerId))}</div></div>
            <div class="p-box"><b>Notizen</b><div style="margin-top:6px;">${esc(o.notes||"-")}</div></div>
          </div>
          ${printPills(prod)}
          <table class="p-table">
            <thead><tr><th>Größe</th><th>Sorte</th><th>Menge</th></tr></thead>
            <tbody>${o.lines.map(l=>`<tr><td>${esc(l.size)}</td><td>${esc(l.flavor)}</td><td><b>${l.qty}</b></td></tr>`).join("")}</tbody>
          </table>
          <div class="sign">
            <div style="flex:1;"><div class="small">Unterschrift Kunde</div><div class="line"></div></div>
            <div style="flex:1;"><div class="small">Unterschrift Lieferant</div><div class="line"></div></div>
          </div>
        </div>`;
    }).join("");

    doPrint(pages);
  }

  function summarizeByFlavor(orders){
    const map=new Map();
    orders.forEach(o=>{
      o.lines.forEach(l=>{
        if(!map.has(l.flavor)) map.set(l.flavor,{f:l.flavor,g750:0,g170:0});
        const r=map.get(l.flavor);
        if(l.size==="750g") r.g750+=num(l.qty);
        if(l.size==="170g") r.g170+=num(l.qty);
      });
    });
    return [...map.values()].map(r=>{
      const kg=(r.g750*KG_750)+(r.g170*KG_170);
      const bucketsExact=kg/BUCKET_KG;
      return {...r,total:r.g750+r.g170,kg:Math.round(kg*100)/100,bucketsExact:Math.round(bucketsExact*100)/100,bucketsToMake:Math.ceil(bucketsExact)};
    }).sort((a,b)=>(b.kg-a.kg)||(b.total-a.total)||a.f.localeCompare(b.f));
  }
  function totalsFromRows(rows){
    const t750=rows.reduce((s,r)=>s+r.g750,0);
    const t170=rows.reduce((s,r)=>s+r.g170,0);
    const total=t750+t170;
    const totalKg=rows.reduce((s,r)=>s+r.kg,0);
    const totalBucketsExact=totalKg/BUCKET_KG;
    return {t750,t170,total,totalKg:Math.round(totalKg*100)/100,totalBucketsExact:Math.round(totalBucketsExact*100)/100,totalBucketsToMake:Math.ceil(totalBucketsExact)};
  }

  function printPickList(date){
    if(!date) return alert("Bitte Datum wählen.");
    const list=ordersByDate(date);
    if(!list.length) return alert("Keine Bestellungen für dieses Datum.");
    markCounted(date);

    const allRows=summarizeByFlavor(list);
    const allTot=totalsFromRows(allRows);

    const table=(rows)=>`
      <table class="p-table">
        <thead><tr><th>Sorte</th><th>750g</th><th>170g</th><th>KG</th><th>Baldes</th><th>Baldes (fazer)</th></tr></thead>
        <tbody>${rows.map(r=>`<tr><td>${esc(r.f)}</td><td>${r.g750}</td><td>${r.g170}</td><td>${r.kg.toFixed(2)}</td><td>${r.bucketsExact.toFixed(2)}</td><td><b>${r.bucketsToMake}</b></td></tr>`).join("")}</tbody>
      </table>`;

    const general=`
      <div class="print-page">
        <div class="p-head">
          <div><h2 class="p-title">Pick-List (Gesamt) – ${esc(date)}</h2><div class="p-sub">Nach Sorte + KG + Baldes</div></div>
          ${companyBlock()}
        </div>
        ${printPills(allTot)}
        ${table(allRows)}
      </div>`;

    const perCustomer=list.map(o=>{
      const rows=summarizeByFlavor([o]);
      const tot=totalsFromRows(rows);
      return `
        <div class="print-page">
          <div class="p-head">
            <div><h2 class="p-title">Pick-List – ${esc(date)}</h2><div class="p-sub">Kunde: <b>${esc(customerName(o.customerId))}</b></div></div>
            ${companyBlock()}
          </div>
          ${printPills(tot)}
          ${table(rows)}
          <div style="margin-top:8mm;" class="small">Notizen: ${esc(o.notes||"-")}</div>
        </div>`;
    }).join("");

    doPrint(general + perCustomer);
  }

  function printPlan(date){
    if(!date) return alert("Bitte Datum wählen.");
    const list=ordersByDate(date);
    if(!list.length) return alert("Keine Bestellungen für dieses Datum.");
    markCounted(date);
    const prod=calcProduction(list);
    const rows=prod.rows.filter(r=>r.bucketsToMake>0).sort((a,b)=>(b.bucketsToMake-a.bucketsToMake)||(b.kg-a.kg)||a.f.localeCompare(b.f));
    const body=rows.map(r=>{
      const checks=Array.from({length:Math.min(r.bucketsToMake,20)},()=> "☐").join(" ");
      return `<tr><td><b>${esc(r.f)}</b></td><td class="right">${r.kg.toFixed(2)}</td><td class="right"><b>${r.bucketsToMake}</b></td><td style="font-size:14px;">${checks}</td></tr>`;
    }).join("") || `<tr><td colspan="4">Keine Daten</td></tr>`;

    doPrint(`
      <div class="print-page">
        <div class="p-head">
          <div><h2 class="p-title">Baldes-Plan (6kg) – ${esc(date)}</h2><div class="p-sub">Planeamento por sabor</div></div>
          ${companyBlock()}
        </div>
        ${printPills(prod)}
        <table class="p-table">
          <thead><tr><th>Sorte</th><th>KG</th><th>Baldes (fazer)</th><th>Check</th></tr></thead>
          <tbody>${body}</tbody>
        </table>
      </div>
    `);
  }

  $("#printProduktion").onclick=()=>printProduktion($("#orderDate").value);
  $("#printLieferschein").onclick=()=>printLieferschein($("#orderDate").value);
  $("#printPicklist").onclick=()=>printPickList($("#orderDate").value);
  $("#printPlan").onclick=()=>printPlan($("#orderDate").value);

  $("#prodPrint").onclick=()=>printProduktion($("#prodDate").value);
  $("#prodPick").onclick=()=>printPickList($("#prodDate").value);
  $("#prodPlan").onclick=()=>printPlan($("#prodDate").value);

  // ===== Baldes-Plan screen (progress)
  function renderPlan(){
    const date=$("#planDate").value;
    if(!date) return;

    const list=ordersByDate(date);
    const tbody=$("#planBody");
    if(!list.length){
      tbody.innerHTML=`<tr><td colspan="6" class="muted">Keine Bestellungen für dieses Datum.</td></tr>`;
      $("#plan_totKg").textContent="KG: 0";
      $("#plan_totBuckets").textContent="Baldes: 0";
      $("#plan_done").textContent="Feitos: 0";
      $("#plan_left").textContent="Faltam: 0";
      return;
    }

    const prod=calcProduction(list);
    const progress=getProg(date);
    const rows=prod.rows.filter(r=>r.bucketsToMake>0).sort((a,b)=>(b.bucketsToMake-a.bucketsToMake)||(b.kg-a.kg)||a.f.localeCompare(b.f));

    let totalToMake=0,totalDone=0;
    tbody.innerHTML=rows.map(r=>{
      const done=Math.max(0,Math.min(r.bucketsToMake, num(progress[r.f]||0)));
      const left=Math.max(0,r.bucketsToMake-done);
      totalToMake+=r.bucketsToMake; totalDone+=done;
      return `
        <tr>
          <td><b>${esc(r.f)}</b></td>
          <td class="right">${r.kg.toFixed(2)}</td>
          <td class="right"><b>${r.bucketsToMake}</b></td>
          <td class="right">${done}</td>
          <td class="right"><b>${left}</b></td>
          <td class="right">
            <button class="btn small ok" data-done="${esc(r.f)}">+1</button>
            <button class="btn small" data-undo="${esc(r.f)}">-1</button>
          </td>
        </tr>`;
    }).join("");

    const totalLeft=Math.max(0,totalToMake-totalDone);
    $("#plan_totKg").textContent=`KG: ${prod.totalKg.toFixed(2)}`;
    $("#plan_totBuckets").textContent=`Baldes: ${prod.totalBucketsExact.toFixed(2)} (~${prod.totalBucketsToMake})`;
    $("#plan_done").textContent=`Feitos: ${totalDone}`;
    $("#plan_left").textContent=`Faltam: ${totalLeft}`;

    $$("[data-done]").forEach(b=>b.onclick=()=>{
      const f=b.getAttribute("data-done");
      const p=getProg(date); p[f]=num(p[f])+1; setProg(date,p);
      renderPlan(); renderXL();
    });
    $$("[data-undo]").forEach(b=>b.onclick=()=>{
      const f=b.getAttribute("data-undo");
      const p=getProg(date); p[f]=Math.max(0,num(p[f])-1); setProg(date,p);
      renderPlan(); renderXL();
    });
  }

  $("#planRefresh").onclick=()=>renderPlan();
  $("#planDate").onchange=()=>{ renderPlan(); renderXL(); };
  $("#planReset").onclick=()=>{
    const date=$("#planDate").value; if(!date) return;
    if(!confirm("Reset do plano deste dia?")) return;
    resetProg(date); renderPlan(); renderXL();
  };
  $("#planPrint").onclick=()=>printPlan($("#planDate").value);

  // ===== XL screen
  function renderXL(){
    const date=$("#xlDate").value;
    if(!date) return;
    const list=ordersByDate(date);
    const grid=$("#xlGrid");

    if(!list.length){
      grid.innerHTML=`<div class="muted">Keine Bestellungen für dieses Datum.</div>`;
      $("#xl_totKg").textContent="KG: 0";
      $("#xl_totBuckets").textContent="Baldes: 0";
      $("#xl_done").textContent="Feitos: 0";
      $("#xl_left").textContent="Faltam: 0";
      return;
    }

    const prod=calcProduction(list);
    const progress=getProg(date);
    const rows=prod.rows.filter(r=>r.bucketsToMake>0).sort((a,b)=>(b.bucketsToMake-a.bucketsToMake)||(b.kg-a.kg)||a.f.localeCompare(b.f));

    let totalToMake=0,totalDone=0;
    grid.innerHTML=rows.map(r=>{
      const done=Math.max(0,Math.min(r.bucketsToMake, num(progress[r.f]||0)));
      const left=Math.max(0,r.bucketsToMake-done);
      totalToMake+=r.bucketsToMake; totalDone+=done;
      return `
        <div class="xlTile">
          <div>
            <div class="xlFlavor">${esc(r.f)}</div>
            <div class="xlNumbers">
              <div class="xlLeft">${left}</div>
              <div class="xlMeta">KG: <b>${r.kg.toFixed(2)}</b><br>Fazer: <b>${r.bucketsToMake}</b> • Feitos: <b>${done}</b></div>
            </div>
          </div>
          <div class="xlActions">
            <button class="xlBtn" data-xl-minus="${esc(r.f)}">-1</button>
            <button class="xlBtn plus" data-xl-plus="${esc(r.f)}">+1</button>
          </div>
        </div>`;
    }).join("");

    const totalLeft=Math.max(0,totalToMake-totalDone);
    $("#xl_totKg").textContent=`KG: ${prod.totalKg.toFixed(2)}`;
    $("#xl_totBuckets").textContent=`Baldes: ${prod.totalBucketsExact.toFixed(2)} (~${prod.totalBucketsToMake})`;
    $("#xl_done").textContent=`Feitos: ${totalDone}`;
    $("#xl_left").textContent=`Faltam: ${totalLeft}`;

    $$("[data-xl-plus]").forEach(b=>b.onclick=()=>{
      const f=b.getAttribute("data-xl-plus");
      const p=getProg(date);
      const row=rows.find(x=>x.f===f);
      const max=row?row.bucketsToMake:0;
      if(num(p[f])>=max) return;
      p[f]=num(p[f])+1; setProg(date,p);
      renderXL(); renderPlan();
    });
    $$("[data-xl-minus]").forEach(b=>b.onclick=()=>{
      const f=b.getAttribute("data-xl-minus");
      const p=getProg(date); p[f]=Math.max(0,num(p[f])-1); setProg(date,p);
      renderXL(); renderPlan();
    });
  }

  $("#xlRefresh").onclick=()=>renderXL();
  $("#xlDate").onchange=()=>{ renderXL(); renderPlan(); };
  $("#xlReset").onclick=()=>{
    const date=$("#xlDate").value; if(!date) return;
    if(!confirm("Reset do progresso XL deste dia?")) return;
    resetProg(date); renderXL(); renderPlan();
  };

  // ===== Statistik (counted only)
  function countedOrders(){ return db.orders.filter(o=>!!o.countedAt); }
  function calcMonth(yyyyMm){ return calcProduction(countedOrders().filter(o=>o.date.startsWith(yyyyMm))); }
  function calcYear(year){ const y=String(year); return calcProduction(countedOrders().filter(o=>o.date.startsWith(y+"-"))); }

  function refreshStatsTables(){
    const m=$("#statMonth").value;
    if(m){
      const prod=calcMonth(m);
      $("#sm_tot750").textContent=`750g: ${prod.t750}`;
      $("#sm_tot170").textContent=`170g: ${prod.t170}`;
      $("#sm_totAll").textContent=`Total: ${prod.total}`;
      $("#sm_totKg").textContent=`KG: ${prod.totalKg.toFixed(2)}`;
      $("#sm_totBuckets").textContent=`Baldes: ${prod.totalBucketsExact.toFixed(2)} (~${prod.totalBucketsToMake})`;
      $("#statMonthBody").innerHTML=prod.rows.map(r=>`
        <tr><td>${esc(r.f)}</td><td class="right">${r.g750}</td><td class="right">${r.g170}</td><td class="right">${r.kg.toFixed(2)}</td><td class="right">${r.bucketsExact.toFixed(2)}</td><td class="right"><b>${r.bucketsToMake}</b></td></tr>
      `).join("") || `<tr><td colspan="6" class="muted">Keine Daten (noch nichts gedruckt).</td></tr>`;
    }

    const y=parseInt($("#statYear").value||"",10);
    if(y){
      const prod=calcYear(y);
      $("#sy_tot750").textContent=`750g: ${prod.t750}`;
      $("#sy_tot170").textContent=`170g: ${prod.t170}`;
      $("#sy_totAll").textContent=`Total: ${prod.total}`;
      $("#sy_totKg").textContent=`KG: ${prod.totalKg.toFixed(2)}`;
      $("#sy_totBuckets").textContent=`Baldes: ${prod.totalBucketsExact.toFixed(2)} (~${prod.totalBucketsToMake})`;
      $("#statYearBody").innerHTML=prod.rows.map(r=>`
        <tr><td>${esc(r.f)}</td><td class="right">${r.g750}</td><td class="right">${r.g170}</td><td class="right">${r.kg.toFixed(2)}</td><td class="right">${r.bucketsExact.toFixed(2)}</td><td class="right"><b>${r.bucketsToMake}</b></td></tr>
      `).join("") || `<tr><td colspan="6" class="muted">Keine Daten (noch nichts gedruckt).</td></tr>`;
    }
  }

  $("#statMonthRefresh").onclick=()=>refreshStatsTables();
  $("#statYearRefresh").onclick=()=>refreshStatsTables();

  // ===== History
  function renderHistory(){
    const q=($("#historySearch").value||"").trim().toLowerCase();
    const box=$("#historyList");
    const orders=[...db.orders].reverse().filter(o=>{
      const cn=customerName(o.customerId).toLowerCase();
      return !q || o.date.includes(q) || cn.includes(q);
    });

    if(!orders.length){ box.innerHTML=`<div class="muted">Keine Bestellungen gespeichert.</div>`; return; }

    box.innerHTML=orders.map(o=>{
      const status=o.countedAt ? `<span class="pill" style="border-color:rgba(22,163,74,.35)">✅ Contado</span>`
                              : `<span class="pill" style="border-color:rgba(37,99,235,.30)">⏳ Nicht gezählt</span>`;
      const lines=o.lines.map(l=>`${esc(l.size)} • ${esc(l.flavor)} • <b>${l.qty}</b>`).join("<br>");
      return `
        <div class="card" style="margin-bottom:10px; box-shadow:none;">
          <div class="flex" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <div style="font-weight:950;">${esc(o.date)} – ${esc(customerName(o.customerId))}</div>
              <div class="muted">${esc(o.notes||"")}</div>
              <div style="margin-top:8px;">${status}</div>
            </div>
            <div class="flex">
              <button class="btn small" data-copy="${o.id}">Duplizieren</button>
              <button class="btn small" data-uncount="${o.id}">Uncount</button>
              <button class="btn small danger" data-del="${o.id}">Löschen</button>
            </div>
          </div>
          <div class="hr"></div>
          <div style="font-size:13px;">${lines}</div>
        </div>`;
    }).join("");

    $$("[data-del]").forEach(b=>b.onclick=()=>{
      const id=b.getAttribute("data-del");
      db.orders=db.orders.filter(o=>o.id!==id);
      saveDB(db); renderHistory(); refreshOverviewAll(); refreshStatsTables(); renderPlan(); renderXL();
    });
    $$("[data-copy]").forEach(b=>b.onclick=()=>{
      const id=b.getAttribute("data-copy");
      const o=db.orders.find(x=>x.id===id);
      if(!o) return;
      $("#orderCustomer").value=o.customerId;
      $("#orderDate").value=o.date;
      $("#orderNotes").value=o.notes||"";
      currentLines=o.lines.map(l=>({...l}));
      renderLines();
      renderTabs("bestellung");
    });
    $$("[data-uncount]").forEach(b=>b.onclick=()=>{
      const id=b.getAttribute("data-uncount");
      const o=db.orders.find(x=>x.id===id);
      if(!o) return;
      if(!confirm("‘Contado’ entfernen? Nur wenn du aus Versehen gedruckt hast.")) return;
      o.countedAt=null;
      saveDB(db);
      renderHistory(); refreshStatsTables();
    });
  }

  $("#historyRefresh").onclick=()=>renderHistory();
  $("#historySearch").oninput=()=>renderHistory();
  $("#deleteAll").onclick=()=>{
    if(!confirm("Wirklich ALLE Bestellungen löschen?")) return;
    db.orders=[];
    saveDB(db);
    renderHistory(); refreshOverviewAll(); refreshStatsTables(); renderPlan(); renderXL();
  };

  // ===== Nav
  $$(".tab").forEach(btn=>{
    btn.onclick=()=>{
      const v=btn.dataset.view;
      renderTabs(v);
      if(v==="kunden") renderCustomers();
      if(v==="sorten") renderFlavors();
      if(v==="history") renderHistory();
      if(v==="produktion") refreshOverviewAll();
      if(v==="plan") renderPlan();
      if(v==="xl") renderXL();
      if(v==="statistik") refreshStatsTables();
    };
  });

  // ===== Init
  function renderAll(){
    renderCustomers();
    renderFlavors();
    renderHistory();
    renderLines();
    refreshOverviewAll();
    refreshStatsTables();
    renderPlan();
    renderXL();
  }

  setTodayIfEmpty($("#orderDate"));
  setTodayIfEmpty($("#prodDate"));
  setTodayIfEmpty($("#planDate"));
  setTodayIfEmpty($("#xlDate"));
  setCurrentMonthIfEmpty($("#statMonth"));
  $("#statYear").value = $("#statYear").value || String(new Date().getFullYear());

  if(!currentLines.length) addLine("750g", db.flavors[0]||"", 0);
  renderAll();
})();
</script>
</body>
  </html>
  <!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Rezepte & Nährwerte</title>
  <style>
    :root{
      --bg:#f3f4f6; --card:#fff; --text:#0f172a; --muted:#64748b;
      --line:#e5e7eb; --line2:#d1d5db; --accent:#2563eb;
      --ok:#16a34a; --danger:#dc2626; --warn:#f59e0b;
      --shadow:0 14px 40px rgba(15,23,42,.10);
      --r:16px; --r2:14px; --tap:46px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#f8fafc,#f3f4f6);color:var(--text)}
    header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);padding-top:env(safe-area-inset-top)}
    .wrap{max-width:1150px;margin:0 auto;padding:12px 14px}
    .head{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:18px;font-weight:900}
    .btn{min-height:var(--tap);display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px 14px;border-radius:var(--r2);border:1px solid var(--line2);background:#fff;color:var(--text);cursor:pointer;font-weight:900;font-size:13px}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn.small{min-height:38px;padding:8px 10px;font-size:12px;border-radius:12px}
    main{padding:16px 0 30px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:920px){.grid.two{grid-template-columns:1.05fr .95fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:14px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 10px;font-size:14px}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px;font-weight:800}
    input,select,textarea{width:100%;min-height:var(--tap);padding:12px 12px;border-radius:var(--r2);border:1px solid var(--line2);background:#fff;color:var(--text);outline:none;font-size:15px}
    textarea{min-height:92px;resize:vertical}
    .row{display:grid;gap:10px}
    .row.cols{grid-template-columns:1fr}
    @media(min-width:720px){.row.cols{grid-template-columns:1fr 1fr}}
    .flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted);font-size:12px}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .scroll{overflow:auto;-webkit-overflow-scrolling:touch;border-radius:var(--r2)}
    .maxH{max-height:520px}
    @media(max-width:520px){.maxH{max-height:52vh}}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:var(--r2);overflow:hidden;background:#fff}
    thead th{position:sticky;top:0;z-index:2;background:#f8fafc;color:#334155;text-align:left;font-size:12px;text-transform:uppercase;letter-spacing:.06em;border-bottom:1px solid var(--line);padding:10px}
    tbody td{padding:10px;border-bottom:1px solid var(--line);font-size:13px;vertical-align:top}
    tbody tr:last-child td{border-bottom:none}
    .right{text-align:right}
    .chip{display:inline-flex;padding:4px 8px;border:1px solid var(--line2);border-radius:999px;font-size:11px;font-weight:900;background:#fff;margin:2px 4px 0 0}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line2);background:#fff;font-size:12px;font-weight:900}
    .badge.warn{border-color:rgba(245,158,11,.45)}
    .badge.ok{border-color:rgba(22,163,74,.35)}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="head">
      <h1>Rezepte & Nährwerte</h1>
      <div class="flex">
        <a class="btn small" href="./bestellung_production.html">← Bestellung</a>
        <a class="btn small" href="./etiketten.html">Etiketten</a>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="grid two">
    <div class="card">
      <h2>Rezept pro Sorte</h2>

      <div class="row cols">
        <div>
          <label>Sorte</label>
          <select id="rFlavor"></select>
        </div>
        <div>
          <label>Produktbezeichnung (z.B. Milcheis / Sorbet)</label>
          <input id="rDenom" placeholder="z.B. Milcheis" />
        </div>
      </div>

      <div class="row cols" style="margin-top:10px;">
        <div>
          <label>Standard-Packung für Etikett</label>
          <select id="rPack">
            <option value="170">170 g</option>
            <option value="750">750 g</option>
          </select>
        </div>
        <div>
          <label>Standard-Aufbewahrung (Etikett)</label>
          <input id="rStorage" placeholder="z.B. Bei -18°C lagern. Nach dem Auftauen nicht wieder einfrieren." />
        </div>
      </div>

      <div class="hr"></div>

      <div class="flex">
        <button class="btn primary" id="rAddLine">+ Zutat</button>
        <button class="btn" id="rClear">Leeren</button>
        <button class="btn ok" id="rSave">Rezept speichern</button>
      </div>

      <div class="hr"></div>

      <div class="scroll maxH" style="border:1px solid var(--line);">
        <table>
          <thead><tr><th>Zutat</th><th class="right" style="width:180px;">Menge (g)</th><th class="right" style="width:90px;">Aktion</th></tr></thead>
          <tbody id="rBody"></tbody>
        </table>
      </div>

      <div class="hr"></div>
      <div class="flex">
        <span class="badge" id="rTotal">Gesamt: 0 g</span>
        <span class="badge" id="rPer100">Nährwerte: OK</span>
        <span class="badge warn" id="rAzo">Farbstoff-Warnung: nein</span>
      </div>

      <div class="hr"></div>
      <div id="rPreview"></div>
    </div>

    <div class="card">
      <h2>Zutaten-Datenbank</h2>
      <div class="muted">Werte pro <b>100 g</b>. Nutze am besten die Lieferanten-Spezifikationen.</div>

      <div class="hr"></div>

      <div class="row cols">
        <div>
          <label>Name (Deutsch)</label>
          <input id="iName" placeholder="z.B. Vollmilch 3,5%" />
        </div>
        <div>
          <label>Kann Spuren enthalten (optional)</label>
          <input id="iTraces" placeholder="z.B. EI, SOJA, SCHALENFRÜCHTE" />
        </div>
      </div>

      <label style="margin-top:10px;">Allergene (14) – auswählen</label>
      <div id="iAllBox" class="scroll" style="border:1px solid var(--line2); padding:10px; border-radius:14px; max-height:170px;"></div>

      <div class="row cols" style="margin-top:10px;">
        <div>
          <label>Zusatzstoff-Klasse (optional)</label>
          <select id="iClass">
            <option value="">—</option>
            <option value="Farbstoff">Farbstoff</option>
            <option value="Stabilisator">Stabilisator</option>
            <option value="Emulgator">Emulgator</option>
            <option value="Konservierungsstoff">Konservierungsstoff</option>
            <option value="Säuerungsmittel">Säuerungsmittel</option>
            <option value="Aroma">Aroma</option>
          </select>
        </div>
        <div>
          <label>E-Nummer / Zusatzstoff-Name (optional)</label>
          <input id="iE" placeholder="z.B. E410 / Beta-Carotin / E202" />
        </div>
      </div>

      <div class="row cols" style="margin-top:10px;">
        <div>
          <label>AZO-Warnhinweis? (E102/E104/E110/E122/E124/E129)</label>
          <select id="iAzo">
            <option value="auto">Auto</option>
            <option value="no">Nein</option>
            <option value="yes">Ja</option>
          </select>
        </div>
        <div>
          <label>Datenquelle / Notiz (optional)</label>
          <input id="iSource" placeholder="z.B. Etikett Foto 12/2025 / Lieferant Spec" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="row cols">
        <div><label>Energie (kJ)</label><input id="nKj" type="number" step="0.1" value="0"></div>
        <div><label>Energie (kcal)</label><input id="nKcal" type="number" step="0.1" value="0"></div>
      </div>
      <div class="row cols" style="margin-top:10px;">
        <div><label>Fett (g)</label><input id="nFat" type="number" step="0.1" value="0"></div>
        <div><label>davon gesättigte Fettsäuren (g)</label><input id="nSat" type="number" step="0.1" value="0"></div>
      </div>
      <div class="row cols" style="margin-top:10px;">
        <div><label>Kohlenhydrate (g)</label><input id="nCarb" type="number" step="0.1" value="0"></div>
        <div><label>davon Zucker (g)</label><input id="nSug" type="number" step="0.1" value="0"></div>
      </div>
      <div class="row cols" style="margin-top:10px;">
        <div><label>Eiweiß (g)</label><input id="nPro" type="number" step="0.1" value="0"></div>
        <div><label>Salz (g)</label><input id="nSalt" type="number" step="0.001" value="0"></div>
      </div>

      <div class="flex" style="margin-top:12px;">
        <button class="btn ok" id="iSave">Zutat speichern</button>
        <button class="btn" id="iReset">Leeren</button>
      </div>

      <div class="hr"></div>

      <div class="scroll maxH" style="border:1px solid var(--line); padding:10px;">
        <div id="iList"></div>
      </div>
    </div>
  </section>
</main>

<script>
(() => {
  const DB_KEY = "SANREMO_DB_V1";
  const azoSet = new Set(["E102","E104","E110","E122","E124","E129"]);
  const AZO_WARNING_DE = "Kann Aktivität und Aufmerksamkeit bei Kindern beeinträchtigen.";

  const ALLERGENS_14 = [
    "GLUTEN","KREBSTIERE","EI","FISCH","ERDNÜSSE","SOJA","MILCH","SCHALENFRÜCHTE",
    "SELLERIE","SENF","SESAM","SULFITE","LUPINEN","WEICHTIERE"
  ];

  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  function num(x){ const n=Number(x); return isFinite(n)?n:0; }
  function esc(s){ return String(s).replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

  function loadDB(){
    try{
      const raw=localStorage.getItem(DB_KEY);
      if(raw){ const db=JSON.parse(raw); if(db && typeof db==="object") return db; }
    }catch(e){}
    return { flavors:[], customers:[], orders:[], ingredients:[], recipes:{} };
  }
  function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

  function parseComma(text){ return (text||"").split(",").map(x=>x.trim()).filter(Boolean).map(x=>x.toUpperCase()); }
  function normalizeE(e){
    const m=String(e||"").toUpperCase().replace(/\s+/g,"").match(/^E(\d{3,4}[A-Z]?)$/);
    return m?("E"+m[1]):"";
  }

  function renderAllergenCheckboxes(){
    const box=$("#iAllBox");
    box.innerHTML = ALLERGENS_14.map(a=>`
      <label style="display:flex;gap:10px;align-items:center;margin:6px 0;font-weight:900;color:#0f172a;">
        <input type="checkbox" class="iAllChk" value="${a}" style="width:18px;height:18px;min-height:auto;">
        <span>${a}</span>
      </label>`).join("");
  }
  function getAllergenChecks(){
    return Array.from(document.querySelectorAll(".iAllChk")).filter(ch=>ch.checked).map(ch=>ch.value);
  }
  function setAllergenChecks(list){
    const set=new Set((list||[]).map(x=>String(x).toUpperCase().trim()));
    Array.from(document.querySelectorAll(".iAllChk")).forEach(ch=>ch.checked=set.has(ch.value));
  }

  function hasAnyNutrition(i){
    const n=i?.n||{};
    return (num(n.kj)+num(n.kcal)+num(n.fat)+num(n.sat)+num(n.carb)+num(n.sug)+num(n.pro)+num(n.salt))>0;
  }

  let db = loadDB();
  db.ingredients = Array.isArray(db.ingredients) ? db.ingredients : [];
  db.recipes = db.recipes && typeof db.recipes==="object" ? db.recipes : {};

  // ===== Ingredients list
  function renderIngredients(){
    const box=$("#iList");
    if(!db.ingredients.length){
      box.innerHTML = `<div class="muted">Noch keine Zutaten gespeichert.</div>`;
      return;
    }
    box.innerHTML = db.ingredients.map(i=>{
      const chips=[];
      (i.allergens||[]).forEach(a=>chips.push(`<span class="chip">${esc(a)}</span>`));
      if(i.traces && i.traces.length) chips.push(`<span class="chip">Spuren: ${esc(i.traces.join(", "))}</span>`);
      if(i.addClass) chips.push(`<span class="chip">${esc(i.addClass)}${i.addE?": "+esc(i.addE):""}</span>`);
      if(i.azo) chips.push(`<span class="chip">AZO</span>`);
      if(i.source) chips.push(`<span class="chip">Quelle</span>`);

      return `
        <div class="card" style="margin-bottom:10px; box-shadow:none;">
          <div class="flex" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <div style="font-weight:1000;">${esc(i.name)}</div>
              <div>${chips.join("") || "<span class='muted'>—</span>"}</div>
              <div class="muted" style="margin-top:6px;">
                kJ ${num(i.n?.kj).toFixed(1)} • kcal ${num(i.n?.kcal).toFixed(1)} •
                Fett ${num(i.n?.fat).toFixed(1)} • ges. ${num(i.n?.sat).toFixed(1)} •
                KH ${num(i.n?.carb).toFixed(1)} • Zucker ${num(i.n?.sug).toFixed(1)} •
                Eiweiß ${num(i.n?.pro).toFixed(1)} • Salz ${num(i.n?.salt).toFixed(3)}
              </div>
              ${i.source?`<div class="muted" style="margin-top:6px;"><b>Quelle:</b> ${esc(i.source)}</div>`:""}
            </div>
            <div class="flex">
              <button class="btn small" data-edit="${i.id}">Edit</button>
              <button class="btn small danger" data-del="${i.id}">Löschen</button>
            </div>
          </div>
        </div>`;
    }).join("");

    $$("[data-del]").forEach(b=>b.onclick=()=>{
      const id=b.getAttribute("data-del");
      const used = Object.values(db.recipes||{}).some(r => (r.lines||[]).some(l=>l.ingId===id));
      if(used && !confirm("Diese Zutat wird in Rezepten verwendet. Trotzdem löschen?")) return;
      db.ingredients=db.ingredients.filter(x=>x.id!==id);
      saveDB(db);
      renderIngredients();
      renderRecipeLines();
      renderPreview();
    });

    $$("[data-edit]").forEach(b=>b.onclick=()=>{
      const id=b.getAttribute("data-edit");
      const i=db.ingredients.find(x=>x.id===id);
      if(!i) return;
      $("#iName").value=i.name||"";
      $("#iTraces").value=(i.traces||[]).join(", ");
      $("#iClass").value=i.addClass||"";
      $("#iE").value=i.addE||"";
      $("#iAzo").value=i.azo ? "yes" : "auto";
      $("#iSource").value=i.source||"";
      setAllergenChecks(i.allergens||[]);
      $("#nKj").value=num(i.n?.kj);
      $("#nKcal").value=num(i.n?.kcal);
      $("#nFat").value=num(i.n?.fat);
      $("#nSat").value=num(i.n?.sat);
      $("#nCarb").value=num(i.n?.carb);
      $("#nSug").value=num(i.n?.sug);
      $("#nPro").value=num(i.n?.pro);
      $("#nSalt").value=num(i.n?.salt);
      $("#iSave").setAttribute("data-edit-id", id);
      $("#iSave").textContent="Änderungen speichern";
    });
  }

  function resetIngredientForm(){
    $("#iName").value="";
    $("#iTraces").value="";
    $("#iClass").value="";
    $("#iE").value="";
    $("#iAzo").value="auto";
    $("#iSource").value="";
    setAllergenChecks([]);
    $("#nKj").value=0; $("#nKcal").value=0; $("#nFat").value=0; $("#nSat").value=0;
    $("#nCarb").value=0; $("#nSug").value=0; $("#nPro").value=0; $("#nSalt").value=0;
    $("#iSave").removeAttribute("data-edit-id");
    $("#iSave").textContent="Zutat speichern";
  }

  $("#iReset").onclick=()=>resetIngredientForm();

  $("#iSave").onclick=()=>{
    const name=$("#iName").value.trim();
    if(!name) return;

    const allergens=getAllergenChecks();
    const traces=parseComma($("#iTraces").value||"");
    const addClass=$("#iClass").value||"";
    const addE=$("#iE").value.trim();
    const azoMode=$("#iAzo").value;
    const eNorm=normalizeE(addE);
    const azoAuto = (!!eNorm && azoSet.has(eNorm));
    const azo = (azoMode==="yes") ? true : (azoMode==="no") ? false : azoAuto;

    const obj={
      id: uid(),
      name,
      allergens,
      traces,
      addClass,
      addE,
      azo,
      source: $("#iSource").value.trim(),
      n:{
        kj:num($("#nKj").value), kcal:num($("#nKcal").value),
        fat:num($("#nFat").value), sat:num($("#nSat").value),
        carb:num($("#nCarb").value), sug:num($("#nSug").value),
        pro:num($("#nPro").value), salt:num($("#nSalt").value)
      }
    };

    const editId=$("#iSave").getAttribute("data-edit-id");
    if(editId){
      const idx=db.ingredients.findIndex(x=>x.id===editId);
      if(idx>=0){ obj.id=editId; db.ingredients[idx]=obj; }
    }else{
      db.ingredients.push(obj);
    }

    saveDB(db);
    resetIngredientForm();
    renderIngredients();
    renderRecipeLines();
    renderPreview();
  };

  // ===== Recipes
  function renderFlavorSelect(){
    const sel=$("#rFlavor");
    sel.innerHTML = (db.flavors||[]).map(f=>`<option value="${esc(f)}">${esc(f)}</option>`).join("");
  }

  let rLines=[];
  function rAddLine(ingId=null, grams=0){
    const first=db.ingredients[0]?.id || "";
    rLines.push({ ingId: ingId || first, grams:num(grams) });
    renderRecipeLines();
  }

  function renderRecipeLines(){
    const tb=$("#rBody"); tb.innerHTML="";
    rLines.forEach((ln,idx)=>{
      const tr=document.createElement("tr");
      const ingSel=document.createElement("select");
      ingSel.innerHTML = db.ingredients.map(i=>`<option value="${i.id}">${esc(i.name)}</option>`).join("");
      ingSel.value=ln.ingId;
      ingSel.onchange=()=>{ ln.ingId=ingSel.value; renderPreview(); };

      const g=document.createElement("input");
      g.type="number"; g.step="1"; g.min="0"; g.value=String(num(ln.grams));
      g.oninput=()=>{ ln.grams=num(g.value); renderPreview(); };

      const del=document.createElement("button");
      del.className="btn small danger"; del.textContent="X";
      del.onclick=()=>{ rLines.splice(idx,1); renderRecipeLines(); };

      tr.innerHTML=`<td></td><td class="right"></td><td class="right"></td>`;
      tr.children[0].appendChild(ingSel);
      tr.children[1].appendChild(g);
      tr.children[2].appendChild(del);
      tb.appendChild(tr);
    });

    if(!rLines.length) rAddLine();
    renderPreview();
  }

  function calcRecipe(){
    const lines=rLines.filter(l=>l.ingId && num(l.grams)>0).map(l=>({ingId:l.ingId, grams:num(l.grams)}));
    const totalG=lines.reduce((s,l)=>s+l.grams,0);

    // totals per batch
    const totals={kj:0,kcal:0,fat:0,sat:0,carb:0,sug:0,pro:0,salt:0};
    const allergensSet=new Set();
    const tracesSet=new Set();
    const additives=[];
    let azo=false;

    const items = lines.map(l=>{
      const ing=db.ingredients.find(x=>x.id===l.ingId);
      return {ing, grams:l.grams};
    }).filter(x=>x.ing);

    items.forEach(({ing,grams})=>{
      const factor=grams/100;
      totals.kj += factor*num(ing.n?.kj);
      totals.kcal += factor*num(ing.n?.kcal);
      totals.fat += factor*num(ing.n?.fat);
      totals.sat += factor*num(ing.n?.sat);
      totals.carb += factor*num(ing.n?.carb);
      totals.sug += factor*num(ing.n?.sug);
      totals.pro += factor*num(ing.n?.pro);
      totals.salt += factor*num(ing.n?.salt);

      (ing.allergens||[]).forEach(a=>allergensSet.add(a));
      (ing.traces||[]).forEach(t=>tracesSet.add(t));

      const eNorm=normalizeE(ing.addE);
      if(ing.azo || (eNorm && azoSet.has(eNorm))) azo=true;

      if(ing.addClass){
        additives.push( ing.addE ? `${ing.addClass}: ${ing.addE}` : `${ing.addClass}` );
      }
    });

    // per 100g
    const per100 = (k)=> totalG>0 ? (totals[k]/totalG*100) : 0;
    const per100g = {
      kj: per100("kj"),
      kcal: per100("kcal"),
      fat: per100("fat"),
      sat: per100("sat"),
      carb: per100("carb"),
      sug: per100("sug"),
      pro: per100("pro"),
      salt: per100("salt")
    };

    // Zutatenliste sorted by grams desc
    const sorted=[...items].sort((a,b)=>b.grams-a.grams);
    const zutatenText = sorted.map(({ing})=>{
      const all=(ing.allergens||[]).length ? ` (<b>${esc(ing.allergens.join(", "))}</b>)` : "";
      return `${esc(ing.name)}${all}`;
    }).join(", ");

    const additivesUnique=[...new Set(additives.filter(Boolean))];

    return {
      totalG,
      per100g,
      zutatenText,
      allergens:[...allergensSet],
      traces:[...tracesSet],
      additives:additivesUnique,
      azo,
      missingNutrition: sorted.filter(x=>!hasAnyNutrition(x.ing)).map(x=>x.ing.name)
    };
  }

  function fmt1(x){ return (Math.round(num(x)*10)/10).toFixed(1); }
  function fmtSalt(x){
    const v=num(x);
    if(v<0.01) return (Math.round(v*1000)/1000).toFixed(3);
    return (Math.round(v*100)/100).toFixed(2);
  }

  function renderPreview(){
    const flavor=$("#rFlavor").value||"";
    const denom=($("#rDenom").value||"Milcheis").trim();
    const pack=$("#rPack").value;
    const storage=($("#rStorage").value||"").trim();

    const r=calcRecipe();
    $("#rTotal").textContent=`Gesamt: ${Math.round(r.totalG)} g`;
    $("#rAzo").textContent=`Farbstoff-Warnung: ${r.azo ? "JA" : "nein"}`;

    if(r.missingNutrition.length){
      $("#rPer100").textContent=`Nährwerte: FEHLT (${r.missingNutrition.length})`;
      $("#rPer100").className="badge warn";
    }else{
      $("#rPer100").textContent="Nährwerte: OK";
      $("#rPer100").className="badge ok";
    }

    const warn = r.azo ? `<div class="badge warn">⚠ Pflicht-Hinweis: „${esc(AZO_WARNING_DE)}“</div>` : `<div class="badge ok">Kein Southampton-Farbstoff erkannt</div>`;
    const add = r.additives.length ? `<div class="muted" style="margin-top:8px;"><b>Zusatzstoffe:</b> ${r.additives.map(esc).join(", ")}</div>` : `<div class="muted" style="margin-top:8px;">Zusatzstoffe: —</div>`;
    const spuren = r.traces.length ? `<div class="muted" style="margin-top:8px;"><b>Kann Spuren enthalten:</b> ${esc(r.traces.join(", "))}</div>` : "";

    const prev = `
      <div class="card" style="box-shadow:none;border:1px dashed var(--line2);">
        <div class="flex" style="justify-content:space-between;align-items:flex-start;">
          <div>
            <div style="font-weight:1000;">Vorschau (Etikett-Text)</div>
            <div class="muted">${esc(denom)} • ${esc(flavor)} • ${esc(pack)} g</div>
          </div>
          ${warn}
        </div>
        <div class="hr"></div>
        <div style="font-weight:950;">Zutaten:</div>
        <div style="font-size:13px;line-height:1.3;">${r.zutatenText||"<span class='muted'>—</span>"}</div>
        ${spuren}
        ${add}
        ${storage?`<div class="muted" style="margin-top:8px;"><b>Aufbewahrung:</b> ${esc(storage)}</div>`:""}
        <div class="hr"></div>
        <div style="font-weight:950;">Nährwerte je 100 g:</div>
        <div class="scroll" style="border:1px solid var(--line);margin-top:8px;">
          <table>
            <tbody>
              <tr><td>Energie</td><td class="right"><b>${Math.round(r.per100g.kj)} kJ</b> / <b>${Math.round(r.per100g.kcal)} kcal</b></td></tr>
              <tr><td>Fett</td><td class="right">${fmt1(r.per100g.fat)} g</td></tr>
              <tr><td class="muted">davon gesättigte Fettsäuren</td><td class="right">${fmt1(r.per100g.sat)} g</td></tr>
              <tr><td>Kohlenhydrate</td><td class="right">${fmt1(r.per100g.carb)} g</td></tr>
              <tr><td class="muted">davon Zucker</td><td class="right">${fmt1(r.per100g.sug)} g</td></tr>
              <tr><td>Eiweiß</td><td class="right">${fmt1(r.per100g.pro)} g</td></tr>
              <tr><td>Salz</td><td class="right">${fmtSalt(r.per100g.salt)} g</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    `;
    $("#rPreview").innerHTML = prev;
  }

  function loadRecipeToForm(){
    const key=$("#rFlavor").value||"";
    const saved=db.recipes[key];
    if(saved){
      $("#rDenom").value=saved.denom||"Milcheis";
      $("#rPack").value=String(saved.pack||170);
      $("#rStorage").value=saved.storage||"";
      rLines=(saved.lines||[]).map(x=>({ingId:x.ingId, grams:num(x.grams)}));
      if(!rLines.length) rAddLine();
      renderRecipeLines();
    }else{
      $("#rDenom").value="Milcheis";
      $("#rPack").value="170";
      $("#rStorage").value="Bei -18°C lagern. Nach dem Auftauen nicht wieder einfrieren.";
      rLines=[];
      rAddLine();
    }
    renderPreview();
  }

  $("#rAddLine").onclick=()=>rAddLine();
  $("#rClear").onclick=()=>{ rLines=[]; rAddLine(); renderPreview(); };

  $("#rSave").onclick=()=>{
    const key=$("#rFlavor").value||"";
    if(!key) return;
    db.recipes[key]={
      denom: ($("#rDenom").value||"Milcheis").trim(),
      pack: num($("#rPack").value||170),
      storage: ($("#rStorage").value||"").trim(),
      lines: rLines.map(l=>({ingId:l.ingId, grams:num(l.grams)}))
    };
    saveDB(db);
    alert("Rezept gespeichert ✅");
  };

  $("#rFlavor").onchange=()=>loadRecipeToForm();
  $("#rDenom").oninput=()=>renderPreview();
  $("#rPack").onchange=()=>renderPreview();
  $("#rStorage").oninput=()=>renderPreview();

  // ===== init
  renderAllergenCheckboxes();
  renderFlavorSelect();
  renderIngredients();
  loadRecipeToForm();
})();
</script>
</body>
</html>
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Etiketten</title>
  <style>
    :root{--bg:#f3f4f6;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e5e7eb;--line2:#d1d5db;--accent:#2563eb;--ok:#16a34a;--danger:#dc2626;--warn:#f59e0b;--shadow:0 14px 40px rgba(15,23,42,.10);--r:16px;--r2:14px;--tap:46px}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#f8fafc,#f3f4f6);color:var(--text)}
    header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);padding-top:env(safe-area-inset-top)}
    .wrap{max-width:900px;margin:0 auto;padding:12px 14px}
    .head{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:18px;font-weight:900}
    .btn{min-height:var(--tap);display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px 14px;border-radius:var(--r2);border:1px solid var(--line2);background:#fff;color:var(--text);cursor:pointer;font-weight:900;font-size:13px}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
    .btn.small{min-height:38px;padding:8px 10px;font-size:12px;border-radius:12px}
    main{padding:16px 0 30px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:14px;box-shadow:var(--shadow)}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px;font-weight:800}
    input,select,textarea{width:100%;min-height:var(--tap);padding:12px 12px;border-radius:var(--r2);border:1px solid var(--line2);background:#fff;color:var(--text);outline:none;font-size:15px}
    .row{display:grid;gap:10px}
    .row.cols{grid-template-columns:1fr}
    @media(min-width:720px){.row.cols{grid-template-columns:1fr 1fr}}
    .flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted);font-size:12px}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line2);background:#fff;font-size:12px;font-weight:900}
    .badge.warn{border-color:rgba(245,158,11,.45)}
    .badge.ok{border-color:rgba(22,163,74,.35)}
    .scroll{overflow:auto;-webkit-overflow-scrolling:touch;border-radius:var(--r2)}
    table{width:100%;border-collapse:collapse}
    @media print{
      header,.no-print{display:none!important}
      body{background:#fff;color:#000}
      .print-area{display:block!important}
      .print-page{page-break-after:always;padding:12mm 10mm;font-family:Arial,Helvetica,sans-serif}
      .print-page:last-child{page-break-after:auto}
      .etikett{border:1.5px solid #000;border-radius:8px;padding:10px}
      .etikett .title{font-size:15px;font-weight:800;margin:0 0 6px}
      .etikett .meta{font-size:11px;color:#111;margin-bottom:6px}
      .etikett .ing{font-size:10.6px;line-height:1.25;margin:6px 0}
      .etikett .warn{font-size:10.8px;margin:6px 0;font-weight:800}
      .etikett table{width:100%;border-collapse:collapse;margin-top:6px}
      .etikett th,.etikett td{border:1px solid #000;padding:4px 5px;font-size:10.5px}
      .etikett th{background:#f2f2f2;text-align:left}
      .etikett .foot{font-size:10.5px;margin-top:6px}
    }
  </style>
</head>
<body>
<header class="no-print">
  <div class="wrap">
    <div class="head">
      <h1>Etiketten</h1>
      <div class="flex">
        <a class="btn small" href="./bestellung_production.html">← Bestellung</a>
        <a class="btn small" href="./rezepte_naehrwerte.html">Rezepte</a>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="card">
    <div class="row cols">
      <div>
        <label>Sorte</label>
        <select id="flavor"></select>
      </div>
      <div>
        <label>Packung</label>
        <select id="pack">
          <option value="170">170 g</option>
          <option value="750">750 g</option>
        </select>
      </div>
    </div>

    <div class="row cols" style="margin-top:10px;">
      <div>
        <label>MHD / Charge (Text)</label>
        <input id="lot" placeholder="z.B. MHD: 01.06.2026 • Charge: 25-01">
      </div>
      <div>
        <label>Unternehmer (Text)</label>
        <input id="oper" value="Eiscafé Sanremo, Bad Berleburg, Tel.: 0176 72809926">
      </div>
    </div>

    <div class="hr"></div>

    <div class="flex">
      <button class="btn primary" id="previewBtn">Vorschau</button>
      <button class="btn ok" id="printBtn">Drucken</button>
      <span id="status" class="muted"></span>
    </div>

    <div class="hr"></div>
    <div id="preview"></div>
  </div>

  <section class="print-area hidden" id="printArea"></section>
</main>

<script>
(() => {
  const DB_KEY = "SANREMO_DB_V1";
  const azoSet = new Set(["E102","E104","E110","E122","E124","E129"]);
  const AZO_WARNING_DE = "Kann Aktivität und Aufmerksamkeit bei Kindern beeinträchtigen.";

  const $ = (s)=>document.querySelector(s);
  function num(x){ const n=Number(x); return isFinite(n)?n:0; }
  function esc(s){ return String(s).replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

  function loadDB(){
    try{
      const raw=localStorage.getItem(DB_KEY);
      if(raw){ const db=JSON.parse(raw); if(db && typeof db==="object") return db; }
    }catch(e){}
    return {flavors:[], ingredients:[], recipes:{}};
  }

  function normalizeE(e){
    const m=String(e||"").toUpperCase().replace(/\s+/g,"").match(/^E(\d{3,4}[A-Z]?)$/);
    return m?("E"+m[1]):"";
  }

  function calcRecipe(db, flavor){
    const r=db.recipes?.[flavor];
    if(!r) return null;

    const lines=(r.lines||[]).filter(l=>num(l.grams)>0);
    const items=lines.map(l=>{
      const ing=db.ingredients.find(x=>x.id===l.ingId);
      return ing ? {ing, grams:num(l.grams)} : null;
    }).filter(Boolean);

    const totalG=items.reduce((s,x)=>s+x.grams,0);

    const totals={kj:0,kcal:0,fat:0,sat:0,carb:0,sug:0,pro:0,salt:0};
    const tracesSet=new Set();
    const additives=[];
    let azo=false;

    items.forEach(({ing,grams})=>{
      const factor=grams/100;
      totals.kj += factor*num(ing.n?.kj);
      totals.kcal += factor*num(ing.n?.kcal);
      totals.fat += factor*num(ing.n?.fat);
      totals.sat += factor*num(ing.n?.sat);
      totals.carb += factor*num(ing.n?.carb);
      totals.sug += factor*num(ing.n?.sug);
      totals.pro += factor*num(ing.n?.pro);
      totals.salt += factor*num(ing.n?.salt);

      (ing.traces||[]).forEach(t=>tracesSet.add(t));

      const eNorm=normalizeE(ing.addE);
      if(ing.azo || (eNorm && azoSet.has(eNorm))) azo=true;

      if(ing.addClass){
        additives.push( ing.addE ? `${ing.addClass}: ${ing.addE}` : `${ing.addClass}` );
      }
    });

    const per100=(k)=> totalG>0 ? (totals[k]/totalG*100) : 0;
    const per100g={
      kj: per100("kj"), kcal: per100("kcal"),
      fat: per100("fat"), sat: per100("sat"),
      carb: per100("carb"), sug: per100("sug"),
      pro: per100("pro"), salt: per100("salt")
    };

    // Zutatenliste (sorted)
    const sorted=[...items].sort((a,b)=>b.grams-a.grams);
    const zutaten = sorted.map(({ing})=>{
      const all=(ing.allergens||[]).length ? ` (<b>${esc((ing.allergens||[]).join(", "))}</b>)` : "";
      return `${esc(ing.name)}${all}`;
    }).join(", ");

    const additivesUnique=[...new Set(additives.filter(Boolean))];
    const missingNut = sorted.filter(x=>{
      const n=x.ing.n||{};
      return (num(n.kj)+num(n.kcal)+num(n.fat)+num(n.sat)+num(n.carb)+num(n.sug)+num(n.pro)+num(n.salt))<=0;
    }).map(x=>x.ing.name);

    return {
      denom: r.denom || "Milcheis",
      storage: r.storage || "Bei -18°C lagern. Nach dem Auftauen nicht wieder einfrieren.",
      per100g, zutaten, traces:[...tracesSet], additives:additivesUnique, azo,
      missingNut
    };
  }

  function fmt1(x){ return (Math.round(num(x)*10)/10).toFixed(1); }
  function fmtSalt(x){
    const v=num(x);
    if(v<0.01) return (Math.round(v*1000)/1000).toFixed(3);
    return (Math.round(v*100)/100).toFixed(2);
  }

  function renderFlavorList(db){
    const sel=$("#flavor");
    sel.innerHTML=(db.flavors||[]).map(f=>`<option value="${esc(f)}">${esc(f)}</option>`).join("");
  }

  function renderPreview(){
    const db=loadDB();
    renderFlavorList(db);

    const flavor=$("#flavor").value || db.flavors?.[0] || "";
    $("#flavor").value = flavor;

    const rec=calcRecipe(db, flavor);
    const status=$("#status");

    if(!rec){
      status.textContent="⚠ Kein Rezept gefunden. Bitte zuerst im Rezepte-Modul speichern.";
      $("#preview").innerHTML="";
      return null;
    }

    if(rec.missingNut.length){
      status.textContent=`⚠ Achtung: Nährwerte fehlen bei: ${rec.missingNut.join(", ")}`;
    }else{
      status.textContent="OK";
    }

    const pack=$("#pack").value;
    const lot=$("#lot").value.trim();
    const oper=$("#oper").value.trim();

    const warn = rec.azo ? `<div class="badge warn">⚠ Pflicht-Hinweis: „${esc(AZO_WARNING_DE)}“</div>` : `<div class="badge ok">Kein Southampton-Farbstoff erkannt</div>`;
    const spuren = rec.traces.length ? `<div class="muted" style="margin-top:8px;"><b>Kann Spuren enthalten:</b> ${esc(rec.traces.join(", "))}</div>` : "";
    const add = rec.additives.length ? `<div class="muted" style="margin-top:8px;"><b>Zusatzstoffe:</b> ${rec.additives.map(esc).join(", ")}</div>` : "";

    $("#preview").innerHTML=`
      <div class="card" style="box-shadow:none;border:1px dashed var(--line2);">
        <div class="flex" style="justify-content:space-between;align-items:flex-start;">
          <div>
            <div style="font-weight:1000;">${esc(rec.denom)} – ${esc(flavor)}</div>
            <div class="muted">Nettofüllmenge: <b>${esc(pack)} g</b></div>
          </div>
          ${warn}
        </div>
        <div class="hr"></div>
        <div style="font-weight:950;">Zutaten:</div>
        <div style="font-size:13px;line-height:1.3;">${rec.zutaten}</div>
        ${spuren}
        ${add}
        <div class="muted" style="margin-top:8px;"><b>Aufbewahrung:</b> ${esc(rec.storage)}</div>
        ${lot?`<div class="muted" style="margin-top:8px;"><b>${esc(lot)}</b></div>`:""}
        <div class="muted" style="margin-top:8px;"><b>Unternehmer:</b> ${esc(oper)}</div>

        <div class="hr"></div>
        <div style="font-weight:950;">Nährwerte je 100 g:</div>
        <div class="scroll" style="border:1px solid var(--line); margin-top:8px;">
          <table>
            <tbody>
              <tr><td>Energie</td><td class="right"><b>${Math.round(rec.per100g.kj)} kJ</b> / <b>${Math.round(rec.per100g.kcal)} kcal</b></td></tr>
              <tr><td>Fett</td><td class="right">${fmt1(rec.per100g.fat)} g</td></tr>
              <tr><td class="muted">davon gesättigte Fettsäuren</td><td class="right">${fmt1(rec.per100g.sat)} g</td></tr>
              <tr><td>Kohlenhydrate</td><td class="right">${fmt1(rec.per100g.carb)} g</td></tr>
              <tr><td class="muted">davon Zucker</td><td class="right">${fmt1(rec.per100g.sug)} g</td></tr>
              <tr><td>Eiweiß</td><td class="right">${fmt1(rec.per100g.pro)} g</td></tr>
              <tr><td>Salz</td><td class="right">${fmtSalt(rec.per100g.salt)} g</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    `;

    return {db, flavor, rec, pack, lot, oper};
  }

  function doPrint(model){
    // safety: missing nutrition
    if(model.rec.missingNut.length){
      const ok = confirm("⚠ Achtung: Für folgende Zutaten fehlen Nährwerte:\n" + model.rec.missingNut.join(", ") + "\n\nTrotzdem Etikett drucken?");
      if(!ok) return;
    }

    const warn = model.rec.azo ? `<div class="warn">Hinweis: ${esc(AZO_WARNING_DE)}</div>` : "";
    const spuren = model.rec.traces.length ? `<div class="ing"><b>Kann Spuren enthalten:</b> ${esc(model.rec.traces.join(", "))}</div>` : "";
    const add = model.rec.additives.length ? `<div class="ing"><b>Zusatzstoffe:</b> ${model.rec.additives.map(esc).join(", ")}</div>` : "";

    const html=`
      <div class="print-page">
        <div class="etikett">
          <div class="title">${esc(model.rec.denom)} – ${esc(model.flavor)}</div>
          <div class="meta">Nettofüllmenge: <b>${esc(model.pack)} g</b></div>

          <div class="ing"><b>Zutaten:</b> ${model.rec.zutaten}</div>
          ${spuren}
          ${add}
          ${warn}

          <div class="ing"><b>Aufbewahrung:</b> ${esc(model.rec.storage)}</div>
          ${model.lot?`<div class="ing"><b>${esc(model.lot)}</b></div>`:""}
          <div class="ing"><b>Unternehmer:</b> ${esc(model.oper)}</div>

          <div class="ing" style="margin-top:8px;"><b>Nährwerte je 100 g</b></div>
          <table>
            <tbody>
              <tr><th>Energie</th><td class="right"><b>${Math.round(model.rec.per100g.kj)} kJ</b> / <b>${Math.round(model.rec.per100g.kcal)} kcal</b></td></tr>
              <tr><th>Fett</th><td class="right">${(Math.round(model.rec.per100g.fat*10)/10).toFixed(1)} g</td></tr>
              <tr><th>davon gesättigte Fettsäuren</th><td class="right">${(Math.round(model.rec.per100g.sat*10)/10).toFixed(1)} g</td></tr>
              <tr><th>Kohlenhydrate</th><td class="right">${(Math.round(model.rec.per100g.carb*10)/10).toFixed(1)} g</td></tr>
              <tr><th>davon Zucker</th><td class="right">${(Math.round(model.rec.per100g.sug*10)/10).toFixed(1)} g</td></tr>
              <tr><th>Eiweiß</th><td class="right">${(Math.round(model.rec.per100g.pro*10)/10).toFixed(1)} g</td></tr>
              <tr><th>Salz</th><td class="right">${(model.rec.per100g.salt<0.01 ? (Math.round(model.rec.per100g.salt*1000)/1000).toFixed(3) : (Math.round(model.rec.per100g.salt*100)/100).toFixed(2))} g</td></tr>
            </tbody>
          </table>

          <div class="foot">Eiscafé Sanremo • Bad Berleburg</div>
        </div>
      </div>
    `;

    const area=$("#printArea");
    area.innerHTML=html;
    area.classList.remove("hidden");
    window.print();
    area.classList.add("hidden");
  }

  $("#previewBtn").onclick=()=>renderPreview();
  $("#printBtn").onclick=()=>{
    const model=renderPreview();
    if(model) doPrint(model);
  };

  // init
  renderPreview();
})();
</script>
</body>
</html>
