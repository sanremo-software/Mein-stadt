
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>N√§hrwert & Etikett Generator ‚Äì Eiscaf√© Sanremo</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0b0d12; --card:#121623; --muted:#9aa6bf; --text:#eef2ff;
      --accent:#7c3aed; --accent2:#22c55e; --danger:#ef4444; --warn:#f59e0b;
      --line:rgba(255,255,255,.08); --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px; --radius2:26px; --pad:14px;
      --xl: 1; /* produ√ß√£o XL toggle */
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb; --card:#ffffff; --muted:#53627a; --text:#0f172a;
        --line:rgba(15,23,42,.08); --shadow: 0 10px 26px rgba(2,6,23,.08);
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1100px 700px at 20% -10%, rgba(124,58,237,.35), transparent 60%),
                  radial-gradient(900px 600px at 110% 10%, rgba(34,197,94,.25), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1200px; margin:0 auto; padding:18px}
    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 14px; border:1px solid var(--line); background:rgba(255,255,255,.03);
      border-radius: var(--radius2); box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:46px; height:46px; border-radius:14px;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,197,94,.9));
      display:grid; place-items:center; box-shadow: 0 10px 22px rgba(0,0,0,.25);
      flex:0 0 auto;
    }
    .logo svg{width:24px; height:24px; opacity:.95}
    .title{display:flex; flex-direction:column; line-height:1.15}
    .title b{font-size: calc(16px * var(--xl)); letter-spacing:.2px}
    .title span{color:var(--muted); font-size: calc(12.5px * var(--xl))}
    .head-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      display:flex; gap:8px; align-items:center; padding:10px 12px;
      border:1px solid var(--line); border-radius:999px; background:rgba(255,255,255,.03);
      font-size: calc(12.5px * var(--xl)); color: var(--muted);
    }
    .btn{
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      color:var(--text); padding: 10px 12px;
      border-radius: 14px; cursor:pointer; font-weight:600;
      font-size: calc(13px * var(--xl));
      transition:.15s transform ease, .15s background ease, .15s border-color ease;
      display:inline-flex; gap:8px; align-items:center;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background:rgba(255,255,255,.07)}
    .btn.primary{background:rgba(124,58,237,.18); border-color: rgba(124,58,237,.35)}
    .btn.good{background:rgba(34,197,94,.16); border-color: rgba(34,197,94,.33)}
    .btn.danger{background:rgba(239,68,68,.14); border-color: rgba(239,68,68,.32)}
    .btn.warn{background:rgba(245,158,11,.14); border-color: rgba(245,158,11,.32)}
    .btn:active{transform: translateY(0)}
    .grid{
      display:grid; grid-template-columns: 320px 1fr; gap:16px; margin-top:16px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr} }
    .card{
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding:14px 14px; font-size: calc(14.5px * var(--xl));
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card h2 small{color:var(--muted); font-weight:500}
    .card .body{padding:14px}
    .tabs{
      display:flex; gap:8px; padding:10px; border-bottom:1px solid var(--line);
      flex-wrap:wrap;
    }
    .tab{
      padding:10px 12px; border:1px solid var(--line); border-radius: 999px;
      cursor:pointer; font-weight:700; color:var(--muted);
      font-size: calc(13px * var(--xl));
      background:rgba(255,255,255,.03);
      user-select:none;
    }
    .tab.active{color:var(--text); border-color: rgba(124,58,237,.45); background:rgba(124,58,237,.16)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 680px){ .row{grid-template-columns:1fr} }
    label{display:block; font-size: calc(12.5px * var(--xl)); color:var(--muted); margin:0 0 6px}
    input, select, textarea{
      width:100%; padding: 10px 12px; border-radius: 14px;
      border:1px solid var(--line); background:rgba(0,0,0,.14);
      color:var(--text); outline:none; font-size: calc(13.5px * var(--xl));
    }
    @media (prefers-color-scheme: light){
      input,select,textarea{background: rgba(2,6,23,.03)}
    }
    textarea{min-height: 90px; resize: vertical}
    .help{color:var(--muted); font-size: calc(12px * var(--xl)); line-height:1.35; margin-top:8px}
    .list{
      display:flex; flex-direction:column; gap:10px;
      max-height: 62vh; overflow:auto; padding-right: 4px;
    }
    .item{
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 10px 10px;
      background: rgba(255,255,255,.02);
    }
    .item .top{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .item b{font-size: calc(13.5px * var(--xl))}
    .item .meta{color:var(--muted); font-size: calc(12px * var(--xl)); margin-top:4px}
    .item .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .tag{
      display:inline-flex; gap:6px; align-items:center;
      padding: 6px 10px; border-radius:999px; border:1px solid var(--line);
      color:var(--muted); font-size: calc(11.5px * var(--xl));
      background: rgba(255,255,255,.02);
      margin:6px 6px 0 0;
    }
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 6px 10px; border-radius:999px;
      background: rgba(124,58,237,.16); border: 1px solid rgba(124,58,237,.35);
      font-size: calc(11.5px * var(--xl)); font-weight:800;
    }
    .split{
      display:grid; grid-template-columns: 1.2fr .8fr; gap:14px;
    }
    @media (max-width: 980px){ .split{grid-template-columns:1fr} }
    table{width:100%; border-collapse:collapse}
    th,td{
      border-bottom:1px solid var(--line);
      padding:10px 8px; text-align:left;
      font-size: calc(13px * var(--xl));
      vertical-align:top;
    }
    th{color:var(--muted); font-weight:800}
    .right{text-align:right}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .muted{color:var(--muted)}
    .kpi{
      display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;
      margin-top:10px;
    }
    @media (max-width: 680px){ .kpi{grid-template-columns:1fr} }
    .kpi .box{
      border:1px solid var(--line); border-radius: 18px; padding:12px;
      background: rgba(255,255,255,.02);
    }
    .kpi .box b{display:block; font-size: calc(13px * var(--xl))}
    .kpi .box span{color:var(--muted); font-size: calc(12px * var(--xl))}
    .notice{
      border:1px dashed rgba(245,158,11,.55);
      background: rgba(245,158,11,.10);
      border-radius: 18px;
      padding:12px; margin-top:12px;
      font-size: calc(12.5px * var(--xl)); color: var(--text);
      line-height:1.35;
    }

    /* LABEL PREVIEW */
    .labelWrap{
      border:1px solid var(--line);
      border-radius: 22px;
      background: rgba(255,255,255,.02);
      padding: 14px;
    }
    .label{
      width: 100%;
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 16px;
      background: #fff;
      color:#111827;
      padding: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.15);
    }
    .label .lhead{
      display:flex; justify-content:space-between; gap:10px;
      border-bottom: 1px solid rgba(17,24,39,.10);
      padding-bottom: 10px; margin-bottom: 10px;
    }
    .label .lhead b{font-size: 16px}
    .label .lhead small{color:#374151}
    .label .lsort{font-weight:800; font-size: 15px; margin: 6px 0 10px}
    .label .block{margin: 10px 0}
    .label .block .cap{font-weight:900; font-size: 12px; color:#111827; margin-bottom:4px}
    .label .block p{margin:0; font-size: 12px; line-height:1.25}
    .label .ing strong{font-weight:900; text-decoration: underline;}
    .label .foot{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-top: 10px; padding-top: 10px;
      border-top: 1px solid rgba(17,24,39,.10);
      font-size: 11px; color:#374151;
    }
    .label table{
      width:100%; border-collapse:collapse; margin-top:6px;
      font-size: 11.5px;
    }
    .label th,.label td{
      border-bottom: 1px solid rgba(17,24,39,.10);
      padding: 6px 6px;
    }
    .label th{color:#374151}
    .label .small{font-size: 11px; color:#374151}

    /* PRINT */
    @media print{
      body{background:#fff !important}
      header,.grid,.tabs,.no-print{display:none !important}
      #printArea{display:block !important}
      #printArea .label{box-shadow:none !important}
      #printArea{padding:0; margin:0}
      @page{ margin: 10mm; }
    }
    #printArea{display:none}
    .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .spacer{height:10px}
    .divider{height:1px; background:var(--line); margin:12px 0}
    .tiny{font-size: calc(11.5px * var(--xl)); color:var(--muted)}
    .ok{color:var(--accent2); font-weight:800}
    .warnTxt{color:var(--warn); font-weight:800}
    .dangerTxt{color:var(--danger); font-weight:800}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M7 7c0-2.2 2.2-4 5-4s5 1.8 5 4-2.2 4-5 4-5-1.8-5-4Z" stroke="white" stroke-width="2"/>
          <path d="M9 21h6M10 15l2 6M14 15l-2 6" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="title">
        <b>N√§hrwert & Etikett Generator</b>
        <span>Eiscaf√© Sanremo ¬∑ Zutatenbank ¬∑ Rezept ¬∑ LMIV-Etikett ¬∑ Druck</span>
      </div>
    </div>

    <div class="head-actions">
      <div class="pill">
        <span class="muted">Projekt:</span>
        <b id="projectName" class="mono">Sanremo-Label</b>
      </div>

      <button class="btn" id="btnXL" title="Gro√üe Buttons f√ºr Produktion (Handschuhe)">
        üß§ Produktion XL: <span id="xlState" class="badge">AUS</span>
      </button>

      <button class="btn warn" id="btnBackup" title="Exportiert alle Daten als JSON Datei">
        ‚¨áÔ∏è Backup JSON
      </button>
      <label class="btn" style="cursor:pointer">
        ‚¨ÜÔ∏è Import JSON
        <input id="fileImport" type="file" accept="application/json" style="display:none">
      </label>
      <button class="btn danger" id="btnReset" title="Setzt alles zur√ºck">
        üóëÔ∏è Reset
      </button>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT: DATABASE -->
    <div class="card">
      <h2>
        Zutatenbank
        <small id="ingCount">0</small>
      </h2>
      <div class="body">
        <div class="row">
          <div>
            <label>Suche</label>
            <input id="q" placeholder="z.B. Milch, Zucker, Pistazie, Aroma..." />
          </div>
          <div>
            <label>Kategorie</label>
            <select id="catFilter">
              <option value="">Alle</option>
              <option>Milchprodukte</option>
              <option>Zucker/Carbs</option>
              <option>Fette</option>
              <option>Frucht</option>
              <option>N√ºsse</option>
              <option>Schokolade/Kakao</option>
              <option>Stabilisator/Emulgator</option>
              <option>Aromen/Pasten</option>
              <option>Zusatzstoffe/Farbstoffe</option>
              <option>Sonstiges</option>
            </select>
          </div>
        </div>

        <div class="spacer"></div>

        <button class="btn primary" id="btnNewIng">‚ûï Neue Zutat anlegen</button>

        <div class="divider"></div>

        <div class="list" id="ingList"></div>

        <div class="notice">
          <b>Hinweis (LMIV/Etikett):</b><br>
          Dieses Tool hilft beim Erstellen von Zutatenliste & N√§hrwerttabelle.
          Du musst die Daten der Lieferanten (Spezifikationen) korrekt pflegen.
          F√ºr rechtssichere Etiketten ist der Betreiber verantwortlich (z.B. Zusatzstoffe, Allergene, QUID, Nettof√ºllmenge, MHD, Losnummer).
        </div>
      </div>
    </div>

    <!-- RIGHT: MAIN -->
    <div class="card">
      <div class="tabs">
        <div class="tab active" data-tab="rezept">üç® Rezept</div>
        <div class="tab" data-tab="etikett">üè∑Ô∏è Etikett</div>
        <div class="tab" data-tab="druck">üñ®Ô∏è Druck & Export</div>
        <div class="tab" data-tab="hilfe">‚ÑπÔ∏è Hilfe</div>
      </div>

      <!-- TAB: REZEPT -->
      <div id="tab-rezept" class="body">
        <div class="split">
          <div>
            <div class="row">
              <div>
                <label>Produkt / Verkehrsbezeichnung</label>
                <input id="prodName" placeholder="z.B. Speiseeis / Fruchteis / Sorbet / Milcheis" />
              </div>
              <div>
                <label>Sorte / Geschmack</label>
                <input id="flavor" placeholder="z.B. Stracciatella, Erdbeer, Mango..." />
              </div>
            </div>

            <div class="row">
              <div>
                <label>Rezept-Menge (Gesamt) in g</label>
                <input id="batchG" type="number" min="1" step="1" placeholder="z.B. 10000" />
              </div>
              <div>
                <label>Portionsgr√∂√üe / Becher (optional) in g</label>
                <input id="portionG" type="number" min="0" step="1" placeholder="z.B. 170" />
              </div>
            </div>

            <div class="row">
              <div>
                <label>Produktgruppe</label>
                <select id="productGroup">
                  <option value="Eis">Speiseeis (Milch/Creme)</option>
                  <option value="Sorbet">Sorbet / Fruchteis (ohne Milch)</option>
                  <option value="Dessert">Dessert / Spezial</option>
                </select>
              </div>
              <div>
                <label>Rezept-Notizen (intern)</label>
                <input id="recipeNotes" placeholder="z.B. Stabilizator 4 g/kg, Paste 80 g..." />
              </div>
            </div>

            <div class="divider"></div>

            <div class="flex">
              <button class="btn primary" id="btnAddLine">‚ûï Zutat zum Rezept</button>
              <button class="btn" id="btnAutoSort">‚ÜïÔ∏è Zutaten nach Menge sortieren</button>
              <button class="btn" id="btnClearRecipe">üßπ Rezept leeren</button>
              <span class="tiny">Tipp: Zutat aus der linken Liste ausw√§hlen ‚Üí dann ‚ÄûZutat zum Rezept‚Äú.</span>
            </div>

            <div class="spacer"></div>

            <div class="card" style="box-shadow:none; border-radius:18px">
              <h2 style="border-bottom:1px solid var(--line); border-radius:18px 18px 0 0;">
                Rezept-Positionen <small id="recipeCount">0</small>
              </h2>
              <div class="body" style="padding:0">
                <div style="overflow:auto">
                  <table id="recipeTable">
                    <thead>
                      <tr>
                        <th style="min-width:220px">Zutat</th>
                        <th style="min-width:140px">Menge (g)</th>
                        <th>Hinweis</th>
                        <th class="right">Aktion</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="kpi">
              <div class="box">
                <b>Gesamtgewicht</b>
                <span id="kpiTotal">0 g</span>
              </div>
              <div class="box">
                <b>N√§hrwerte</b>
                <span id="kpiNutrients">berechnen‚Ä¶</span>
              </div>
              <div class="box">
                <b>Allergene / Zusatzstoffe</b>
                <span id="kpiAllergens">pr√ºfen‚Ä¶</span>
              </div>
            </div>

            <div class="notice">
              <b>Wichtig:</b> F√ºr N√§hrwerte brauchst du f√ºr jede Zutat korrekte Werte pro 100 g (vom Lieferanten).
              Wenn etwas fehlt, zeigt das Tool Warnungen.
            </div>
          </div>

          <div>
            <div class="card" style="box-shadow:none; border-radius:18px">
              <h2 style="border-bottom:1px solid var(--line); border-radius:18px 18px 0 0;">
                Berechnung (pro 100 g)
                <small class="mono" id="calcStamp">‚Äì</small>
              </h2>
              <div class="body">
                <div id="calcWarnings" class="notice" style="display:none"></div>

                <table>
                  <tbody id="nutriTable"></tbody>
                </table>

                <div class="divider"></div>

                <div>
                  <label>Zutatenliste (automatisch, absteigend)</label>
                  <textarea id="ingredientsOut" readonly></textarea>
                  <div class="help">
                    Allergene werden <b>fett + unterstrichen</b> dargestellt (LMIV-√ºblich).
                    Du kannst die Reihenfolge automatisch nach Menge sortieren.
                  </div>
                </div>

                <div class="spacer"></div>

                <div>
                  <label>Zusatzstoff-Hinweise (aus Zutaten aggregiert)</label>
                  <textarea id="additivesOut" readonly></textarea>
                  <div class="help">
                    Beispiel: ‚Äûmit Farbstoff‚Äú, ‚Äûmit Konservierungsstoff‚Äú, ‚Äûmit S√º√üungsmittel‚Äú‚Ä¶<br>
                    Bitte pr√ºfe, ob f√ºr dein Produkt zus√§tzliche Pflichtangaben gelten (z.B. Koffein, S√º√üholz, Polyole, Azofarbstoffe, QUID usw.).
                  </div>
                </div>

                <div class="spacer"></div>

                <div>
                  <label>Allergene (aggregiert)</label>
                  <textarea id="allergensOut" readonly></textarea>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: ETIKETT -->
      <div id="tab-etikett" class="body" style="display:none">
        <div class="split">
          <div>
            <div class="row">
              <div>
                <label>Nettof√ºllmenge</label>
                <input id="netQty" placeholder="z.B. 170 g / 750 g / 240 ml" />
              </div>
              <div>
                <label>MHD (Mindestens haltbar bis)</label>
                <input id="mhd" placeholder="TT.MM.JJJJ" />
              </div>
            </div>

            <div class="row">
              <div>
                <label>Losnummer / Charge</label>
                <input id="lot" placeholder="z.B. L241216-01" />
              </div>
              <div>
                <label>Aufbewahrung</label>
                <input id="storage" placeholder="z.B. Tiefgek√ºhlt bei -18¬∞C lagern. Nach dem Auftauen nicht wieder einfrieren." />
              </div>
            </div>

            <div class="row">
              <div>
                <label>Hersteller / Inverkehrbringer</label>
                <input id="maker" placeholder="Eiscaf√© Sanremo" />
              </div>
              <div>
                <label>Kontakt / Adresse</label>
                <input id="contact" placeholder="57319 Bad Berleburg ¬∑ Tel. 0176 72809926 ¬∑ paulo.sanremo@web.de" />
              </div>
            </div>

            <div class="row">
              <div>
                <label>Pflichthinweis (optional)</label>
                <input id="mandatoryNote" placeholder="z.B. Kann Spuren von ... enthalten" />
              </div>
              <div>
                <label>QR-Link (optional)</label>
                <input id="qrLink" placeholder="https://..." />
              </div>
            </div>

            <div class="divider"></div>

            <div class="flex">
              <button class="btn good" id="btnUpdateLabel">‚úÖ Etikett aktualisieren</button>
              <button class="btn" id="btnLoadDemo">‚ú® Demo-Daten laden</button>
            </div>

            <div class="notice">
              <b>LMIV-Check:</b> Je nach Produkt brauchst du evtl. zus√§tzliche Pflichtangaben
              (z.B. QUID bei hervorgehobenen Zutaten, Herkunft, Alkohol, S√º√üungsmittel-Warnhinweise, Azofarbstoffe, etc.).
              Dieses Tool unterst√ºtzt dich, ersetzt aber keine rechtliche Pr√ºfung.
            </div>
          </div>

          <div>
            <div class="labelWrap">
              <div class="flex no-print">
                <span class="badge">Live Vorschau</span>
                <span class="tiny">Druckansicht im Tab ‚ÄûDruck & Export‚Äú</span>
              </div>
              <div class="spacer"></div>
              <div class="label" id="labelPreview"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: DRUCK -->
      <div id="tab-druck" class="body" style="display:none">
        <div class="row">
          <div>
            <label>Etikett-Format</label>
            <select id="labelFormat">
              <option value="standard">Standard (flexibel)</option>
              <option value="100x60">100√ó60 mm</option>
              <option value="80x50">80√ó50 mm</option>
              <option value="70x37">70√ó37 mm</option>
            </select>
            <div class="help">Beim Drucken kannst du im Browser zus√§tzlich Skalierung einstellen.</div>
          </div>
          <div>
            <label>Export</label>
            <div class="flex">
              <button class="btn warn" id="btnExportRecipe">‚¨áÔ∏è Rezept JSON</button>
              <button class="btn warn" id="btnExportLabelText">‚¨áÔ∏è Etikett Text (TXT)</button>
              <button class="btn primary" id="btnPrint">üñ®Ô∏è Drucken</button>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="card" style="box-shadow:none; border-radius:18px">
          <h2 style="border-bottom:1px solid var(--line); border-radius:18px 18px 0 0;">
            Druckvorschau
            <small>Wird genau so gedruckt</small>
          </h2>
          <div class="body">
            <div id="printHint" class="notice">
              Tipp: Browser-Druck ‚Üí ‚ÄûHintergrundgrafiken‚Äú aktivieren (falls verf√ºgbar), und ggf. Skalierung anpassen.
            </div>
            <div class="label" id="labelPrintPreview"></div>
          </div>
        </div>
      </div>

      <!-- TAB: HILFE -->
      <div id="tab-hilfe" class="body" style="display:none">
        <h3 style="margin:0 0 10px">So funktioniert‚Äôs (kurz)</h3>
        <ol style="margin:0; padding-left:18px; line-height:1.5">
          <li><b>Zutatenbank</b>: Links Zutaten anlegen/√§ndern (N√§hrwerte pro 100 g, Allergene, Zusatzstoffe/Farbstoffe).</li>
          <li><b>Rezept</b>: Rechts Zutaten ins Rezept hinzuf√ºgen + Mengen in Gramm.</li>
          <li>Tool berechnet automatisch <b>N√§hrwerte pro 100 g</b>, <b>Zutatenliste</b> (absteigend) und <b>Allergene</b>.</li>
          <li><b>Etikett</b>: Nettof√ºllmenge, MHD, Los, Lagerung, Kontakt erg√§nzen.</li>
          <li><b>Druck</b>: Druckvorschau ‚Üí Drucken oder Text/JSON exportieren.</li>
        </ol>

        <div class="divider"></div>

        <h3 style="margin:0 0 10px">Allergen-Standard (LMIV)</h3>
        <div class="help">
          Du kannst Allergene je Zutat markieren. Im Etikett werden Allergene in der Zutatenliste <b><u>hervorgehoben</u></b>.
          Typische Allergene: Milch, Eier, Gluten, Soja, N√ºsse, Erdn√ºsse, Sellerie, Senf, Sesam, Lupinen, Fisch, Krebstiere, Weichtiere, Schwefeldioxid/Sulfite.
        </div>

        <div class="divider"></div>

        <h3 style="margin:0 0 10px">Zusatzstoffe / Farbstoffe</h3>
        <div class="help">
          Pro Zutat kannst du Zusatzstoff-Hinweise hinterlegen (z.B. <i>‚Äûmit Farbstoff‚Äú</i> oder <i>‚ÄûE100‚Äú</i>).
          Das Tool sammelt das zusammen, aber du musst pr√ºfen, ob spezielle Warnhinweise n√∂tig sind (Azofarbstoffe, S√º√üungsmittel, Polyole usw.).
        </div>

        <div class="divider"></div>

        <button class="btn primary" id="btnSeedSanremo">üç¶ Sanremo-Grunddaten setzen</button>
        <div class="help">Setzt Standardwerte f√ºr Hersteller/Kontakt und ein paar Basis-Zutaten (kannst du danach bearbeiten).</div>
      </div>

    </div>
  </div>
</div>

<!-- PRINT AREA (hidden) -->
<div id="printArea">
  <div class="label" id="labelPrint"></div>
</div>

<!-- MODAL: Ingredient Editor -->
<div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(6px); z-index:50;">
  <div style="max-width:920px; margin:4vh auto; padding:14px;">
    <div class="card">
      <h2>
        Zutat bearbeiten
        <small class="muted">N√§hrwerte pro 100 g ¬∑ Allergene ¬∑ Zusatzstoffe</small>
      </h2>
      <div class="body">
        <div class="row">
          <div>
            <label>Name (Etikett)</label>
            <input id="m_name" placeholder="z.B. Vollmilch, Zucker, Pistazienpaste..." />
          </div>
          <div>
            <label>Kategorie</label>
            <select id="m_cat">
              <option>Milchprodukte</option>
              <option>Zucker/Carbs</option>
              <option>Fette</option>
              <option>Frucht</option>
              <option>N√ºsse</option>
              <option>Schokolade/Kakao</option>
              <option>Stabilisator/Emulgator</option>
              <option>Aromen/Pasten</option>
              <option>Zusatzstoffe/Farbstoffe</option>
              <option>Sonstiges</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Allergene (kommagetrennt)</label>
            <input id="m_allergens" placeholder="z.B. MILCH, SOJA, HASSELNUSS" />
            <div class="help">Gro√ü schreiben ist okay. Im Etikett werden diese W√∂rter markiert.</div>
          </div>
          <div>
            <label>Zusatzstoff-Hinweise (kommagetrennt)</label>
            <input id="m_additives" placeholder="z.B. mit Farbstoff, E160a, mit Emulgator" />
          </div>
        </div>

        <div class="divider"></div>

        <h3 style="margin:0 0 10px">N√§hrwerte pro 100 g (Lieferanten-Daten)</h3>
        <div class="row">
          <div>
            <label>Energie (kJ)</label>
            <input id="m_kj" type="number" min="0" step="0.1" placeholder="0" />
          </div>
          <div>
            <label>Energie (kcal)</label>
            <input id="m_kcal" type="number" min="0" step="0.1" placeholder="0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Fett (g)</label>
            <input id="m_fat" type="number" min="0" step="0.01" placeholder="0" />
          </div>
          <div>
            <label>davon ges√§ttigte Fetts√§uren (g)</label>
            <input id="m_sat" type="number" min="0" step="0.01" placeholder="0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Kohlenhydrate (g)</label>
            <input id="m_carb" type="number" min="0" step="0.01" placeholder="0" />
          </div>
          <div>
            <label>davon Zucker (g)</label>
            <input id="m_sugar" type="number" min="0" step="0.01" placeholder="0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Eiwei√ü (g)</label>
            <input id="m_protein" type="number" min="0" step="0.01" placeholder="0" />
          </div>
          <div>
            <label>Salz (g)</label>
            <input id="m_salt" type="number" min="0" step="0.001" placeholder="0" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="flex" style="justify-content:space-between">
          <div class="flex">
            <button class="btn danger" id="m_delete">üóëÔ∏è L√∂schen</button>
          </div>
          <div class="flex">
            <button class="btn" id="m_cancel">Abbrechen</button>
            <button class="btn good" id="m_save">Speichern</button>
          </div>
        </div>
        <div class="help">
          Tipp: Para ‚Äúp√≥s e pastas‚Äù (ex. Nuss-Paste, Aroma-Paste, Stabilizer, Farbstoff) cria uma Zutat pr√≥pria com valores e os avisos (E-Nummern/‚Äûmit Farbstoff‚Äú).
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const LS_KEY = "sanremo_label_v1";
  const state = {
    xl: false,
    selectedIngId: null,
    ingredients: [],
    recipe: [], // {id, name, grams, note}
    settings: {
      projectName: "Sanremo-Label",
      prodName: "",
      flavor: "",
      batchG: 0,
      portionG: 0,
      productGroup: "Eis",
      recipeNotes: "",
      netQty: "",
      mhd: "",
      lot: "",
      storage: "Tiefgek√ºhlt bei -18¬∞C lagern. Nach dem Auftauen nicht wieder einfrieren.",
      maker: "Eiscaf√© Sanremo",
      contact: "57319 Bad Berleburg ¬∑ Tel. 0176 72809926 ¬∑ paulo.sanremo@web.de",
      mandatoryNote: "",
      qrLink: ""
    }
  };

  const $ = (id) => document.getElementById(id);
  const fmt = (n, d=2) => (isFinite(n) ? (+n).toFixed(d) : "0.00");
  const clamp0 = (x) => Math.max(0, isFinite(x) ? +x : 0);

  function uid(){
    return "ing_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }

  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        const data = JSON.parse(raw);
        Object.assign(state, data);
        // Backward safety
        state.ingredients ||= [];
        state.recipe ||= [];
        state.settings ||= {};
      } else {
        seedMinimal();
      }
    }catch(e){
      seedMinimal();
    }
    applyXL();
    renderAll();
  }

  function save(){
    localStorage.setItem(LS_KEY, JSON.stringify({
      xl: state.xl,
      selectedIngId: state.selectedIngId,
      ingredients: state.ingredients,
      recipe: state.recipe,
      settings: state.settings
    }));
  }

  function seedMinimal(){
    // Minimal defaults ‚Äì user can edit/extend
    state.ingredients = [
      mkIng("Vollmilch 3,5%", "Milchprodukte", ["MILCH"], [], {kj: 268, kcal: 64, fat:3.5, sat:2.3, carb:4.8, sugar:4.8, protein:3.4, salt:0.10}),
      mkIng("Sahne 30%", "Milchprodukte", ["MILCH"], [], {kj: 1255, kcal: 305, fat:30, sat:19, carb:3, sugar:3, protein:2, salt:0.08}),
      mkIng("Zucker", "Zucker/Carbs", [], [], {kj: 1700, kcal: 400, fat:0, sat:0, carb:100, sugar:100, protein:0, salt:0}),
      mkIng("Dextrose", "Zucker/Carbs", [], [], {kj: 1570, kcal: 370, fat:0, sat:0, carb:92, sugar:92, protein:0, salt:0}),
      mkIng("Glukosepulver", "Zucker/Carbs", [], [], {kj: 1600, kcal: 380, fat:0, sat:0, carb:95, sugar:95, protein:0, salt:0}),
      mkIng("Magermilchpulver", "Milchprodukte", ["MILCH"], [], {kj: 1500, kcal: 360, fat:1, sat:0.7, carb:52, sugar:52, protein:35, salt:1.2}),
      mkIng("Stabilisator/Emulgator (Mix)", "Stabilisator/Emulgator", [], ["mit Emulgator"], {kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0})
    ];
    state.selectedIngId = state.ingredients[0]?.id || null;
    save();
  }

  function mkIng(name, cat, allergens=[], additives=[], n){
    return {
      id: uid(),
      name,
      cat,
      allergens, // array strings
      additives, // array strings
      nutri: {
        kj: clamp0(n?.kj), kcal: clamp0(n?.kcal),
        fat: clamp0(n?.fat), sat: clamp0(n?.sat),
        carb: clamp0(n?.carb), sugar: clamp0(n?.sugar),
        protein: clamp0(n?.protein), salt: clamp0(n?.salt)
      }
    };
  }

  // UI: Tabs
  document.querySelectorAll(".tab").forEach(t => {
    t.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      const key = t.dataset.tab;
      ["rezept","etikett","druck","hilfe"].forEach(k => {
        $("tab-"+k).style.display = (k === key) ? "" : "none";
      });
      if(key === "etikett" || key === "druck"){ updateLabel(); }
      if(key === "druck"){ renderPrintPreview(); }
    });
  });

  // XL toggle
  $("btnXL").addEventListener("click", () => {
    state.xl = !state.xl;
    applyXL();
    save();
  });

  function applyXL(){
    document.documentElement.style.setProperty("--xl", state.xl ? 1.18 : 1);
    $("xlState").textContent = state.xl ? "AN" : "AUS";
  }

  // Settings bind
  const bind = (id, key, parseFn=null) => {
    const el = $(id);
    el.value = state.settings[key] ?? "";
    el.addEventListener("input", () => {
      state.settings[key] = parseFn ? parseFn(el.value) : el.value;
      if(["prodName","flavor","batchG","portionG","productGroup","recipeNotes"].includes(key)){
        recalc();
      }
      if(["netQty","mhd","lot","storage","maker","contact","mandatoryNote","qrLink","prodName","flavor"].includes(key)){
        updateLabel();
      }
      save();
    });
  };

  bind("prodName","prodName");
  bind("flavor","flavor");
  bind("batchG","batchG", v => clamp0(+v));
  bind("portionG","portionG", v => clamp0(+v));
  bind("productGroup","productGroup");
  bind("recipeNotes","recipeNotes");

  bind("netQty","netQty");
  bind("mhd","mhd");
  bind("lot","lot");
  bind("storage","storage");
  bind("maker","maker");
  bind("contact","contact");
  bind("mandatoryNote","mandatoryNote");
  bind("qrLink","qrLink");

  $("projectName").textContent = state.settings.projectName || "Sanremo-Label";

  // Ingredient list
  $("q").addEventListener("input", renderIngList);
  $("catFilter").addEventListener("change", renderIngList);

  function renderIngList(){
    const q = $("q").value.trim().toLowerCase();
    const cat = $("catFilter").value;
    const list = $("ingList");
    list.innerHTML = "";

    const filtered = state.ingredients
      .filter(i => !cat || i.cat === cat)
      .filter(i => !q || (i.name||"").toLowerCase().includes(q));

    $("ingCount").textContent = filtered.length + " / " + state.ingredients.length;

    filtered.forEach(i => {
      const div = document.createElement("div");
      div.className = "item";
      div.style.outline = (state.selectedIngId === i.id) ? "2px solid rgba(124,58,237,.55)" : "none";
      div.innerHTML = `
        <div class="top">
          <div style="min-width:0">
            <b>${escapeHtml(i.name)}</b>
            <div class="meta">${escapeHtml(i.cat)} ¬∑ ${i.allergens?.length ? "Allergene: " + escapeHtml(i.allergens.join(", ")) : "keine Allergene"} </div>
            <div class="meta">${i.additives?.length ? "Zusatzstoffe: " + escapeHtml(i.additives.join(", ")) : ""}</div>
            <div>
              ${i.allergens?.map(a => `<span class="tag">‚ö†Ô∏è ${escapeHtml(a)}</span>`).join("") || ""}
              ${i.additives?.map(a => `<span class="tag">üß™ ${escapeHtml(a)}</span>`).join("") || ""}
            </div>
          </div>
          <div class="actions">
            <button class="btn" data-sel="${i.id}">Ausw√§hlen</button>
            <button class="btn primary" data-edit="${i.id}">Bearbeiten</button>
          </div>
        </div>
      `;
      div.querySelector("[data-sel]").addEventListener("click", () => {
        state.selectedIngId = i.id;
        save();
        renderIngList();
      });
      div.querySelector("[data-edit]").addEventListener("click", () => openModal(i.id));
      list.appendChild(div);
    });
  }

  // New ingredient
  $("btnNewIng").addEventListener("click", () => openModal(null));

  // Modal
  let modalId = null;

  function openModal(id){
    modalId = id;
    const ing = id ? state.ingredients.find(x => x.id === id) : mkIng("", "Sonstiges", [], [], {kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0});
    $("m_name").value = ing.name || "";
    $("m_cat").value = ing.cat || "Sonstiges";
    $("m_allergens").value = (ing.allergens || []).join(", ");
    $("m_additives").value = (ing.additives || []).join(", ");

    $("m_kj").value = ing.nutri?.kj ?? 0;
    $("m_kcal").value = ing.nutri?.kcal ?? 0;
    $("m_fat").value = ing.nutri?.fat ?? 0;
    $("m_sat").value = ing.nutri?.sat ?? 0;
    $("m_carb").value = ing.nutri?.carb ?? 0;
    $("m_sugar").value = ing.nutri?.sugar ?? 0;
    $("m_protein").value = ing.nutri?.protein ?? 0;
    $("m_salt").value = ing.nutri?.salt ?? 0;

    $("m_delete").style.display = id ? "" : "none";
    $("modal").style.display = "";
  }

  $("m_cancel").addEventListener("click", () => $("modal").style.display = "none");
  $("m_save").addEventListener("click", () => {
    const name = $("m_name").value.trim();
    if(!name){ alert("Bitte Zutat-Name eingeben."); return; }

    const ingData = {
      id: modalId || uid(),
      name,
      cat: $("m_cat").value,
      allergens: parseCsv($("m_allergens").value),
      additives: parseCsv($("m_additives").value),
      nutri: {
        kj: clamp0(+$("m_kj").value),
        kcal: clamp0(+$("m_kcal").value),
        fat: clamp0(+$("m_fat").value),
        sat: clamp0(+$("m_sat").value),
        carb: clamp0(+$("m_carb").value),
        sugar: clamp0(+$("m_sugar").value),
        protein: clamp0(+$("m_protein").value),
        salt: clamp0(+$("m_salt").value)
      }
    };

    if(modalId){
      const idx = state.ingredients.findIndex(x => x.id === modalId);
      if(idx >= 0) state.ingredients[idx] = ingData;
    }else{
      state.ingredients.unshift(ingData);
      state.selectedIngId = ingData.id;
    }

    // Keep recipe names synced if edited
    state.recipe.forEach(r => {
      if(r.id === ingData.id) r.name = ingData.name;
    });

    $("modal").style.display = "none";
    save();
    renderIngList();
    renderRecipe();
    recalc();
    updateLabel();
  });

  $("m_delete").addEventListener("click", () => {
    if(!modalId) return;
    if(!confirm("Diese Zutat wirklich l√∂schen? (Rezeptpositionen werden ebenfalls entfernt)")) return;
    state.ingredients = state.ingredients.filter(x => x.id !== modalId);
    state.recipe = state.recipe.filter(r => r.id !== modalId);
    if(state.selectedIngId === modalId) state.selectedIngId = state.ingredients[0]?.id || null;
    modalId = null;
    $("modal").style.display = "none";
    save();
    renderAll();
  });

  function parseCsv(s){
    return (s||"")
      .split(",")
      .map(x => x.trim())
      .filter(Boolean);
  }

  // Recipe
  $("btnAddLine").addEventListener("click", () => {
    const id = state.selectedIngId;
    if(!id){ alert("Bitte zuerst eine Zutat ausw√§hlen."); return; }
    const ing = state.ingredients.find(x => x.id === id);
    if(!ing){ alert("Zutat nicht gefunden."); return; }
    state.recipe.push({ id: ing.id, name: ing.name, grams: 0, note: "" });
    save();
    renderRecipe();
    recalc();
  });

  $("btnClearRecipe").addEventListener("click", () => {
    if(!confirm("Rezept wirklich leeren?")) return;
    state.recipe = [];
    save();
    renderRecipe();
    recalc();
    updateLabel();
  });

  $("btnAutoSort").addEventListener("click", () => {
    state.recipe.sort((a,b) => (clamp0(b.grams) - clamp0(a.grams)));
    save();
    renderRecipe();
    recalc();
    updateLabel();
  });

  function renderRecipe(){
    const tb = $("recipeTable").querySelector("tbody");
    tb.innerHTML = "";
    $("recipeCount").textContent = state.recipe.length;

    state.recipe.forEach((r, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHtml(r.name)}</b></td>
        <td>
          <input data-g="${idx}" type="number" min="0" step="1" value="${clamp0(r.grams)}" />
        </td>
        <td>
          <input data-n="${idx}" placeholder="optional (intern)" value="${escapeAttr(r.note||"")}" />
        </td>
        <td class="right">
          <button class="btn danger" data-del="${idx}">Entfernen</button>
        </td>
      `;
      tr.querySelector("[data-g]").addEventListener("input", (e) => {
        state.recipe[idx].grams = clamp0(+e.target.value);
        save();
        recalc();
        updateLabel();
      });
      tr.querySelector("[data-n]").addEventListener("input", (e) => {
        state.recipe[idx].note = e.target.value;
        save();
      });
      tr.querySelector("[data-del]").addEventListener("click", () => {
        state.recipe.splice(idx,1);
        save();
        renderRecipe();
        recalc();
        updateLabel();
      });
      tb.appendChild(tr);
    });
  }

  // Calculation
  function recalc(){
    const total = state.recipe.reduce((s,r) => s + clamp0(r.grams), 0);
    $("kpiTotal").textContent = total ? (fmt(total,0) + " g") : "0 g";
    $("calcStamp").textContent = new Date().toLocaleString("de-DE");

    const warnings = [];
    if(total <= 0) warnings.push("Keine Rezeptmengen eingetragen.");

    // Weighted nutrients
    const sum = {kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0};
    const missing = [];
    const allergens = new Set();
    const additives = new Set();

    state.recipe.forEach(r => {
      const g = clamp0(r.grams);
      if(g <= 0) return;
      const ing = state.ingredients.find(x => x.id === r.id);
      if(!ing){ missing.push(r.name); return; }
      const n = ing.nutri || {};
      // detect missing: all zeros is ok for some additives, but warn if kcal/kj missing while others exist
      const hasAny = ["kj","kcal","fat","sat","carb","sugar","protein","salt"].some(k => clamp0(n[k])>0);
      const maybeMissingEnergy = (clamp0(n.kj)===0 && clamp0(n.kcal)===0 && hasAny===false && ing.cat!=="Zusatzstoffe/Farbstoffe" && ing.cat!=="Stabilisator/Emulgator");
      if(maybeMissingEnergy) missing.push(ing.name);

      for(const k of Object.keys(sum)){
        sum[k] += (clamp0(n[k]) * g / 100);
      }
      (ing.allergens||[]).forEach(a => allergens.add(normAllergen(a)));
      (ing.additives||[]).forEach(a => additives.add(a.trim()));
    });

    if(missing.length){
      warnings.push("N√§hrwerte fehlen (oder sind 0) bei: " + [...new Set(missing)].slice(0,8).join(", ") + (missing.length>8 ? "‚Ä¶" : ""));
    }
    if(state.settings.batchG && total && Math.abs(total - state.settings.batchG) > 1){
      warnings.push(`Gesamtgewicht (${fmt(total,0)} g) ‚â† Rezept-Menge Feld (${fmt(state.settings.batchG,0)} g).`);
    }

    // per 100g
    const per100 = {};
    for(const k of Object.keys(sum)){
      per100[k] = total>0 ? (sum[k] / total * 100) : 0;
    }

    // Render nutrition table
    const rows = [
      ["Energie", `${fmt(per100.kj,0)} kJ / ${fmt(per100.kcal,0)} kcal`],
      ["Fett", `${fmt(per100.fat,1)} g`],
      ["davon ges√§ttigte Fetts√§uren", `${fmt(per100.sat,1)} g`],
      ["Kohlenhydrate", `${fmt(per100.carb,1)} g`],
      ["davon Zucker", `${fmt(per100.sugar,1)} g`],
      ["Eiwei√ü", `${fmt(per100.protein,1)} g`],
      ["Salz", `${fmt(per100.salt,2)} g`],
    ];

    $("nutriTable").innerHTML = rows.map(([k,v]) => `
      <tr><th>${escapeHtml(k)}</th><td class="right"><b>${escapeHtml(v)}</b></td></tr>
    `).join("");

    // Ingredients list descending
    const sorted = [...state.recipe].filter(r => clamp0(r.grams)>0).sort((a,b)=>clamp0(b.grams)-clamp0(a.grams));
    const ingText = sorted.map(r => highlightAllergens(r.name, allergens)).join(", ");
    $("ingredientsOut").value = ingText || "";

    // Additives
    $("additivesOut").value = [...additives].filter(Boolean).join(", ");
    $("allergensOut").value = [...allergens].filter(Boolean).join(", ") || "";

    // KPI
    $("kpiNutrients").textContent = total>0 ? "ok (pro 100 g)" : "‚Äì";
    $("kpiAllergens").textContent = (allergens.size || additives.size) ? `${allergens.size} Allergene ¬∑ ${additives.size} Hinweise` : "‚Äì";

    // warnings UI
    if(warnings.length){
      $("calcWarnings").style.display = "";
      $("calcWarnings").innerHTML = "<b>Warnungen:</b><br>" + warnings.map(w => "‚Ä¢ " + escapeHtml(w)).join("<br>");
    }else{
      $("calcWarnings").style.display = "none";
      $("calcWarnings").innerHTML = "";
    }

    // Persist computed for label
    state._computed = { total, per100, ingredientsHTML: ingText, allergens: [...allergens], additives: [...additives] };
  }

  function normAllergen(a){
    const x = (a||"").trim();
    if(!x) return "";
    // normalize common
    return x.toUpperCase();
  }

  function highlightAllergens(text, allergenSet){
    // in output textarea we keep as plain; but for label HTML we apply strong/underline later.
    // here keep original
    return text;
  }

  function escapeHtml(s){
    return (s??"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

  // Label builder
  $("btnUpdateLabel").addEventListener("click", () => updateLabel());
  $("btnPrint").addEventListener("click", () => {
    renderPrintPreview(true);
    window.print();
  });

  $("labelFormat").addEventListener("change", () => renderPrintPreview());

  function buildLabelHTML(){
    const c = state._computed || {per100:{}, allergens:[], additives:[]};
    const s = state.settings;

    const sortLine = [
      (s.prodName||"").trim(),
      (s.flavor||"").trim() ? "‚Äì " + (s.flavor||"").trim() : ""
    ].join(" ").trim();

    const ingredients = buildIngredientsLabelHTML();
    const additivesLine = (c.additives||[]).filter(Boolean).join(", ");
    const allergensLine = (c.allergens||[]).filter(Boolean).join(", ");

    const mandatory = (s.mandatoryNote||"").trim();
    const qr = (s.qrLink||"").trim();

    const n = c.per100 || {};
    const nutriRows = [
      ["Energie", `${fmt(n.kj,0)} kJ / ${fmt(n.kcal,0)} kcal`],
      ["Fett", `${fmt(n.fat,1)} g`],
      ["davon ges√§ttigte Fetts√§uren", `${fmt(n.sat,1)} g`],
      ["Kohlenhydrate", `${fmt(n.carb,1)} g`],
      ["davon Zucker", `${fmt(n.sugar,1)} g`],
      ["Eiwei√ü", `${fmt(n.protein,1)} g`],
      ["Salz", `${fmt(n.salt,2)} g`],
    ];

    return `
      <div class="lhead">
        <div>
          <b>${escapeHtml(s.maker || "Hersteller")}</b><br>
          <small>${escapeHtml(s.contact || "")}</small>
        </div>
        <div style="text-align:right">
          <small class="mono">${escapeHtml(s.lot || "")}</small><br>
          <small>${escapeHtml(s.netQty || "")}</small>
        </div>
      </div>

      <div class="lsort">${escapeHtml(sortLine || "Produkt")}</div>

      <div class="block">
        <div class="cap">Zutaten:</div>
        <p class="ing">${ingredients || "<span class='small'>(keine Rezeptdaten)</span>"}</p>
      </div>

      ${additivesLine ? `
      <div class="block">
        <div class="cap">Hinweise:</div>
        <p>${escapeHtml(additivesLine)}</p>
      </div>` : ""}

      ${allergensLine ? `
      <div class="block">
        <div class="cap">Allergene:</div>
        <p>${escapeHtml(allergensLine)}</p>
      </div>` : ""}

      <div class="block">
        <div class="cap">N√§hrwerte je 100 g:</div>
        <table>
          <thead>
            <tr><th>Angabe</th><th class="right">Wert</th></tr>
          </thead>
          <tbody>
            ${nutriRows.map(r => `<tr><td>${escapeHtml(r[0])}</td><td class="right"><b>${escapeHtml(r[1])}</b></td></tr>`).join("")}
          </tbody>
        </table>
      </div>

      <div class="block">
        <div class="cap">Aufbewahrung:</div>
        <p>${escapeHtml(s.storage || "")}</p>
      </div>

      <div class="foot">
        <div>
          ${s.mhd ? `<div><b>MHD:</b> ${escapeHtml(s.mhd)}</div>` : ""}
          ${mandatory ? `<div><b>Hinweis:</b> ${escapeHtml(mandatory)}</div>` : ""}
        </div>
        <div style="text-align:right">
          ${qr ? `<div class="mono">QR: ${escapeHtml(qr)}</div>` : ""}
          <div class="small">Erstellt mit Sanremo-Generator (intern)</div>
        </div>
      </div>
    `;
  }

  function buildIngredientsLabelHTML(){
    // Use recipe names with allergen highlighting by keyword matches
    const c = state._computed || {};
    const allergens = (c.allergens||[]).map(a => a.toUpperCase());

    const sorted = [...state.recipe]
      .filter(r => clamp0(r.grams)>0)
      .sort((a,b)=>clamp0(b.grams)-clamp0(a.grams));

    if(!sorted.length) return "";

    // Build string: each ingredient name, but if it contains allergen keyword, highlight that part.
    const out = sorted.map(r => {
      const ing = state.ingredients.find(x => x.id === r.id);
      const name = (ing?.name || r.name || "").toString();
      return markAllergensInText(name, allergens);
    }).join(", ");

    return out;
  }

  function markAllergensInText(text, allergensUpper){
    // simple word highlight: for each allergen, replace case-insensitive occurrences
    let html = escapeHtml(text);
    allergensUpper.forEach(al => {
      if(!al) return;
      // Replace any occurrence ignoring case
      const re = new RegExp(al.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), "gi");
      html = html.replace(re, (m) => `<strong>${escapeHtml(m)}</strong>`);
    });
    return html;
  }

  function updateLabel(){
    recalc();
    const html = buildLabelHTML();
    $("labelPreview").innerHTML = html;
    $("labelPrintPreview").innerHTML = html;
    save();
  }

  function renderPrintPreview(forPrint=false){
    updateLabel();
    const format = $("labelFormat").value;
    const el = forPrint ? $("labelPrint") : $("labelPrintPreview");
    el.innerHTML = buildLabelHTML();

    // Apply sizes
    const style = el.style;
    style.width = "";
    style.height = "";
    style.maxWidth = "620px";
    style.margin = "0 auto";
    if(format === "100x60"){
      style.width = "100mm"; style.minHeight = "60mm"; style.maxWidth = "100mm";
    } else if(format === "80x50"){
      style.width = "80mm"; style.minHeight = "50mm"; style.maxWidth = "80mm";
    } else if(format === "70x37"){
      style.width = "70mm"; style.minHeight = "37mm"; style.maxWidth = "70mm";
    }
    $("printArea").style.display = forPrint ? "block" : "none";
  }

  // Demo
  $("btnLoadDemo").addEventListener("click", () => {
    state.settings.prodName = "Speiseeis";
    state.settings.flavor = "Stracciatella";
    state.settings.netQty = "170 g";
    state.settings.mhd = "31.12.2026";
    state.settings.lot = "L" + new Date().toISOString().slice(2,10).replaceAll("-","");
    $("prodName").value = state.settings.prodName;
    $("flavor").value = state.settings.flavor;
    $("netQty").value = state.settings.netQty;
    $("mhd").value = state.settings.mhd;
    $("lot").value = state.settings.lot;

    // Recipe demo
    const milk = state.ingredients.find(x => x.name.toLowerCase().includes("vollmilch"))?.id;
    const sugar = state.ingredients.find(x => x.name.toLowerCase() === "zucker")?.id;
    const dext = state.ingredients.find(x => x.name.toLowerCase().includes("dextrose"))?.id;
    const cream = state.ingredients.find(x => x.name.toLowerCase().includes("sahne"))?.id;

    state.recipe = [];
    if(milk) state.recipe.push({id:milk, name:getIng(milk).name, grams: 6500, note:""});
    if(cream) state.recipe.push({id:cream, name:getIng(cream).name, grams: 800, note:""});
    if(sugar) state.recipe.push({id:sugar, name:getIng(sugar).name, grams: 1200, note:""});
    if(dext) state.recipe.push({id:dext, name:getIng(dext).name, grams: 700, note:""});

    state.settings.batchG = state.recipe.reduce((s,r)=>s+clamp0(r.grams),0);
    $("batchG").value = state.settings.batchG;

    save();
    renderRecipe();
    recalc();
    updateLabel();
    alert("Demo geladen. Passe Zutaten/Rezept an deine echten Daten an.");
  });

  function getIng(id){ return state.ingredients.find(x=>x.id===id); }

  // Exports / backup
  $("btnBackup").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify({
      meta: {tool:"Sanremo-Label", version:"1.0", exportedAt: new Date().toISOString()},
      ...JSON.parse(localStorage.getItem(LS_KEY) || "{}")
    }, null, 2)], {type:"application/json"});
    downloadBlob(blob, `sanremo_backup_${dateStamp()}.json`);
  });

  $("fileImport").addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if(!f) return;
    try{
      const txt = await f.text();
      const data = JSON.parse(txt);
      // accept both raw or wrapped
      const payload = data.ingredients ? data : (data?.ingredients ? data : data);
      if(!payload.ingredients || !payload.settings) throw new Error("Ung√ºltiges Backup.");
      state.xl = !!payload.xl;
      state.selectedIngId = payload.selectedIngId || null;
      state.ingredients = payload.ingredients || [];
      state.recipe = payload.recipe || [];
      state.settings = payload.settings || state.settings;
      save();
      applyXL();
      renderAll();
      alert("Import erfolgreich.");
    }catch(err){
      alert("Import fehlgeschlagen: " + err.message);
    }finally{
      e.target.value = "";
    }
  });

  $("btnReset").addEventListener("click", () => {
    if(!confirm("Alles wirklich zur√ºcksetzen?")) return;
    localStorage.removeItem(LS_KEY);
    location.reload();
  });

  $("btnExportRecipe").addEventListener("click", () => {
    recalc();
    const blob = new Blob([JSON.stringify({
      recipe: state.recipe,
      totalG: state._computed?.total || 0,
      settings: pick(state.settings, ["prodName","flavor","batchG","portionG","productGroup","recipeNotes"])
    }, null, 2)], {type:"application/json"});
    downloadBlob(blob, `rezept_${safeFile(state.settings.flavor || "produkt")}_${dateStamp()}.json`);
  });

  $("btnExportLabelText").addEventListener("click", () => {
    recalc();
    const c = state._computed || {};
    const s = state.settings;
    const lines = [];
    lines.push(`${s.maker || ""}`.trim());
    lines.push(`${(s.prodName||"").trim()} ${(s.flavor||"").trim() ? "‚Äì "+(s.flavor||"").trim() : ""}`.trim());
    lines.push(`Nettof√ºllmenge: ${s.netQty||""}`);
    if(s.mhd) lines.push(`MHD: ${s.mhd}`);
    if(s.lot) lines.push(`Los: ${s.lot}`);
    lines.push(`Zutaten: ${stripHtml(buildIngredientsLabelHTML())}`);
    if((c.additives||[]).length) lines.push(`Hinweise: ${(c.additives||[]).join(", ")}`);
    if((c.allergens||[]).length) lines.push(`Allergene: ${(c.allergens||[]).join(", ")}`);
    lines.push(`N√§hrwerte je 100 g: Energie ${fmt(c.per100?.kj||0,0)} kJ / ${fmt(c.per100?.kcal||0,0)} kcal; Fett ${fmt(c.per100?.fat||0,1)} g, davon ges√§ttigte Fetts√§uren ${fmt(c.per100?.sat||0,1)} g; Kohlenhydrate ${fmt(c.per100?.carb||0,1)} g, davon Zucker ${fmt(c.per100?.sugar||0,1)} g; Eiwei√ü ${fmt(c.per100?.protein||0,1)} g; Salz ${fmt(c.per100?.salt||0,2)} g.`);
    if(s.storage) lines.push(`Aufbewahrung: ${s.storage}`);
    if(s.mandatoryNote) lines.push(`Hinweis: ${s.mandatoryNote}`);
    lines.push(`${s.contact || ""}`.trim());
    if(s.qrLink) lines.push(`QR: ${s.qrLink}`);

    const blob = new Blob([lines.filter(Boolean).join("\n")], {type:"text/plain"});
    downloadBlob(blob, `etikett_${safeFile(s.flavor || "produkt")}_${dateStamp()}.txt`);
  });

  $("btnSeedSanremo").addEventListener("click", () => {
    state.settings.maker = "Eiscaf√© Sanremo";
    state.settings.contact = "57319 Bad Berleburg ¬∑ Tel. 0176 72809926 ¬∑ paulo.sanremo@web.de";
    $("maker").value = state.settings.maker;
    $("contact").value = state.settings.contact;
    save();
    updateLabel();
    alert("Sanremo-Grunddaten gesetzt.");
  });

  function pick(obj, keys){
    const o = {};
    keys.forEach(k => o[k] = obj[k]);
    return o;
  }

  function downloadBlob(blob, filename){
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 300);
  }
  function dateStamp(){
    const d = new Date();
    const p = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`;
  }
  function safeFile(s){
    return (s||"").toString().trim().toLowerCase()
      .replaceAll("√§","ae").replaceAll("√∂","oe").replaceAll("√º","ue").replaceAll("√ü","ss")
      .replace(/[^a-z0-9_-]+/g,"_").replace(/_+/g,"_").replace(/^_+|_+$/g,"") || "produkt";
  }
  function stripHtml(html){
    const div = document.createElement("div");
    div.innerHTML = html;
    return div.textContent || div.innerText || "";
  }

  function renderAll(){
    renderIngList();
    renderRecipe();
    recalc();
    updateLabel();
  }

  // INIT
  load();
})();
</script>
</body>
  </html>
